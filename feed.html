<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/fonts/IBMPlexSansVar-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/IBMPlexSansVar-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link rel="preload" as="style" data-href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&amp;display=swap"/><link rel="stylesheet" data-href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&amp;display=swap"/><noscript><link rel="stylesheet" data-href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&amp;display=swap"/></noscript><link rel="icon" href="/favicon.svg" type="image/svg+xml"/><link rel="icon" href="/favicon.ico"/><link rel="apple-touch-icon" sizes="192x192" href="/apple-touch-icon.png"/><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/feed"/><meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)"/><meta name="theme-color" content="#18181B" media="(prefers-color-scheme: dark)"/><link rel="preload" href="/_next/static/css/b2d4b88ef5f459ad.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b2d4b88ef5f459ad.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-be3dc048187ccb46.js" defer=""></script><script src="/_next/static/chunks/main-e557dee8cfeafd6c.js" defer=""></script><script src="/_next/static/chunks/pages/_app-4689b47e8eb5accb.js" defer=""></script><script src="/_next/static/chunks/pages/feed-84a6db662c30a404.js" defer=""></script><script src="/_next/static/qyqiiXSdt0MRRn7fi4Dl1/_buildManifest.js" defer=""></script><script src="/_next/static/qyqiiXSdt0MRRn7fi4Dl1/_ssgManifest.js" defer=""></script><script src="/_next/static/qyqiiXSdt0MRRn7fi4Dl1/_middlewareManifest.js" defer=""></script><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap"/></head><body class="bg-day dark:bg-night"><div id="__next" data-reactroot="">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;feed xmlns=&quot;http://www.w3.org/2005/Atom&quot;&gt;
    &lt;id&gt;https://next.emergencyexit.xyz//&lt;/id&gt;
    &lt;title&gt;布鲁斯鱼的妙想天开&lt;/title&gt;
    &lt;updated&gt;2022-10-18T10:07:05.450Z&lt;/updated&gt;
    &lt;generator&gt;https://github.com/jpmonette/feed&lt;/generator&gt;
    &lt;author&gt;
        &lt;name&gt;bluesyu&lt;/name&gt;
        &lt;email&gt;bluesedenyu@gmail.com&lt;/email&gt;
        &lt;uri&gt;https://next.emergencyexit.xyz/&lt;/uri&gt;
    &lt;/author&gt;
    &lt;link rel=&quot;alternate&quot; href=&quot;https://next.emergencyexit.xyz//&quot;/&gt;
    &lt;subtitle&gt;此间的博文大抵有两类，一种是水的，另一种仍是水的罢。 —— 鲁迅&lt;/subtitle&gt;
    &lt;icon&gt;https://next.emergencyexit.xyz//favicon.svg&lt;/icon&gt;
    &lt;rights&gt;All rights reserved 2022, bluesyu&lt;/rights&gt;
    &lt;entry&gt;
        &lt;title type=&quot;html&quot;&gt;&lt;![CDATA[WTF Go: Constants]]&gt;&lt;/title&gt;
        &lt;id&gt;https://next.emergencyexit.xyz//wtf-go-constants&lt;/id&gt;
        &lt;link href=&quot;https://next.emergencyexit.xyz//wtf-go-constants&quot;/&gt;
        &lt;updated&gt;2022-10-11T00:00:00.000Z&lt;/updated&gt;
        &lt;summary type=&quot;html&quot;&gt;&lt;![CDATA[ WTF Go: 初看反直觉，仔细研究却大有设计]]&gt;&lt;/summary&gt;
        &lt;content type=&quot;html&quot;&gt;&lt;![CDATA[&lt;main class=&quot;notion light-mode notion-page notion-block-f6ba5dfd50004e1580b47d3456bc676a&quot;&gt;&lt;div class=&quot;notion-viewport&quot;&gt;&lt;/div&gt;&lt;pre class=&quot;notion-code language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;token string&quot;&gt;&quot;time&quot;&lt;/span&gt;
	&lt;span class=&quot;token string&quot;&gt;&quot;math/rand&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// invalid operation: rand.Intn(10) * 1000 * time.Millisecond (mismatched types int and time.Duration)&lt;/span&gt;
time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Sleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;rand&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Intn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Millisecond&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ❌

&lt;span class=&quot;token comment&quot;&gt;// 🤔 make sense.&lt;/span&gt;
time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Sleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Duration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;rand&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Intn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Millisecond&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ✅

&lt;span class=&quot;token comment&quot;&gt;// wtf ?!&lt;/span&gt;
time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Sleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Millisecond&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ✅ 
&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-c39aa2c506de4a38884207f6cc0666f4&quot;&gt;看看上面这个简单的例子：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-94339645b11c4208ac1de17ef66e21d6&quot;&gt;&lt;li&gt;第一个错误很容易理解： 整型不能和 &lt;code class=&quot;notion-inline-code&quot;&gt;time.Duration&lt;/code&gt; 相乘&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-90a7e274dd4740ac97bd29e4c8b56822&quot;&gt;&lt;li&gt;第二个例子修正了这一问题，符合预期&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-f1ecf287e16c4698bfa18a71b4789179&quot;&gt;&lt;li&gt;第三个例子带来了疑问，为什么 &lt;code class=&quot;notion-inline-code&quot;&gt;1000 * time.Millisecond&lt;/code&gt; 却没有问题？明明 &lt;code class=&quot;notion-inline-code&quot;&gt;1000&lt;/code&gt; 也是个整型？编译器戴了有色眼镜？&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-text notion-block-2aa15d50137b414bb6ed5569ce63f326&quot;&gt;别慌，仔细看看 &lt;code class=&quot;notion-inline-code&quot;&gt;rand.Intn(10) * 1000&lt;/code&gt; 和 &lt;code class=&quot;notion-inline-code&quot;&gt;1000&lt;/code&gt; 的区别在于：前者是变量，类型已经确定了，通不过编译是情理之中；而后者是常量，类型并不是 &lt;code class=&quot;notion-inline-code&quot;&gt;int&lt;/code&gt; ，属于 &lt;code class=&quot;notion-inline-code&quot;&gt;untyped constants&lt;/code&gt; ，编译器会尝试将它转换成 &lt;code class=&quot;notion-inline-code&quot;&gt;time.Duration&lt;/code&gt; 。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-4b6e7022ba1c41dc9dec86be35016e6a&quot;&gt;这就勾起了我的好奇心，那如果我写个一个 &lt;code class=&quot;notion-inline-code&quot;&gt;float&lt;/code&gt; 常量会怎样呢？&lt;/div&gt;&lt;pre class=&quot;notion-code language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// (untyped float constant) truncated to int64&lt;/span&gt;
time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Sleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1000.1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Millisecond&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ❌&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-5581a723f1c9437da180b271dde64dfb&quot;&gt;果然是不行的。那么究竟这个无类型常量的类型转换是依照什么规则进行的呢？&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-fda4059895d742c18a5c11fcd2834e98&quot;&gt;首先每一种常量的&lt;b&gt;写法&lt;/b&gt;都会对应着一种默认类型：&lt;/div&gt;&lt;figure class=&quot;notion-asset-wrapper notion-asset-wrapper-image notion-block-bead2efbe82d41e6a20ac11ad6d2aa44&quot;&gt;&lt;div style=&quot;position:relative;display:flex;justify-content:center;align-self:center;width:540px;max-width:100%;flex-direction:column&quot;&gt;&lt;img style=&quot;object-fit:contain&quot; src=&quot;https://www.notion.so/image/https%3A%2F%2Fs3.us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F4841bfb7-5a0d-42ae-ba4c-55881d39feec%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45EIPT3X45%252F20221018%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20221018T100700Z%26X-Amz-Expires%3D86400%26X-Amz-Signature%3D87cbcf360f645c59babfc23cfc3ca0c32f8d8d0fb9ed179fe191b88bad48ea85%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject?table=block&amp;amp;id=bead2efb-e82d-41e6-a20a-c11ad6d2aa44&amp;amp;cache=v2&quot; loading=&quot;lazy&quot; alt=&quot;notion image&quot; decoding=&quot;async&quot;/&gt;&lt;/div&gt;&lt;/figure&gt;&lt;div class=&quot;notion-blank notion-block-fd185c5379f34f0a8f0cafca86305977&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-b39975e4a04d40b4b8693d417031d653&quot;&gt;然后，看看 &lt;code class=&quot;notion-inline-code&quot;&gt;time.Duration&lt;/code&gt; 的定义：&lt;/div&gt;&lt;pre class=&quot;notion-code language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;type Duration int64

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    Nanosecond  Duration &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
    Microsecond          &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; Nanosecond
    Millisecond          &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; Microsecond
    Second               &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; Millisecond
    Minute               &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;60&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; Second
    Hour                 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;60&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; Minute
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-b8de09386e5b45e7a5f0ae8bfc054707&quot;&gt;也就是说 &lt;code class=&quot;notion-inline-code&quot;&gt;1000&lt;/code&gt; 的写法默认类型为 &lt;code class=&quot;notion-inline-code&quot;&gt;int&lt;/code&gt; ，编译器会尝试做一次类型转换 &lt;code class=&quot;notion-inline-code&quot;&gt;int&lt;/code&gt; → &lt;code class=&quot;notion-inline-code&quot;&gt;time.Duration&lt;/code&gt; ，而 &lt;code class=&quot;notion-inline-code&quot;&gt;int64&lt;/code&gt; 和 &lt;code class=&quot;notion-inline-code&quot;&gt;int&lt;/code&gt; 又能做到完全兼容，所以编译通过。&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-bb978502225d458d8ea95627d61232a4&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-73679d6edd4946938e9b7e3de693eee1&quot;&gt;WTF，Go…&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-387dcc99be4b4d9bb32787dccb641d7b&quot; data-id=&quot;387dcc99be4b4d9bb32787dccb641d7b&quot;&gt;&lt;span&gt;&lt;div id=&quot;387dcc99be4b4d9bb32787dccb641d7b&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#387dcc99be4b4d9bb32787dccb641d7b&quot; title=&quot;参考：&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;参考：&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-ba5cdf07de3944ea84183d9fab8c5efb&quot;&gt;&lt;li&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://go.dev/blog/constants&quot;&gt;https://go.dev/blog/constants&lt;/a&gt; （本文主要搬运来源）&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-f7b45bfc8bf8475193cb2ae92d69b169&quot;&gt;&lt;li&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://blog.learngoprogramming.com/learn-golang-typed-untyped-constants-70b4df443b61&quot;&gt;https://blog.learngoprogramming.com/learn-golang-typed-untyped-constants-70b4df443b61&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-blank notion-block-3554b88ab160438cae51c7eecbae9b14&quot;&gt; &lt;/div&gt;&lt;/main&gt;]]&gt;&lt;/content&gt;
    &lt;/entry&gt;
    &lt;entry&gt;
        &lt;title type=&quot;html&quot;&gt;&lt;![CDATA[Google 软件工程 读后感 Part I]]&gt;&lt;/title&gt;
        &lt;id&gt;https://next.emergencyexit.xyz//software-engineering-at-google-impression&lt;/id&gt;
        &lt;link href=&quot;https://next.emergencyexit.xyz//software-engineering-at-google-impression&quot;/&gt;
        &lt;updated&gt;2022-09-20T00:00:00.000Z&lt;/updated&gt;
        &lt;summary type=&quot;html&quot;&gt;&lt;![CDATA[有趣的比喻集合]]&gt;&lt;/summary&gt;
        &lt;content type=&quot;html&quot;&gt;&lt;![CDATA[&lt;main class=&quot;notion light-mode notion-page notion-block-3927ece3993146e88e7e91d5e0b5c326&quot;&gt;&lt;div class=&quot;notion-viewport&quot;&gt;&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-ec27187857af4dd7909a8b90936e43ea&quot;&gt;总的来说，这本书值得所有软件开发从业者阅读。一些观点可能不至于奉之圭臬，但也可以提供另一种处理问题的视角。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-897150010d224de4ba48d1ff6f8b1392&quot;&gt;它将很多&lt;b&gt;存在于意识而尚未落成语言的软件工程共识&lt;/b&gt;，用简单易读的方式总结表达了出来，相信对于大多数软件工程师都会有帮助。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-c2ba7cfd50b3425084f45603fcbff89f&quot;&gt;分享书中一些有趣的说法，如果你也觉得有意思，那么就买来读一读吧。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-39594e9a3fce41e49b9a5210fdf01fa3&quot;&gt;（如果你的「洋文🤓」够好，也可以直接&lt;span class=&quot;notion-teal&quot;&gt;&lt;b&gt;免费&lt;/b&gt;&lt;/span&gt;阅读 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://abseil.io/resources/swe-book/html/toc.html&quot;&gt;英文原版&lt;/a&gt;）&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-07d4b358fcd44b0b90fb5a295bd4b1dd&quot; data-id=&quot;07d4b358fcd44b0b90fb5a295bd4b1dd&quot;&gt;&lt;span&gt;&lt;div id=&quot;07d4b358fcd44b0b90fb5a295bd4b1dd&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#07d4b358fcd44b0b90fb5a295bd4b1dd&quot; title=&quot;海勒姆定律（Hyrum’s Law）&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;海勒姆定律（Hyrum’s Law）&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;blockquote class=&quot;notion-quote notion-block-57a7a82e02e64c1ca392536ae1ba3027&quot;&gt;当一个 API 有足够多的用户时，在约定中你所承诺的已不重要：所有在你系统里面被观察到的行为都会被一些用户所依赖。&lt;/blockquote&gt;&lt;div class=&quot;notion-text notion-block-4a142d26df674781897ce80fd220c487&quot;&gt;我从中读出来的关键点：拒绝侥幸心理。当用户体量足够大时，任何改动都需要通过测试来收尾，侥幸心理自认为某些逻辑人畜无害，一两次可能可以省事儿，但总有一天会翻船。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-78bb3c9293c94075b5e2d2754f376ba1&quot; data-id=&quot;78bb3c9293c94075b5e2d2754f376ba1&quot;&gt;&lt;span&gt;&lt;div id=&quot;78bb3c9293c94075b5e2d2754f376ba1&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#78bb3c9293c94075b5e2d2754f376ba1&quot; title=&quot;巴士系数（Truck Factor）&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;巴士系数（&lt;b&gt;Truck Factor&lt;/b&gt;）&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;blockquote class=&quot;notion-quote notion-block-c067d91017c642edaf839e01370db824&quot;&gt;指多少关键开发者被巴士撞了会让项目停摆。&lt;/blockquote&gt;&lt;div class=&quot;notion-text notion-block-11cde37630c343f0a75319a674254b53&quot;&gt;开发者被巴士撞了虽然有点残忍，但确实是一个很形象的表述——当成员突然不参与工作或失去通讯能力。可能在很多团队中，开发者的&lt;b&gt;突然离职&lt;/b&gt;是更贴近这种场景的情况。想要尽量避免因为关键人物的离开而导致项目停摆，书中也列举了基础的预防措施：备份或者结对编程，“每一个人在工作时都需要第二双眼睛的监督”，最重要的是 “拒绝隐藏”。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-33bed20e701b40cb81c0322f955c84b9&quot;&gt;就我个人的经验而言，在项目开发过程中保持良好的文档记录习惯是一种“美德”，在一些更有追求的团队，更应该是“义务”。良好的文档可以一定程度上保持当“巴士”袭来时，团队能够依靠文档维持相当程度的稳定。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-ec305ffabbeb455098df8f3d02b657c0&quot;&gt;当然以上都是从 &lt;b&gt;“团队最优” &lt;/b&gt;的角度来说，并不是所有公司都有 Google 的优秀风气，我还在别的团队听过”教会徒弟，饿死师傅“的说法。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-e4707ad77bbc4cafb4441ddf3eba5912&quot;&gt;这其中孰对孰错，是分享还是私藏，很难在这篇读后感中用几百字讨论清楚。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-6898e8ff30cf46638d1d72ec2c563dad&quot;&gt;我们需要保持清醒：互联网从业有它的特殊性——知识获取门槛极低，任何领域都可以通过网络资源轻松入门，但同时也有其他行业相似的普遍性——在资本逐利的背景下，行业失去高增长，更低成本的人力总是会更有竞争力。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-0f50d6ae1c1e4bf4a295cb1abb100879&quot; data-id=&quot;0f50d6ae1c1e4bf4a295cb1abb100879&quot;&gt;&lt;span&gt;&lt;div id=&quot;0f50d6ae1c1e4bf4a295cb1abb100879&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#0f50d6ae1c1e4bf4a295cb1abb100879&quot; title=&quot;左移思想（Left Shift）&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;左移思想（Left Shift）&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;blockquote class=&quot;notion-quote notion-block-8864520720f8419ab3d1ea039198f93d&quot;&gt;在开发人员工作流的早期发现问题通常会降低成本。&lt;/blockquote&gt;&lt;figure class=&quot;notion-asset-wrapper notion-asset-wrapper-image notion-block-64e5a128d5ba4638a1c92360e5482d1a&quot;&gt;&lt;div style=&quot;position:relative;display:flex;justify-content:center;align-self:center;width:432px;max-width:100%;flex-direction:column&quot;&gt;&lt;img style=&quot;object-fit:contain&quot; src=&quot;https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F33295efc-1f2c-441e-8829-fb516edd724c%2FUntitled.png?table=block&amp;amp;id=64e5a128-d5ba-4638-a1c9-2360e5482d1a&amp;amp;cache=v2&quot; loading=&quot;lazy&quot; alt=&quot;notion image&quot; decoding=&quot;async&quot;/&gt;&lt;/div&gt;&lt;/figure&gt;&lt;div class=&quot;notion-text notion-block-12c690895f02451998de285e999ba4b5&quot;&gt;配合此图，还是非常容易理解的。从开发人员的角度来看，可能存在的问题在越前端解决付出的成本肯定是越小的。举个小例子，陶文在 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://zhuanlan.zhihu.com/p/357411780&quot;&gt;《不要以 DRY 之名，发明低代码 DSL 去残害你的同事》&lt;/a&gt;提到过，缺乏与上游（比如产品、策划）的沟通，只是在开发侧 “一厢情愿” 的抽象可能是一个误区：“先要把需求的源头给按住了。而不是在需求的下游，用可复用抽象代码来兜底”。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-aac58e9671844d35ad0ccc013e987983&quot;&gt;类似地，在敏捷开发和 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://devops.com/devops-shift-left-avoid-failure/&quot;&gt;DevOps 开发理论中也提到过&lt;/a&gt; ，同时还有一个 “&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://devops.com/shift-right-testing-the-emergence-of-testops/&quot;&gt;测试右移&lt;/a&gt;” 的概念，在测试或者是性能检查时，尽量从贴近用户端出发来保证整个产品流程的质量。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-0d9a2e22b9e049a8bac1ff5ca37930de&quot; data-id=&quot;0d9a2e22b9e049a8bac1ff5ca37930de&quot;&gt;&lt;span&gt;&lt;div id=&quot;0d9a2e22b9e049a8bac1ff5ca37930de&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#0d9a2e22b9e049a8bac1ff5ca37930de&quot; title=&quot;经理人炎症（Manageritis）&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;经理人炎症（Manageritis）&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;blockquote class=&quot;notion-quote notion-block-0fe7688ff117426b89f4240ba74b020c&quot;&gt;对于处于进步边缘的有抱负的或者那些刚刚晋升的领导者，存在一种高度危险的自我炎症，称为“管理炎”。&lt;/blockquote&gt;&lt;div class=&quot;notion-text notion-block-f6c396005f6a40a086d0c1750da40ca2&quot;&gt;更简单说法是 “刻意管理”，这种症状多数出现在从个人贡献者 → 管理者身份转变期。很大的原因是，作为技术开发者，我们已经很习惯于在专业技能上投资，并有着合适的回报预期：比如定期在某个领域深入学习，你就能立马获得该领域的技能提升。但是转变到“经理”时，这个回报周期变得不一样了（通常会更长），带领团队向上提升，个体的技能成长反而不容易被感知，会导致做出更高频次的“投资”动作，更加”努力管理”，更容易显得刻意。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-5dee97aa820d411fbc7f0b9e60bcc51b&quot;&gt;还有一个方面的原因，从个人贡献者到管理者后，将会面临很多抉择的场景：&lt;em&gt;自己动手，快速解决问题 &lt;/em&gt;vs &lt;em&gt;交给他人，更慢更困难地解决问题&lt;/em&gt;，及时从更长尺度上来看，后者收益会更高，但在这个抉择面前，没有经验的管理者还是会显得非常犹豫。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-af607e49d1ed49c0ad3bb362bf92ffbe&quot; data-id=&quot;af607e49d1ed49c0ad3bb362bf92ffbe&quot;&gt;&lt;span&gt;&lt;div id=&quot;af607e49d1ed49c0ad3bb362bf92ffbe&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#af607e49d1ed49c0ad3bb362bf92ffbe&quot; title=&quot;碧昂丝规则（Beyoncé Rule）&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;碧昂丝规则（Beyoncé Rule）&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;blockquote class=&quot;notion-quote notion-block-08f7f47edaa44f40a7387935ba510099&quot;&gt;“如果你喜欢它，你就应该测试它”。&lt;/blockquote&gt;&lt;div class=&quot;notion-text notion-block-06be070f5c2f4fe29ec84970faf12195&quot;&gt;原型是：&amp;quot;If you liked it then you shoulda put a ring on it”，来自于碧昂斯 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://www.youtube.com/watch?v=4m1EFMoRFvY&quot;&gt;Single Lady(Put a Ring on It)&lt;/a&gt; 歌词（我感觉关联性不大，我猜是碧昂斯粉丝的私货 🤣）。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-b55310de83394d8a8578c751aa107df5&quot;&gt;意思是“所有不想被破坏的东西”都应该被测试。当你的项目依赖于某些外部系统时，如果想确保一些特性能够符合预期，那么唯一的办法就是在自己的项目编写测试。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-7b582dc921d64925af13c234ff261fe9&quot;&gt;这一点容易被泛化到外部系统的所有特性，我的理解是需要妥善处理依赖的外部系统&lt;b&gt;常见的重点场景&lt;/b&gt;出现异常的情况，而不是全部，也不应该关注全部。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-140a4fcfb666460b9428f70357693cbd&quot;&gt;在 Google 内部常有一种说法：“如果一个产品由于基础设施的变更出现中断或其它问题，但是在我们的持续集成(CI)系统中的自动化测试用例并没有发现这个问题，那么就不应该由负责基础设施的团队承担责任。”&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-c0789386a8ff49b3941623f22c3334df&quot;&gt;在我们日常的工作场景中，大家普遍是没有这个意识的，如果基础设施出问题，无论我们是否有预料，黑锅都可以毫无负担的甩下去，也造成基础设施部门普遍承受了过多压力 xD。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-42d3995b003b481b880565f8f241d6b8&quot; data-id=&quot;42d3995b003b481b880565f8f241d6b8&quot;&gt;&lt;span&gt;&lt;div id=&quot;42d3995b003b481b880565f8f241d6b8&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#42d3995b003b481b880565f8f241d6b8&quot; title=&quot;Fin&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;Fin&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-f4922f38c9ce4edc8ea1d08ddecb407b&quot;&gt;书中还有一些更大值得讨论的话题，以后或许有机会可以结合自己的项目经历写出来聊聊&lt;em&gt;&lt;s&gt;（典型的挖坑不埋）&lt;/s&gt;&lt;/em&gt;。&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-161f0f3cd34d432493910405685342ba&quot;&gt; &lt;/div&gt;&lt;/main&gt;]]&gt;&lt;/content&gt;
    &lt;/entry&gt;
    &lt;entry&gt;
        &lt;title type=&quot;html&quot;&gt;&lt;![CDATA[Django ORM：天使与魔鬼 II]]&gt;&lt;/title&gt;
        &lt;id&gt;https://next.emergencyexit.xyz//django-orm-best-practice-II&lt;/id&gt;
        &lt;link href=&quot;https://next.emergencyexit.xyz//django-orm-best-practice-II&quot;/&gt;
        &lt;updated&gt;2022-09-09T00:00:00.000Z&lt;/updated&gt;
        &lt;summary type=&quot;html&quot;&gt;&lt;![CDATA[CRUD boy 回来了]]&gt;&lt;/summary&gt;
        &lt;content type=&quot;html&quot;&gt;&lt;![CDATA[&lt;main class=&quot;notion light-mode notion-page notion-block-6ad26f7b18284d64a9483cc6367f6901&quot;&gt;&lt;div class=&quot;notion-viewport&quot;&gt;&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-917f169ee9c34019a62c5f85892e3620&quot;&gt;最近重操 CRUD 旧业，又有一些新的发现，故增加一篇 &lt;a class=&quot;notion-link&quot; href=&quot;https://www.notion.so/982e294cabb247aa878134d8bb6fd6ce&quot;&gt;Django ORM：天使与魔鬼&lt;/a&gt; Part II。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-4d19de6795b04c9f89f8e3a758d0954c&quot; data-id=&quot;4d19de6795b04c9f89f8e3a758d0954c&quot;&gt;&lt;span&gt;&lt;div id=&quot;4d19de6795b04c9f89f8e3a758d0954c&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#4d19de6795b04c9f89f8e3a758d0954c&quot; title=&quot;利用 batch_size 控制数据库单次提交的大小&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;利用 batch_size 控制数据库单次提交的大小&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-4441855d1bb34da0aed6aa17fcf05202&quot;&gt;&lt;code class=&quot;notion-inline-code&quot;&gt;bulk_create&lt;/code&gt; 和 &lt;code class=&quot;notion-inline-code&quot;&gt;bulk_update&lt;/code&gt; 是我们常用的批量创建、更新的方法，但批量提速一时爽，提交过长会直接导致任务失败。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-5c409ae54dae4b2b882909acbbeec43c&quot;&gt;之前没有细致查阅文档，想当然 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/TencentBlueKing/bk-user/blob/cd3d14b72d92de0cf687e9466a797b9fd07e0daf/src/api/bkuser_core/common/db_sync.py#L140&quot;&gt;手写了批量提交分片的逻辑&lt;/a&gt; ，虽然也完全实现了功能，但终究多了一份需要维护的逻辑，实际上直接用 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://docs.djangoproject.com/zh-hans/4.1/ref/models/querysets/#bulk-create&quot;&gt;Django 默认提供的 &lt;/a&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://docs.djangoproject.com/zh-hans/4.1/ref/models/querysets/#bulk-create&quot;&gt;&lt;code class=&quot;notion-inline-code&quot;&gt;batch_size&lt;/code&gt;&lt;/a&gt; 即可。&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;from itertools &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; islice

batch_size &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;
objs &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Entry&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;headline&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#x27;Test %s&#x27;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    batch &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;islice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;objs&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; batch_size&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; not batch&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;
    Entry&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;objects&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;bulk_create&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;batch&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; batch_size&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-4560c1f2cdc34fc8b26c830584140494&quot; data-id=&quot;4560c1f2cdc34fc8b26c830584140494&quot;&gt;&lt;span&gt;&lt;div id=&quot;4560c1f2cdc34fc8b26c830584140494&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#4560c1f2cdc34fc8b26c830584140494&quot; title=&quot;通过 Prefetch 控制预取的查询&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;通过 Prefetch 控制预取的查询&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-942fb49c92dd440eacbde16315aa4e4c&quot;&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://stackoverflow.com/questions/97197/what-is-the-n1-selects-problem-in-orm-object-relational-mapping&quot;&gt;N + 1 问题&lt;/a&gt;是非常常见的查询效率杀手。在 Django 中我们通常会使用 &lt;code class=&quot;notion-inline-code&quot;&gt;selected_related&lt;/code&gt; 或&lt;code class=&quot;notion-inline-code&quot;&gt;prefetch_related&lt;/code&gt; 来预取关联对象，来减少和 DB 之间的交互，但是在使用上也需要有一些注意的地方。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-29fd3c9a717c4acaa7d4af894c3bf0e7&quot;&gt;首先，预取需要精确控制到字段。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-e116a47ba91e4fe3a33d9bbd54be8429&quot;&gt;Django 默认的查询方式都是粗放的，例如普通查询不使用 &lt;code class=&quot;notion-inline-code&quot;&gt;values&lt;/code&gt; 或者 &lt;code class=&quot;notion-inline-code&quot;&gt;only&lt;/code&gt; 时都是 &lt;code class=&quot;notion-inline-code&quot;&gt;select *&lt;/code&gt; ，而预取也不例外，看看下面这个例子。&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;models&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Model&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Bar&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;models&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Model&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
	foo &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; models&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ForeignKey&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Foo&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Baz&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;models&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Model&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;A very large table&quot;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;
	foo &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; models&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ForeignKey&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Foo&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-844a600b3a5c44fb806ca38269fa0a16&quot;&gt;我们在查询 &lt;code class=&quot;notion-inline-code&quot;&gt;Foo&lt;/code&gt; 时，会尝试预取关联字段以加速后续数据读取，但如果我们在调用时不加任何参数：&lt;code class=&quot;notion-inline-code&quot;&gt;Foo.objects.all().prefetch_related()&lt;/code&gt; ，&lt;b&gt;默认地 Django 会将所有关联字段都取出来&lt;/b&gt;，加入 &lt;code class=&quot;notion-inline-code&quot;&gt;Baz&lt;/code&gt; 表无比巨大，本来用作性能优化的 &lt;code class=&quot;notion-inline-code&quot;&gt;prefetch_related&lt;/code&gt; 就会摇身变成耗时怪兽。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-05eabf30586c4efd84335bcd09602fed&quot;&gt;此外，我们还会遇到级联预取的场景。&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;models&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Model&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Bar&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;models&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Model&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
	foo &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; models&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ForeignKey&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Foo&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; related_name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;bars&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Baz&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;models&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Model&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
	bar &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; models&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ForeignKey&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Bar&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; related_name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;bazs&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	large_config &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; models&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;JSONField&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-f2e6729bc91346c6ad21fd1a2bcd4ff4&quot;&gt;此时在后续的循环处理中，我们需要通过 &lt;code class=&quot;notion-inline-code&quot;&gt;Foo&lt;/code&gt; 对象查询到 &lt;code class=&quot;notion-inline-code&quot;&gt;Baz&lt;/code&gt; 的数据，为了避免 N + 1 我们也会多级预取:&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;Foo&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;objects&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;select_related&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;bars&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;prefetch_related&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;bars__bazs&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-e7a383c89d8a47d98bb03ea1215373c5&quot;&gt;此时二级预取也是默认获取全部字段，倘若 &lt;code class=&quot;notion-inline-code&quot;&gt;Baz&lt;/code&gt; 表中有一个需要额外耗时序列化的字段，同样会使优化适得其反。这时可以考虑引入 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://docs.djangoproject.com/zh-hans/4.1/ref/models/querysets/#prefetch-objects&quot;&gt;&lt;code class=&quot;notion-inline-code&quot;&gt;Prefetch&lt;/code&gt;&lt;/a&gt; 对象，做更细致的查询控制。&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;Foo&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;objects&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;select_related&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;bars&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;prefetch_related&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;token function&quot;&gt;Prefetch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;bars__bazs&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; queryset&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;Baz&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;objects&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;defer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;large_config&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-blank notion-block-49ad21cac56745f889392cedcb9e5b71&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-744cc7796009402fab94db362da28356&quot;&gt;是不是觉得 ORM 查询本身也挺繁杂的？用 SQL 有时会更直接清晰地多。所以也会有一些完全&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://dev.solita.fi/2021/06/01/why-avoid-an-orm.html&quot;&gt;不使用 ORM 的观点&lt;/a&gt;。在我看来，ORM 能让 90% 的查询都变得结构化更清晰、更易维护、甚至更安全，但剩下的 10% 也许会耗费更多的精力，所以何时使用 ORM 是根据具体项目场景来定的，不能因噎废食。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-b5a4d66ac57a4ca8b13e1028109b39c7&quot; data-id=&quot;b5a4d66ac57a4ca8b13e1028109b39c7&quot;&gt;&lt;span&gt;&lt;div id=&quot;b5a4d66ac57a4ca8b13e1028109b39c7&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#b5a4d66ac57a4ca8b13e1028109b39c7&quot; title=&quot;小广告&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;小广告&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-f88ddea20edb497b87e46b9377a818d2&quot;&gt;是不是觉得 Part II 内容有点少？没关系，更多的内容我都放在了这里。&lt;/div&gt;&lt;div class=&quot;notion-row&quot;&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-bookmark notion-block-11be5a01c4ec4b2abb68cbf4b3bc73dc&quot; href=&quot;https://github.com/TencentBlueKing/python-best-practices&quot;&gt;&lt;div&gt;&lt;div class=&quot;notion-bookmark-title&quot;&gt;GitHub - TencentBlueKing/python-best-practices&lt;/div&gt;&lt;div class=&quot;notion-bookmark-description&quot;&gt;Contribute to TencentBlueKing/python-best-practices development by creating an account on GitHub.&lt;/div&gt;&lt;div class=&quot;notion-bookmark-link&quot;&gt;&lt;img src=&quot;https://github.com/favicon.ico&quot; alt=&quot;GitHub - TencentBlueKing/python-best-practices&quot; loading=&quot;lazy&quot;/&gt;&lt;div&gt;https://github.com/TencentBlueKing/python-best-practices&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-bookmark-image&quot;&gt;&lt;img src=&quot;https://opengraph.githubassets.com/e9d11601584d87c0fbb4092264f7ab23a33987f8d05dfb8b0e0c57157aecc9b3/TencentBlueKing/python-best-practices&quot; alt=&quot;GitHub - TencentBlueKing/python-best-practices&quot; loading=&quot;lazy&quot;/&gt;&lt;/div&gt;&lt;/a&gt;&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-c4cb7b9d7d92463eb7dd154161269031&quot;&gt;我和团队小伙伴整理了很多 Python\Django\DRF 的最佳实践经验，项目会持续更新，欢迎一起探讨维护，希望每一个 CRUD 男孩/女孩都能少踩坑。&lt;/div&gt;&lt;/main&gt;]]&gt;&lt;/content&gt;
    &lt;/entry&gt;
    &lt;entry&gt;
        &lt;title type=&quot;html&quot;&gt;&lt;![CDATA[ReDoS：正则也许会让你的系统更脆弱]]&gt;&lt;/title&gt;
        &lt;id&gt;https://next.emergencyexit.xyz//redos-and-why&lt;/id&gt;
        &lt;link href=&quot;https://next.emergencyexit.xyz//redos-and-why&quot;/&gt;
        &lt;updated&gt;2022-03-01T00:00:00.000Z&lt;/updated&gt;
        &lt;summary type=&quot;html&quot;&gt;&lt;![CDATA[“充数的文章描述”]]&gt;&lt;/summary&gt;
        &lt;content type=&quot;html&quot;&gt;&lt;![CDATA[&lt;main class=&quot;notion light-mode notion-page notion-block-9d18b689cdc24d3f81daa690c700caee&quot;&gt;&lt;div class=&quot;notion-viewport&quot;&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-of-contents notion-gray notion-block-71c5c2ad3a0042a5854d1ffd540fb85b&quot;&gt;&lt;a href=&quot;#16167b014e884180872922c343d81f2f&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:0&quot;&gt;引&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#06a24e1d70ff4b4d8890c4411ad92c88&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:0&quot;&gt;Evil Regex 大敌当前&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#11ab27b4d2ec4f7399a9aecafa750e00&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:0&quot;&gt;知己知彼，百战不殆&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#1596c45ca40b4f4998f3be993530b2ee&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:24px&quot;&gt;NFA vs DFA&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#b0f1e34a5f0242bb83f7f49d56c2621f&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:24px&quot;&gt;Thompson NFA 构造 vs DFA&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#ddeb7f785eb14d7b868a6917822d6ab5&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:24px&quot;&gt;为什么主流编程语言这么慢？&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#6e320bb2c4334d31af6172db35ede111&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:0&quot;&gt;正面对抗 Evil Regex&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#8a414c655d0842eb9a242a88266b28e7&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:24px&quot;&gt;pyre2&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#12c4a78bedf14dcf8397441db47e3f36&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:24px&quot;&gt;regex&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#8ef69d8b54184936a684009d1c35948e&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:0&quot;&gt;总结&lt;/span&gt;&lt;/a&gt;&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-16167b014e884180872922c343d81f2f&quot; data-id=&quot;16167b014e884180872922c343d81f2f&quot;&gt;&lt;span&gt;&lt;div id=&quot;16167b014e884180872922c343d81f2f&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#16167b014e884180872922c343d81f2f&quot; title=&quot;引&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;引&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-64a4a303b845467c8de321306c3fee84&quot;&gt;这里有一段看起来稀松平常、人畜无害的 Python 代码，你可以试着执行一下：&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; re
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; time


value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaabs&quot;&lt;/span&gt;
strange_regex &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; re&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;compile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;(a+)+s&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

start &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
re&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;strange_regex&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
end &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;end &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; start&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-6bb9397fa1ab4801b7edd5bff3e9243b&quot;&gt;不知道大家执行了多久，在我开发机上使用 Python 3.6+（包括 3.10.x）&lt;b&gt;需要耗费20秒以上&lt;/b&gt;，即使 CPU ——Apple M1 Pro 的性能已经相当强悍了。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-e33e99798c1f48bd897156f2a344cbf3&quot;&gt;可以试想一下，如果在生产环境服务的关键请求链路中存在这样正则匹配，加上不可控的用户输入，很容易落入“性能陷阱”，轻则拖慢系统，重则直接让服务暴露在 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://en.wikipedia.org/wiki/ReDoS&quot;&gt;ReDoS&lt;/a&gt; (Regual Expression Denial-of-Service) 的风险之下。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-429048f3ea3c4f989258b2e1a3aa81c4&quot;&gt;随手一搜，已经有不少相关的案例发生：&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-23343&quot;&gt;CVE-2021-23343&lt;/a&gt; 、&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-41817&quot;&gt;CVE-2021-41817&lt;/a&gt;。所以，它值得我们格外重视。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-06a24e1d70ff4b4d8890c4411ad92c88&quot; data-id=&quot;06a24e1d70ff4b4d8890c4411ad92c88&quot;&gt;&lt;span&gt;&lt;div id=&quot;06a24e1d70ff4b4d8890c4411ad92c88&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#06a24e1d70ff4b4d8890c4411ad92c88&quot; title=&quot;Evil Regex 大敌当前&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;Evil Regex 大敌当前&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-421e347965f04238accb85b4748a20b0&quot;&gt;先来看一些和上面例子类似的、典型的邪恶正则：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-98d8301372354699a816e8fd5bc08002&quot;&gt;&lt;li&gt;&lt;code class=&quot;notion-inline-code&quot;&gt;(a+)+&lt;/code&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-0d6cd58d075b49089d85ceaf2ab1753e&quot;&gt;&lt;li&gt;&lt;code class=&quot;notion-inline-code&quot;&gt;([a-zA-Z]+)*&lt;/code&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-51804104983f4c3981f8d0f152a88f9f&quot;&gt;&lt;li&gt;&lt;code class=&quot;notion-inline-code&quot;&gt;(a|aa)+&lt;/code&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-d0d2e591195a4ac8b863524a9b98eba7&quot;&gt;&lt;li&gt;&lt;code class=&quot;notion-inline-code&quot;&gt;(a|a?)+&lt;/code&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-c6b2c4201dcd4463b918ba3275a4887b&quot;&gt;&lt;li&gt;&lt;code class=&quot;notion-inline-code&quot;&gt;(a|a)+$&lt;/code&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-b4e5e7f0f44740ff8b09a30eb3ab254a&quot;&gt;&lt;li&gt; &lt;code class=&quot;notion-inline-code&quot;&gt;(.*a){x} for x \&amp;gt; 10&lt;/code&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-text notion-block-95a16b9277c84bd788ffad18af9382a9&quot;&gt;它们都有共同的一些特点：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-eb56bd6f90c74deaaf58989c90b25b0a&quot;&gt;&lt;li&gt;存在子表达重复——形如 &lt;code class=&quot;notion-inline-code&quot;&gt;()+&lt;/code&gt; 、 &lt;code class=&quot;notion-inline-code&quot;&gt;()*&lt;/code&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-0f99c854d6a74797b1fb0c53db1de6a8&quot;&gt;&lt;li&gt;在重复的子表达中：&lt;/li&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-0f99c854d6a74797b1fb0c53db1de6a8&quot;&gt;&lt;li&gt;存在重复项—— &lt;code class=&quot;notion-inline-code&quot;&gt;(a+)+&lt;/code&gt;&lt;/li&gt;&lt;li&gt;存在交替重复—— &lt;code class=&quot;notion-inline-code&quot;&gt;(a|aa)+&lt;/code&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-481496a757be470f9f6e511dc06659e9&quot;&gt;&lt;li&gt;在重复的子表达的末尾，存在一个子表达式无法匹配的内容，例如 &lt;code class=&quot;notion-inline-code&quot;&gt;(a|a)+$&lt;/code&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-text notion-block-a492ebc689144979995324686ba5ca7f&quot;&gt;那么为什么这些重复会导致匹配速度如此之慢呢？我们要看看正则的具体实现思路。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-11ab27b4d2ec4f7399a9aecafa750e00&quot; data-id=&quot;11ab27b4d2ec4f7399a9aecafa750e00&quot;&gt;&lt;span&gt;&lt;div id=&quot;11ab27b4d2ec4f7399a9aecafa750e00&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#11ab27b4d2ec4f7399a9aecafa750e00&quot; title=&quot;知己知彼，百战不殆&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;知己知彼，百战不殆&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-492dbeb1cfc1451b95d0a1dbecd70d7a&quot;&gt;当前主流语言的正则实现机制都是构建&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://en.wikipedia.org/wiki/Nondeterministic_finite_automaton&quot;&gt;&lt;b&gt;非确定有限状态自动机(NFA)&lt;/b&gt;&lt;/a&gt;&lt;b&gt; &lt;/b&gt;，相较于&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://en.wikipedia.org/wiki/Deterministic_finite_automaton&quot;&gt;&lt;b&gt;确定有限状态自动机(DFA)&lt;/b&gt;&lt;/a&gt;，前者会使用&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://en.wikipedia.org/wiki/Backtracking&quot;&gt;回溯法(backtracking)&lt;/a&gt;，这也是导致邪恶正则存在的根因。&lt;/div&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-1596c45ca40b4f4998f3be993530b2ee&quot; data-id=&quot;1596c45ca40b4f4998f3be993530b2ee&quot;&gt;&lt;span&gt;&lt;div id=&quot;1596c45ca40b4f4998f3be993530b2ee&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#1596c45ca40b4f4998f3be993530b2ee&quot; title=&quot;NFA vs DFA&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;NFA vs DFA&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;div class=&quot;notion-text notion-block-3f9b78a623b0451c9cf0799a903fdc0b&quot;&gt;（该章节中的图例均来自&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://swtch.com/~rsc/regexp/regexp1.html&quot;&gt;这篇文章&lt;/a&gt;，我在这里做了内容简化，建议有兴趣的同学阅读英文原文）&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-620943d008c0426da775e5a82b0f2f74&quot;&gt;FA 有限自动机，又称 FSM 有限状态机，在当前的语境下，我们统一都是用 FA 来描述。这种计算模型比较常见，所以我们就着重关注 NFA 和 DFA 的对比。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-36f538b5c08e41df94547097e1490efd&quot;&gt;首先，来看一个简单的正则表达式—— &lt;code class=&quot;notion-inline-code&quot;&gt;a(bb)+a&lt;/code&gt; ，它可以转换成以下两种表达：&lt;/div&gt;&lt;div class=&quot;notion-row notion-block-8b914cd473c64b568ab10330ec59c60f&quot;&gt;&lt;div class=&quot;notion-column notion-block-9cbe557272fc42eb982c33bdfb7972bd&quot; style=&quot;width:calc((100% - (1 * min(32px, 4vw))) * 0.5)&quot;&gt;&lt;figure class=&quot;notion-asset-wrapper notion-asset-wrapper-image notion-block-64d3af5c94464206883ad1543abd6203&quot;&gt;&lt;div style=&quot;position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:54px&quot;&gt;&lt;img style=&quot;object-fit:contain&quot; src=&quot;https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fe41cc1a4-ae04-422e-8a4d-22e77e03d496%2FUntitled.png?table=block&amp;amp;id=64d3af5c-9446-4206-883a-d1543abd6203&amp;amp;cache=v2&quot; loading=&quot;lazy&quot; alt=&quot;DFA&quot; decoding=&quot;async&quot;/&gt;&lt;figcaption class=&quot;notion-asset-caption&quot;&gt;DFA&lt;/figcaption&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;div class=&quot;notion-column notion-block-3a10ae26ed6b4fee9b000d4e03623deb&quot; style=&quot;width:calc((100% - (1 * min(32px, 4vw))) * 0.5)&quot;&gt;&lt;figure class=&quot;notion-asset-wrapper notion-asset-wrapper-image notion-block-6fdf1be8b201455488080f316c0cea35&quot;&gt;&lt;div style=&quot;position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:54px&quot;&gt;&lt;img style=&quot;object-fit:contain&quot; src=&quot;https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F18765429-1c82-4046-9afe-21a3a68d505d%2FUntitled.png?table=block&amp;amp;id=6fdf1be8-b201-4554-8808-0f316c0cea35&amp;amp;cache=v2&quot; loading=&quot;lazy&quot; alt=&quot;NFA&quot; decoding=&quot;async&quot;/&gt;&lt;figcaption class=&quot;notion-asset-caption&quot;&gt;NFA&lt;/figcaption&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-351ce2ee5b03445fa5e21f10c9d4c8f5&quot;&gt;上面两张图能够很清晰地表现出二者的不同：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-0f74de50e44b48628c88eb34d668addd&quot;&gt;&lt;li&gt;DFA 中，每一个状态在接收到输入时，下一个状态都是确定的。&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-6db506c14054421eb3826a97952bf93c&quot;&gt;&lt;li&gt;NFA 中，存在某些状态在接收到输入时，无法确定下一个状态：例如图中的 S2 接收到字符 b，S1 和 S3 都是可能的下一个状态。所以系统在分支选择时，需要进行猜测。&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-text notion-block-1b2eff3ae49e4c19b23519afe1033bfd&quot;&gt;理论上，每一条正则表达式都可以等同转换成一个 NFA 状态机，那么如果使用 NFA 进行匹配，如何处理猜测分支就很重要了。下面我们来看一个简单遍历猜测的例子。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-61de96581b8649f9a63000513ca7458b&quot;&gt;根据正则 &lt;code class=&quot;notion-inline-code&quot;&gt;abab|abbb&lt;/code&gt; 我们可以建立如下的 NFA：&lt;/div&gt;&lt;figure class=&quot;notion-asset-wrapper notion-asset-wrapper-image notion-block-a81212ec0de24ed5befc71a01610d802&quot;&gt;&lt;div style=&quot;position:relative;display:flex;justify-content:center;align-self:center;width:364px;max-width:100%;flex-direction:column&quot;&gt;&lt;img style=&quot;object-fit:contain&quot; src=&quot;https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F100299f6-ef9d-41f6-b77c-dfbcb1644614%2FUntitled.png?table=block&amp;amp;id=a81212ec-0de2-4ed5-befc-71a01610d802&amp;amp;cache=v2&quot; loading=&quot;lazy&quot; alt=&quot;notion image&quot; decoding=&quot;async&quot;/&gt;&lt;/div&gt;&lt;/figure&gt;&lt;div class=&quot;notion-text notion-block-9d8ec084d55741759e4c296c58045065&quot;&gt;模拟计算机匹配输入 &lt;code class=&quot;notion-inline-code&quot;&gt;abbb&lt;/code&gt;，可以有如下两种路径：&lt;/div&gt;&lt;figure class=&quot;notion-asset-wrapper notion-asset-wrapper-image notion-block-e4c28ba34b134c6ca5a9a0d69c02ed8f&quot;&gt;&lt;div style=&quot;position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%&quot;&gt;&lt;img style=&quot;object-fit:contain&quot; src=&quot;https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F2d01c07f-0cde-40f3-8ad1-837137c1d9d8%2FUntitled.png?table=block&amp;amp;id=e4c28ba3-4b13-4c6c-a5a9-a0d69c02ed8f&amp;amp;cache=v2&quot; loading=&quot;lazy&quot; alt=&quot;notion image&quot; decoding=&quot;async&quot;/&gt;&lt;/div&gt;&lt;/figure&gt;&lt;div class=&quot;notion-text notion-block-0fd8ce7c02894191b05b1c13de3bf6d6&quot;&gt;以 Step 0 开始的路径，在匹配到第三个字符时出错，此时不得不采用回溯，再次从一开始进行匹配，即 Step 4 → Step 8。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-98ec072a50a04ad68c2e3b7317d2b355&quot;&gt;通过这个回溯方法，我们来思考正则表达式 &lt;span role=&quot;button&quot; tabindex=&quot;0&quot; class=&quot;notion-equation notion-equation-inline&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt; 与字符串 &lt;span role=&quot;button&quot; tabindex=&quot;0&quot; class=&quot;notion-equation notion-equation-inline&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt; 匹配：&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-50124f3a5808418c8ce289482e7c3f29&quot;&gt;如果每一次判断 &lt;span role=&quot;button&quot; tabindex=&quot;0&quot; class=&quot;notion-equation notion-equation-inline&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt; 是否存在时，都会尝试匹配“存在”的情况，再匹配不存在的情况，而整个字符串长度为 &lt;span role=&quot;button&quot; tabindex=&quot;0&quot; class=&quot;notion-equation notion-equation-inline&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;，也就是时间复杂度为  &lt;span role=&quot;button&quot; tabindex=&quot;0&quot; class=&quot;notion-equation notion-equation-inline&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-d65ba5a0c9b140f9a94c6fd9c0987fce&quot;&gt;当前主流的语言（Perl, PCRE, Python, Ruby等）采用了&lt;b&gt;递归&lt;/b&gt;来实现深度优先回溯，相较于 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://en.wikipedia.org/wiki/Thompson%27s_construction&quot;&gt;Thompson NFA&lt;/a&gt;，最终实现的效果都是惊人的糟糕。&lt;/div&gt;&lt;div class=&quot;notion-row notion-block-4088dc8fdb2b46e39e930be62fcd58b6&quot;&gt;&lt;div class=&quot;notion-column notion-block-cf952c80f58d42c494f54b20d578f2b2&quot; style=&quot;width:calc((100% - (1 * min(32px, 4vw))) * 0.5)&quot;&gt;&lt;figure class=&quot;notion-asset-wrapper notion-asset-wrapper-image notion-block-08040b98a5b94de2945d4247f370a6ec&quot;&gt;&lt;div style=&quot;position:relative;display:flex;justify-content:center;align-self:center;width:301px;max-width:100%;flex-direction:column&quot;&gt;&lt;img style=&quot;object-fit:contain&quot; src=&quot;https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F62d6c97a-651f-4dae-9157-3711b51864ef%2FUntitled.png?table=block&amp;amp;id=08040b98-a5b9-4de2-945d-4247f370a6ec&amp;amp;cache=v2&quot; loading=&quot;lazy&quot; alt=&quot;notion image&quot; decoding=&quot;async&quot;/&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;div class=&quot;notion-column notion-block-98b4b7afbadd4ca487963dc17f121754&quot; style=&quot;width:calc((100% - (1 * min(32px, 4vw))) * 0.5)&quot;&gt;&lt;figure class=&quot;notion-asset-wrapper notion-asset-wrapper-image notion-block-46b7fb61de5e43cda2bb4539a1289ce4&quot;&gt;&lt;div style=&quot;position:relative;display:flex;justify-content:center;align-self:center;width:302px;max-width:100%;flex-direction:column&quot;&gt;&lt;img style=&quot;object-fit:contain&quot; src=&quot;https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc1b2f543-8d54-4deb-be08-868bc57b76b6%2FUntitled.png?table=block&amp;amp;id=46b7fb61-de5e-43cd-a2bb-4539a1289ce4&amp;amp;cache=v2&quot; loading=&quot;lazy&quot; alt=&quot;notion image&quot; decoding=&quot;async&quot;/&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-b0f1e34a5f0242bb83f7f49d56c2621f&quot; data-id=&quot;b0f1e34a5f0242bb83f7f49d56c2621f&quot;&gt;&lt;span&gt;&lt;div id=&quot;b0f1e34a5f0242bb83f7f49d56c2621f&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#b0f1e34a5f0242bb83f7f49d56c2621f&quot; title=&quot;Thompson NFA 构造 vs DFA&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;Thompson NFA 构造 vs DFA&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;div class=&quot;notion-text notion-block-afff615182dc435797079cc33b8aefd7&quot;&gt;为什么使用了 Thompson NFA 构造出的正则匹配会快这么多呢？主要的原因是：通过划分多个子表达式，合并相同的内容，从而减少了回溯次数。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-6cdd0a3f42c640deb1ff811859b6d99d&quot;&gt;&lt;span role=&quot;button&quot; tabindex=&quot;0&quot; class=&quot;notion-equation notion-equation-inline&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt; 可以转换成 Thompson 构造，图示：&lt;/div&gt;&lt;figure class=&quot;notion-asset-wrapper notion-asset-wrapper-image notion-block-bd7f13b291b6492a8f8a5d6ca6538309&quot;&gt;&lt;div style=&quot;position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%&quot;&gt;&lt;img style=&quot;object-fit:contain&quot; src=&quot;https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F72c2591d-be7f-4f93-b93b-30904f2f6b6c%2FUntitled.png?table=block&amp;amp;id=bd7f13b2-91b6-492a-8f8a-5d6ca6538309&amp;amp;cache=v2&quot; loading=&quot;lazy&quot; alt=&quot;notion image&quot; decoding=&quot;async&quot;/&gt;&lt;/div&gt;&lt;/figure&gt;&lt;div class=&quot;notion-text notion-block-4adb904d36044ce89832ec563f19787d&quot;&gt;稍微做一些解释：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-294f0999d9db457992ec78d4fcf9fe15&quot;&gt;&lt;li&gt;q 是开始，f 是结束，白圈是状态，连线是流转&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-c912429971304c0ca8c14ebace72871d&quot;&gt;&lt;li&gt;ε 代表着无输入&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-text notion-block-9e2bbaa903264df6abc8ed9da0294974&quot;&gt;通过以上的结构，Thompson NFA 匹配的时间复杂度为  &lt;span role=&quot;button&quot; tabindex=&quot;0&quot; class=&quot;notion-equation notion-equation-inline&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;，空间复杂度为&lt;span role=&quot;button&quot; tabindex=&quot;0&quot; class=&quot;notion-equation notion-equation-inline&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;。&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-260ec4a9ed5046938614b4ab45ae7d56&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-bd241b5ae0bf4d23b71a7cdd8c3e8648&quot;&gt;而 DFA 更容易理解，因为它是典型的空间换时间。&lt;/div&gt;&lt;div class=&quot;notion-row notion-block-8b5cf75e5a9943e0899a0d186eb3497b&quot;&gt;&lt;div class=&quot;notion-column notion-block-acc05c036d394d77997d269693990926&quot; style=&quot;width:calc((100% - (1 * min(32px, 4vw))) * 0.5)&quot;&gt;&lt;figure class=&quot;notion-asset-wrapper notion-asset-wrapper-image notion-block-dd9acf4affef4e29a77df33a9f6ee061&quot;&gt;&lt;div style=&quot;position:relative;display:flex;justify-content:center;align-self:center;width:424px;max-width:100%;flex-direction:column&quot;&gt;&lt;img style=&quot;object-fit:contain&quot; src=&quot;https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F7febb121-726d-47a6-80c5-9351397addd6%2FUntitled.png?table=block&amp;amp;id=dd9acf4a-ffef-4e29-a77d-f33a9f6ee061&amp;amp;cache=v2&quot; loading=&quot;lazy&quot; alt=&quot;NFA&quot; decoding=&quot;async&quot;/&gt;&lt;figcaption class=&quot;notion-asset-caption&quot;&gt;NFA&lt;/figcaption&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;div class=&quot;notion-column notion-block-c621a865b06447f4b2fd833d81b688d3&quot; style=&quot;width:calc((100% - (1 * min(32px, 4vw))) * 0.5)&quot;&gt;&lt;figure class=&quot;notion-asset-wrapper notion-asset-wrapper-image notion-block-d8d60f096b0f4e069dc8b2409811f5ac&quot;&gt;&lt;div style=&quot;position:relative;display:flex;justify-content:center;align-self:center;width:496px;max-width:100%;flex-direction:column&quot;&gt;&lt;img style=&quot;object-fit:contain&quot; src=&quot;https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F903b942f-49b7-4953-923c-55fb6d520bd5%2FUntitled.png?table=block&amp;amp;id=d8d60f09-6b0f-4e06-9dc8-b2409811f5ac&amp;amp;cache=v2&quot; loading=&quot;lazy&quot; alt=&quot;DFA&quot; decoding=&quot;async&quot;/&gt;&lt;figcaption class=&quot;notion-asset-caption&quot;&gt;DFA&lt;/figcaption&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-323df8cbfe25433eba3d392eb38f2e8b&quot;&gt;可以看到每一个 DFA 的状态都等同于某一时刻 NFA 状态列表，所以 DFA 在最坏情况下，空间复杂度 &lt;span role=&quot;button&quot; tabindex=&quot;0&quot; class=&quot;notion-equation notion-equation-inline&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;，也会在构建阶段消耗更多时间。同时没有了回溯，整个匹配时间就是字符串长度，复杂度为 &lt;span role=&quot;button&quot; tabindex=&quot;0&quot; class=&quot;notion-equation notion-equation-inline&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;。为了保证 DFA 的空间消耗，一般都会额外对构建出的 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://en.wikipedia.org/wiki/DFA_minimization&quot;&gt;DFA 做简化&lt;/a&gt;，减少图的大小。&lt;/div&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-ddeb7f785eb14d7b868a6917822d6ab5&quot; data-id=&quot;ddeb7f785eb14d7b868a6917822d6ab5&quot;&gt;&lt;span&gt;&lt;div id=&quot;ddeb7f785eb14d7b868a6917822d6ab5&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#ddeb7f785eb14d7b868a6917822d6ab5&quot; title=&quot;为什么主流编程语言这么慢？&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;为什么主流编程语言这么慢？&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;div class=&quot;notion-text notion-block-556cfad12c9a4e90bc6a5aa982a85b89&quot;&gt;说来有趣，Thompson NFA 构造法应该是编译原理的基础概念，DFA 方法从概念上也是比较简单，为什么当前的主流语言没有采用，反而采用了一个带有回溯的、效果远逊的版本？&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-4b68cbc5f2e14f5bbff6d29e174812aa&quot;&gt;经过一番冲浪搜索，简单概括我找到的结论：&lt;b&gt;历史的局限&lt;/b&gt;。&lt;/div&gt;&lt;blockquote class=&quot;notion-quote notion-block-f0186a0b42784296a704da19665a61ff&quot;&gt;&lt;em&gt;While writing the text editor sam [6] in the early 1980s, Rob Pike wrote a new regular expression implementation, which Dave Presotto extracted into a library that appeared in the Eighth Edition. Pike&amp;#x27;s implementation incorporated submatch tracking into an efficient NFA simulation but, like the rest of the Eighth Edition source, was not widely distributed. Pike himself did not realize that his technique was anything new. &lt;/em&gt;&lt;span class=&quot;notion-red&quot;&gt;&lt;em&gt;Henry Spencer reimplemented the Eighth Edition library interface from scratch, but using backtracking, and released his implementation into the public domain.&lt;/em&gt;&lt;/span&gt;&lt;em&gt; &lt;/em&gt;&lt;span class=&quot;notion-red&quot;&gt;&lt;em&gt;It became very widely used, eventually serving as the basis for the slow regular expression implementations mentioned earlier: Perl, PCRE, Python, and so on.&lt;/em&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;div class=&quot;notion-text notion-block-7f091f2eb6e74c62bbd877d83c1d92a8&quot;&gt;可以从上文得知，正则匹配的实现首先需要兼容原来的使用方式，而当时开发者并未了解 NFA 模拟方法，而是自己从零实现了一个回溯方法，并且被广泛地传播开了。即使这个实现很慢，但是由于已经被大规模采用，且能满足大多数的使用场景，各个主流语言也没有替换它。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-6e320bb2c4334d31af6172db35ede111&quot; data-id=&quot;6e320bb2c4334d31af6172db35ede111&quot;&gt;&lt;span&gt;&lt;div id=&quot;6e320bb2c4334d31af6172db35ede111&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#6e320bb2c4334d31af6172db35ede111&quot; title=&quot;正面对抗 Evil Regex&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;正面对抗 Evil Regex&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-ed1e3a4cebbf4d4689dc02e9e576134b&quot;&gt;既然当前主流语言的实现肯定会存在性能陷阱，我们是否有办法检测邪恶正则呢？答案是肯定的。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-787a7eab4c8143eea147b25f34efb1c4&quot;&gt;在社区里有不少相关项目，例如：&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/doyensec/regexploit&quot;&gt;regexploit&lt;/a&gt; 、&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/olivo/redos-detector&quot;&gt;redos-detector&lt;/a&gt; 、&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/davisjam/vuln-regex-detector&quot;&gt;vuln-regex-detector&lt;/a&gt; 等，它们都可以扫描出有风险的正则，就像这样：&lt;/div&gt;&lt;pre class=&quot;notion-code language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ echo &lt;span class=&quot;token string&quot;&gt;&quot;(a+)+s&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; regexploit
&lt;span class=&quot;token literal-property property&quot;&gt;Pattern&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;s
&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;Redos&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;starriness&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; prefix_sequence&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;SEQ&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; redos_sequence&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;SEQ&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; repeated_character&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; killer&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;None&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
Worst&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;complexity&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;11&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;exponential&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
Repeated character&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token literal-property property&quot;&gt;Example&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#x27;a&#x27;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3456&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-1e6c9924ca8148c2adbe7335b9bf6c62&quot;&gt;但是它们局限于静态的正则扫描，对于我们开发者而言，静态防御并不能完全清除风险。更好的思路是直接替换语言的默认实现。以 Python 举例，我们也找到了一些替换库：&lt;/div&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-8a414c655d0842eb9a242a88266b28e7&quot; data-id=&quot;8a414c655d0842eb9a242a88266b28e7&quot;&gt;&lt;span&gt;&lt;div id=&quot;8a414c655d0842eb9a242a88266b28e7&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#8a414c655d0842eb9a242a88266b28e7&quot; title=&quot;pyre2&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;pyre2&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;pre class=&quot;notion-code language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;pip install pyre2&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-efda542abaf5447f92a67e6709475006&quot;&gt;来自 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/google/re2/&quot;&gt;Google re2&lt;/a&gt; 模块的 Python 封装 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/facebook/pyre2&quot;&gt;pyre2&lt;/a&gt;，使用了 DFA 的构造方式。可以替换原生 &lt;code class=&quot;notion-inline-code&quot;&gt;re&lt;/code&gt; 模块，大多数场景都可以得到速度的稳步提升，不存在性能陷阱。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-289140745a58440b96faea1ec82f6395&quot;&gt;但对于 DFA 模拟来说，都是自古华山一条道，比如 &lt;code class=&quot;notion-inline-code&quot;&gt;(?P=&amp;lt;name&amp;gt;)&lt;/code&gt; 这样的属于 &lt;code class=&quot;notion-inline-code&quot;&gt;backreference&lt;/code&gt; 的捕获组语法就无法支持了。&lt;/div&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-12c4a78bedf14dcf8397441db47e3f36&quot; data-id=&quot;12c4a78bedf14dcf8397441db47e3f36&quot;&gt;&lt;span&gt;&lt;div id=&quot;12c4a78bedf14dcf8397441db47e3f36&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#12c4a78bedf14dcf8397441db47e3f36&quot; title=&quot;regex&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;regex&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;pre class=&quot;notion-code language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;pip install regex&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-1f35e9047a1c4d47a37d67ce17ed1e04&quot;&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/mrabarnett/mrab-regex&quot;&gt;regex&lt;/a&gt; 模块&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/mrabarnett/mrab-regex/issues/136&quot;&gt;并未使用 DFA 构造&lt;/a&gt;，在完全兼容 &lt;code class=&quot;notion-inline-code&quot;&gt;re&lt;/code&gt; 模块的同时，支持了一些&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/mrabarnett/mrab-regex#old-vs-new-behaviour&quot;&gt;新特性&lt;/a&gt;。由于实现方案的不同，也没有很明确的文档阐述，尚不清楚它具体的算法（&lt;em&gt;有待进一步从代码层面解读&lt;/em&gt;），但是从效果上，它的性能要&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/mrabarnett/mrab-regex/issues/320&quot;&gt;略好于原生模块&lt;/a&gt;，仅从文中里例子测试看来，也规避了性能陷阱，可以谨慎采用。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-8ef69d8b54184936a684009d1c35948e&quot; data-id=&quot;8ef69d8b54184936a684009d1c35948e&quot;&gt;&lt;span&gt;&lt;div id=&quot;8ef69d8b54184936a684009d1c35948e&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#8ef69d8b54184936a684009d1c35948e&quot; title=&quot;总结&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;总结&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-4c31a30c7e0e4ba19ea2a53dafd478c5&quot;&gt;&lt;li&gt;和很多其他场景一样，程序需要时刻警惕用户的输入，任何不经过校验的内容都可能将程序拖垮。&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-18e7ee68eda94a45b67b4c11dffeb5a7&quot;&gt;&lt;li&gt;理论和实际存在各种各样的鸿沟，在面临现实场景时，理想的想法落地总是困难的。&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-a5f4f5f11c0843a7b1ab7a3cbee60843&quot;&gt;&lt;li&gt;原生不代表就是最优秀的。有特殊需求时可以使用社区方案进行替换。&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-blank notion-block-3672e91b6a7c4125b6980f6f543b1536&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-b38fb92df2184f5096ca8ac1e6c65b00&quot;&gt;参考：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-2d5c165011ab41b7950ff02c9a393e88&quot;&gt;&lt;li&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://swtch.com/~rsc/regexp/regexp1.html&quot;&gt;https://swtch.com/~rsc/regexp/regexp1.html&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-67c19c430a1c49d1ac8563f6f162c2ef&quot;&gt;&lt;li&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS&quot;&gt;https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-b05ea5bd8ae540baa38b654a5b723fac&quot;&gt;&lt;li&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://shivankaul.com/blog/nfa-dfa-and-regexes&quot;&gt;https://shivankaul.com/blog/nfa-dfa-and-regexes&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-0049a5a2d6d54dae964b80639ecb4144&quot;&gt;&lt;li&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://arstechnica.com/civis/viewtopic.php?f=20&amp;amp;t=1195549&quot;&gt;https://arstechnica.com/civis/viewtopic.php?f=20&amp;amp;t=1195549&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-237dd0aa005e4059a61b62f30bed7dc0&quot;&gt;&lt;li&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://news.ycombinator.com/item?id=466957&quot;&gt;https://news.ycombinator.com/item?id=466957&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-9da5e5cb8a684f21bd2f67051397c140&quot;&gt;&lt;li&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://medium.com/swlh/visualizing-thompsons-construction-algorithm-for-nfas-step-by-step-f92ef378581b&quot;&gt;https://medium.com/swlh/visualizing-thompsons-construction-algorithm-for-nfas-step-by-step-f92ef378581b&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-blank notion-block-3f8d2e743c47466294fb92ded6f58558&quot;&gt; &lt;/div&gt;&lt;/main&gt;]]&gt;&lt;/content&gt;
    &lt;/entry&gt;
    &lt;entry&gt;
        &lt;title type=&quot;html&quot;&gt;&lt;![CDATA[旧代码拾遗：如何在 Python 代码中修改 DNS 解析]]&gt;&lt;/title&gt;
        &lt;id&gt;https://next.emergencyexit.xyz//update-dns-in-python&lt;/id&gt;
        &lt;link href=&quot;https://next.emergencyexit.xyz//update-dns-in-python&quot;/&gt;
        &lt;updated&gt;2022-02-18T00:00:00.000Z&lt;/updated&gt;
        &lt;summary type=&quot;html&quot;&gt;&lt;![CDATA[旧代码拾遗]]&gt;&lt;/summary&gt;
        &lt;content type=&quot;html&quot;&gt;&lt;![CDATA[&lt;main class=&quot;notion light-mode notion-page notion-block-a6c3c98f9ef945de9d524baec7327464&quot;&gt;&lt;div class=&quot;notion-viewport&quot;&gt;&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-38daf52d57c342d4be99642547e69bec&quot; data-id=&quot;38daf52d57c342d4be99642547e69bec&quot;&gt;&lt;span&gt;&lt;div id=&quot;38daf52d57c342d4be99642547e69bec&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#38daf52d57c342d4be99642547e69bec&quot; title=&quot;Why&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;Why&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-86d81791a3264f1f850f6fb0215f7f8e&quot;&gt;我们访问 K8S 的 ApiServer 服务，由于为了保证安全性，证书中签发的域名仅包括 &lt;code class=&quot;notion-inline-code&quot;&gt;kubernetes&lt;/code&gt; 和初始的有限 IP 列表，当 ApiServer 服务的 Master 节点需要被替换时，就无法使用新的节点 IP 访问了。解决的方案就是将 &lt;code class=&quot;notion-inline-code&quot;&gt;kubernetes&lt;/code&gt; 域名和新的 IP 临时绑定，骗过证书校验。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-57a46d1303cc45398d79ae16a961b878&quot; data-id=&quot;57a46d1303cc45398d79ae16a961b878&quot;&gt;&lt;span&gt;&lt;div id=&quot;57a46d1303cc45398d79ae16a961b878&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#57a46d1303cc45398d79ae16a961b878&quot; title=&quot;How？&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;How？&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-0134574ed5fc47fdb7044f7ae5305657&quot;&gt;废话不多说，直接看代码&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;# &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; coding&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; utf&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; contextlib
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; importlib
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; threading
from typing &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; Callable&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Dict&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Optional

from urllib3&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;util &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; connection


&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;CustomLocalDnsResolver&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;threading&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;local&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&quot;支持线程级自定义 Dns 记录
    &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&quot;

    def &lt;span class=&quot;token function&quot;&gt;__init__&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;self&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;dns_map&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Optional&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;dict&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;None&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        # 线程保存各自 dns_map，但是访问入口均为 dns_map
        self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dns_map &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; dns_map or &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;


def &lt;span class=&quot;token function&quot;&gt;get_patch_create_connection_with_dns&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dns_resolver&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; Callable&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;simply get patched create_connection&quot;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;

    # 保留原方法
    _orig_create_connection &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getattr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;importlib&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;import_module&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#x27;urllib3.util.connection&#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#x27;create_connection&#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    def &lt;span class=&quot;token function&quot;&gt;patched_create_connection&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;address&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;args&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;kwargs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;在 urllib3&#x27;s create_connection 流程前解析 address&quot;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;
        domain&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; port &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; address
        # 当 _local_dns&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dns_map 为空，对正常流程无影响
        host &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; dns_resolver&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dns_map&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;domain&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; domain&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;_orig_create_connection&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;host&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;args&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;kwargs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; patched_create_connection


_local_dns &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;CustomLocalDnsResolver&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
# patch 全局 create_connection
connection&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;create_connection &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;get_patch_create_connection_with_dns&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;_local_dns&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;


@contextlib&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;contextmanager
def &lt;span class=&quot;token function&quot;&gt;update_local_dns_once&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dns_map&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Dict&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;一次性修改线程 dns 解析&quot;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;
    _local_dns&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dns_map &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; dns_map
    &lt;span class=&quot;token keyword&quot;&gt;yield&lt;/span&gt;
    _local_dns&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dns_map &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;


# 具体的使用场景
&lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;update_local_dns_once&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token string-property property&quot;&gt;&quot;kubernetes&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;192.168.1.1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    # 可以在该 context 中请求外部系统&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-blank notion-block-d6c4207d6e5f406d98f2f7f01373402a&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-1798e8cd901544068cc7e842253d62bc&quot;&gt; &lt;/div&gt;&lt;/main&gt;]]&gt;&lt;/content&gt;
    &lt;/entry&gt;
    &lt;entry&gt;
        &lt;title type=&quot;html&quot;&gt;&lt;![CDATA[小记：如何将 Logstash7 镜像替换为 KonaJDK]]&gt;&lt;/title&gt;
        &lt;id&gt;https://next.emergencyexit.xyz//use-konajdk-in-logstash-image&lt;/id&gt;
        &lt;link href=&quot;https://next.emergencyexit.xyz//use-konajdk-in-logstash-image&quot;/&gt;
        &lt;updated&gt;2021-12-28T00:00:00.000Z&lt;/updated&gt;
        &lt;summary type=&quot;html&quot;&gt;&lt;![CDATA[随手记录，简单却防遗忘]]&gt;&lt;/summary&gt;
        &lt;content type=&quot;html&quot;&gt;&lt;![CDATA[&lt;main class=&quot;notion light-mode notion-page notion-block-f7327b98b06a423a8b9f646e5ba2123f&quot;&gt;&lt;div class=&quot;notion-viewport&quot;&gt;&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-db808c0aadf3437d856ba61c501ddc3f&quot;&gt; &lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-56d00d6fc33c42f993dac1cac2f1192d&quot; data-id=&quot;56d00d6fc33c42f993dac1cac2f1192d&quot;&gt;&lt;span&gt;&lt;div id=&quot;56d00d6fc33c42f993dac1cac2f1192d&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#56d00d6fc33c42f993dac1cac2f1192d&quot; title=&quot;Step 0 预备环境&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;Step 0 预备环境&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-a6c6802f89cd49ffa227d1412ba85e2e&quot;&gt;Rake 是一个由 Ruby 实现的 Make-like 工具，可以用 Ruby 来编排项目任务流程，例如出二进制包、构建镜像等。在 GitHub Logstash 项目的 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/elastic/logstash/blob/main/rakelib/artifacts.rake&quot;&gt;rakelib&lt;/a&gt; 里找到镜像构建逻辑。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-e2aa50674a46414493bdf4a5db0a4b63&quot;&gt;构建之前，需要保证构建机包含以下工具：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-21edbc015296410cb6d699195fb2c21a&quot;&gt;&lt;li&gt;Docker&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-b097a4840a8244bb9c6f71c05339decc&quot;&gt;&lt;li&gt;GNU Make&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-e3e863afff554e338340b7d47028d284&quot;&gt;&lt;li&gt;Python 3.5+ with Virtualenv&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-ec9f85330613463c8cb3c0baf40783b6&quot;&gt;&lt;li&gt;JRuby 9.1+ （实际上 Mac 自带 Ruby 也是可行的）&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-text notion-block-481102291cd947a7b7755166ccfb5104&quot;&gt;然后将 Logstash 项目 clone 到本地，并切换到预期修改的版本：&lt;/div&gt;&lt;pre class=&quot;notion-code language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;git checkout v7&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;16.2&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-77fd59e96d934fc29d55c6ffb4e0fb71&quot; data-id=&quot;77fd59e96d934fc29d55c6ffb4e0fb71&quot;&gt;&lt;span&gt;&lt;div id=&quot;77fd59e96d934fc29d55c6ffb4e0fb71&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#77fd59e96d934fc29d55c6ffb4e0fb71&quot; title=&quot;Step 1 精简构建步骤&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;Step 1 精简构建步骤&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-71b0a3dec2a74de8a3cfddbcd89f377b&quot;&gt;构建步骤中，默认会包括 Windows\MacOS 以及 Arm 的构建，如果你并不需要这些平台，可以如下手动修改构建步骤，能够大大加快你的构建速度：&lt;/div&gt;&lt;pre class=&quot;notion-code language-ruby&quot;&gt;&lt;code class=&quot;language-ruby&quot;&gt;# &lt;span class=&quot;token function&quot;&gt;create_archive_pack&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;license_details&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;x86_64&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;linux&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;windows&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;darwin&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;create_archive_pack&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;license_details&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;x86_64&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;linux&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
# &lt;span class=&quot;token function&quot;&gt;create_archive_pack&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;license_details&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;arm64&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;linux&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;figcaption class=&quot;notion-asset-caption&quot;&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/elastic/logstash/blob/2cf6675f538247be091df9d31cc455538f029a07/rakelib/artifacts.rake#L142&quot;&gt;artifacts.rake&lt;/a&gt;&lt;/figcaption&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-912a6e2fab744f6e8b0f4b434806f701&quot; data-id=&quot;912a6e2fab744f6e8b0f4b434806f701&quot;&gt;&lt;span&gt;&lt;div id=&quot;912a6e2fab744f6e8b0f4b434806f701&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#912a6e2fab744f6e8b0f4b434806f701&quot; title=&quot;Step 2 修改 Python 版本&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;Step 2 修改 Python 版本&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-2adb74e716a2480ea35f6f3b07850e98&quot;&gt;如果你不想为了构建镜像额外下载其他 Python 版本，可以手动修改 Makefile&lt;/div&gt;&lt;pre class=&quot;notion-code language-makefile&quot;&gt;&lt;code class=&quot;language-makefile&quot;&gt;# &lt;span class=&quot;token constant&quot;&gt;PY_VERSION&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3.6&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;.13&lt;/span&gt;
# &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;
&lt;span class=&quot;token constant&quot;&gt;PY_VERSION&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3.6&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;.7&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;figcaption class=&quot;notion-asset-caption&quot;&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/elastic/logstash/blob/2cf6675f538247be091df9d31cc455538f029a07/docker/Makefile#L3&quot;&gt;Makefile&lt;/a&gt;&lt;/figcaption&gt;&lt;div class=&quot;notion-text notion-block-bad578fd54a34a018be8aa73abcb9e3b&quot;&gt;理论上保证 Python 版本大于 3.5 即可。&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-53071725dbcc47bbacf124bd49fbb662&quot;&gt; &lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-2c3c96643334464f9ebc93d14cea61c2&quot; data-id=&quot;2c3c96643334464f9ebc93d14cea61c2&quot;&gt;&lt;span&gt;&lt;div id=&quot;2c3c96643334464f9ebc93d14cea61c2&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#2c3c96643334464f9ebc93d14cea61c2&quot; title=&quot;Step 3 指定 JDK 版本&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;Step 3 指定 JDK 版本&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-9fc57152348c48088f81bdd78a10d2f1&quot;&gt;如标题所示，我们的目标是将 Logstash 镜像里的 OpenJDK 替换成 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/Tencent/TencentKona-11&quot;&gt;KonaJDK&lt;/a&gt;。构建时手动指定 JDK 地址即可&lt;/div&gt;&lt;pre class=&quot;notion-code language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token constant&quot;&gt;JDK_URL&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;https&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;github&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;com&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;Tencent&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;TencentKona&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;releases&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;download&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;kona11&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0.13&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;fiber&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;TencentKona&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;11.0&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;.13&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;b1_jdk_fiber_linux&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;x86_64&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tar&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;gz rake artifact&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;docker&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-blank notion-block-26ebe1cc373b40a2af4165805f5c18f8&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-bf0dcb10928d45a9a50662a45d504b34&quot;&gt;等待构建，大功告成 xD&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-46d2d7251c9f4e1398e84f133d1796db&quot;&gt; &lt;/div&gt;&lt;/main&gt;]]&gt;&lt;/content&gt;
    &lt;/entry&gt;
    &lt;entry&gt;
        &lt;title type=&quot;html&quot;&gt;&lt;![CDATA[用 GraphQL 查询你的 Django 应用]]&gt;&lt;/title&gt;
        &lt;id&gt;https://next.emergencyexit.xyz//use-graphql-with-django&lt;/id&gt;
        &lt;link href=&quot;https://next.emergencyexit.xyz//use-graphql-with-django&quot;/&gt;
        &lt;updated&gt;2021-11-27T00:00:00.000Z&lt;/updated&gt;
        &lt;summary type=&quot;html&quot;&gt;&lt;![CDATA[强是挺强，但适用场景依旧有限]]&gt;&lt;/summary&gt;
        &lt;content type=&quot;html&quot;&gt;&lt;![CDATA[&lt;main class=&quot;notion light-mode notion-page notion-full-width notion-block-9a08823eeec64cc09ec8890cb0650aa7&quot;&gt;&lt;div class=&quot;notion-viewport&quot;&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-of-contents notion-gray notion-block-7cbbabf5b06b4f1b832fe664023382bd&quot;&gt;&lt;a href=&quot;#6f80cc74a749486d8ad82ae7a1aea572&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:0&quot;&gt;什么是 GraphQL ？&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#5041039329414c21aaebd26612c47d03&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:0&quot;&gt;它有什么有意思的特性&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#5be2fa55f8854b9dae359baadc092859&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:24px&quot;&gt;Fragments&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#51381a94e35a4a2790d130b10e46dbd2&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:24px&quot;&gt;Directives&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#f7baf2676dcd4b14a48a5960996fbfbb&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:0&quot;&gt;和 REST 相比较有什么优势和劣势？&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#8b386b3470f74f38862ae13b9c8ee6e9&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:24px&quot;&gt;TLDR&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#1d318237ebd04d408d49f9a6ac2982d0&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:24px&quot;&gt;vs 扩展的 REST 协议&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#3db8daa2fcb0409baa596fd5472b9ff3&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:0&quot;&gt;什么是 GraphQL 客户端?&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#499a5d133c9b493e946a692b0e21a062&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:0&quot;&gt;服务端落地：GraphQL → Django&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#8c904f70489a4268a7b5c8f4ca2d51e6&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:24px&quot;&gt;支持 Relay&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#3d929743493649a6a43da55924cdfa5e&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:24px&quot;&gt;引入 graphene-django-extras&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#0068853173e54e1bacc12aa21d51205d&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:24px&quot;&gt;鉴权&lt;/span&gt;&lt;/a&gt;&lt;a href=&quot;#10f53459be3844c7a1355a1ed5bd63b9&quot; class=&quot;notion-table-of-contents-item&quot;&gt;&lt;span class=&quot;notion-table-of-contents-item-body&quot; style=&quot;display:inline-block;margin-left:0&quot;&gt;总结&lt;/span&gt;&lt;/a&gt;&lt;/div&gt;&lt;div class=&quot;notion-callout notion-gray_background_co notion-block-2986488d269c41b787a73096363557d2&quot;&gt;&lt;span class=&quot;notion-page-icon&quot; role=&quot;img&quot; aria-label=&quot;😶‍🌫️&quot;&gt;😶‍🌫️&lt;/span&gt;&lt;div class=&quot;notion-callout-text&quot;&gt;全文以后端开发视角写作，部分涉及到前端开发的介绍可能存在错误或者不准确，欢迎在评论区斧正&lt;/div&gt;&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-6f80cc74a749486d8ad82ae7a1aea572&quot; data-id=&quot;6f80cc74a749486d8ad82ae7a1aea572&quot;&gt;&lt;span&gt;&lt;div id=&quot;6f80cc74a749486d8ad82ae7a1aea572&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#6f80cc74a749486d8ad82ae7a1aea572&quot; title=&quot;什么是 GraphQL ？&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;什么是 GraphQL ？&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-9ce07e2a85a94064abc0f2e22d9324cf&quot;&gt;先来看看 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://zh.wikipedia.org/wiki/GraphQL&quot;&gt;wikipedia&lt;/a&gt;：&lt;/div&gt;&lt;blockquote class=&quot;notion-quote notion-block-5e3b15ce4caa4fc9a4bdf513a497a202&quot;&gt;GraphQL 是一个开源的，面向 API 而创造出来的数据查询操作语言以及相应的服务端运行环境。&lt;/blockquote&gt;&lt;div class=&quot;notion-text notion-block-46ff6eaaa64045318192214e00ed3b7a&quot;&gt;GraphQL 首先是一种查询语言，它定义了一种通用的数据查询方式，可以理解为一种通用的 SQL，只不过前者面向抽象的数据集，后者往往是具体的关系型数据库。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-2cbc564d204a449faf4f770a57101a88&quot;&gt;其次，它还包括一种服务端运行时，用于实现查询语句解析、数据类型定义。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-5041039329414c21aaebd26612c47d03&quot; data-id=&quot;5041039329414c21aaebd26612c47d03&quot;&gt;&lt;span&gt;&lt;div id=&quot;5041039329414c21aaebd26612c47d03&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#5041039329414c21aaebd26612c47d03&quot; title=&quot;它有什么有意思的特性&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;它有什么有意思的特性&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-78e75c481cda4072b1e02f6cd843e186&quot;&gt;仅从后端开发视角，列举几个觉得有意思的特性&lt;/div&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-5be2fa55f8854b9dae359baadc092859&quot; data-id=&quot;5be2fa55f8854b9dae359baadc092859&quot;&gt;&lt;span&gt;&lt;div id=&quot;5be2fa55f8854b9dae359baadc092859&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#5be2fa55f8854b9dae359baadc092859&quot; title=&quot;Fragments&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;Fragments&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;pre class=&quot;notion-code language-graphql&quot;&gt;&lt;code class=&quot;language-graphql&quot;&gt;query &lt;span class=&quot;token function&quot;&gt;HeroComparison&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;$first&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Int &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;leftComparison&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hero&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;episode&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;EMPIRE&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;comparisonFields
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;rightComparison&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hero&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;episode&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;JEDI&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;comparisonFields
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

fragment comparisonFields on Character &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  name
  &lt;span class=&quot;token function&quot;&gt;friendsConnection&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;first&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; $first&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    totalCount
    edges &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      node &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        name
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-c04278bd4ae44492a254104fde035325&quot;&gt;使用 Fragment 复用查询内容，并且可以定义参数&lt;/div&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-51381a94e35a4a2790d130b10e46dbd2&quot; data-id=&quot;51381a94e35a4a2790d130b10e46dbd2&quot;&gt;&lt;span&gt;&lt;div id=&quot;51381a94e35a4a2790d130b10e46dbd2&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#51381a94e35a4a2790d130b10e46dbd2&quot; title=&quot;Directives&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;Directives&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;pre class=&quot;notion-code language-graphql&quot;&gt;&lt;code class=&quot;language-graphql&quot;&gt;query &lt;span class=&quot;token function&quot;&gt;Hero&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;$episode&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Episode&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;$withFriends&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Boolean&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;hero&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;episode&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; $episode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    name
    friends @&lt;span class=&quot;token function&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; $withFriends&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      name
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

# variables
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token string-property property&quot;&gt;&quot;episode&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;JEDI&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token string-property property&quot;&gt;&quot;withFriends&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-50804a4e6c7d45c1a89613654cb0eedd&quot;&gt;可以通过通用的两种指令来控制一些字段的返回：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-b6b987cd363943509af04767f54d1795&quot;&gt;&lt;li&gt; &lt;code class=&quot;notion-inline-code&quot;&gt;@include(if: Boolean)&lt;/code&gt; &lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-9d6988932833425689d6246356037357&quot;&gt;&lt;li&gt; &lt;code class=&quot;notion-inline-code&quot;&gt;@skip(if: Boolean)&lt;/code&gt; &lt;/li&gt;&lt;/ul&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-f7baf2676dcd4b14a48a5960996fbfbb&quot; data-id=&quot;f7baf2676dcd4b14a48a5960996fbfbb&quot;&gt;&lt;span&gt;&lt;div id=&quot;f7baf2676dcd4b14a48a5960996fbfbb&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#f7baf2676dcd4b14a48a5960996fbfbb&quot; title=&quot;和 REST 相比较有什么优势和劣势？&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;和 REST 相比较有什么优势和劣势？&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-8b386b3470f74f38862ae13b9c8ee6e9&quot; data-id=&quot;8b386b3470f74f38862ae13b9c8ee6e9&quot;&gt;&lt;span&gt;&lt;div id=&quot;8b386b3470f74f38862ae13b9c8ee6e9&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#8b386b3470f74f38862ae13b9c8ee6e9&quot; title=&quot;TLDR&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;TLDR&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;div class=&quot;notion-text notion-block-b286d02d551a49ceb9c46c7736257409&quot;&gt;REST 更多是从 HTTP 协议出发的一种约定协议，因为受制于 HTTP 协议本身的设计，在&lt;b&gt;表达能力&lt;/b&gt;上是弱于&lt;b&gt;作为查询语言&lt;/b&gt;的 GraphQL 的。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-a88e97e928ae41ab81936449989916a6&quot;&gt;同时，REST 通常都是由后端开发者主动封装，而 GraphQL 则是由前端主动拼装。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-865d80be70cf4e4aaacde0d426f1e966&quot;&gt;所以如果面对的场景是&lt;span class=&quot;notion-teal&quot;&gt;前端需求复杂而多变，GraphQL 肯定比 REST 更适合快速迭代。&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-d59f255d52314c30b7292fcf4312e374&quot;&gt;也正因此，GraphQL 在实现上更加繁复，所以&lt;span class=&quot;notion-pink&quot;&gt;面对 API 数量少、需求不会轻易的场景时，REST 反而是更适合的技术选型。&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-dd6dda57e33e4cc4a158fe795567d923&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-bae7469dcdf3408cab30219494171505&quot;&gt;&lt;em&gt;作为后端开发，学习和使用 GraphQL 的动力，更多是&lt;/em&gt;&lt;em&gt;&lt;b&gt;想将自己从 CRUD 的泥沼中拯救出来，&lt;/b&gt;&lt;/em&gt;&lt;em&gt;将更多的精力放在其他更重要的技术上。&lt;/em&gt;&lt;/div&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-1d318237ebd04d408d49f9a6ac2982d0&quot; data-id=&quot;1d318237ebd04d408d49f9a6ac2982d0&quot;&gt;&lt;span&gt;&lt;div id=&quot;1d318237ebd04d408d49f9a6ac2982d0&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#1d318237ebd04d408d49f9a6ac2982d0&quot; title=&quot;vs 扩展的 REST 协议&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;vs 扩展的 REST 协议&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;div class=&quot;notion-text notion-block-9b5c1dee8abf461f85b0cc6ab7187b8c&quot;&gt;（此小节中图片拷贝自&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://www.howtographql.com/basics/1-graphql-is-th&quot;&gt;网络&lt;/a&gt;，懒得画）&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-9f3b0d45de334ab4bbd7ee7edf38e4ff&quot;&gt;和 REST 一样，GraphQL 并不是什么开发框架，它只是定义了一种通用型查询的 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://en.wikipedia.org/wiki/Domain-specific_language&quot;&gt;DSL&lt;/a&gt;。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-9a384f67fe30477f978ff21b22e36de9&quot;&gt;而使用 REST 协议进行资源拉取，我们总是会面临一些实际的问题，而 GraphQL 可以在一定程度上解决。那么肯定会有同学在想，REST 是非常灵活的，完全可以通过自建一个查询语法，弥补上述的 REST 缺陷，何必要另外引入 GraphQL 徒增复杂度呢。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-016edec76cf34328ac821ba4bc4268e3&quot;&gt;说的没错，所以我们在阐述这些问题的时候，也会附上我们当前基于 REST 的解决方案。&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-9151f0fa7aa04512bd8567f9b597b835&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-86523c26bb6f4ca881988768cfd86c64&quot;&gt;&lt;b&gt;Overfetching：&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-261e9041ab2347b7aa5f4f2ac4bf7283&quot;&gt;假如我们定义了一个 &lt;code class=&quot;notion-inline-code&quot;&gt;/comments&lt;/code&gt; 的 API，输出评论列表。以 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://www.django-rest-framework.org/&quot;&gt;django-rest-framework&lt;/a&gt; 为例，我们都会定义一个 &lt;code class=&quot;notion-inline-code&quot;&gt;Serializer&lt;/code&gt; 来声明它的输入和输出。&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;from rest_framework &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; serializers

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;CommentSerializer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;serializers&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Serializer&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    email &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; serializers&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;EmailField&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    content &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; serializers&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;CharField&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;max_length&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    logo &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; serializer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ImageField&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;省略数不清的字段&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    created &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; serializers&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;DateTimeField&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    ip_from &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; serializers&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;IPAddressField&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-9243ba0ad276413398efd52a86e73c76&quot;&gt;看起来符合常理，它可以轻松满足大多数评论列表的需求。但是也许某一天，我们需要一个评论的精简列表的 API，当前返回内容中，除了 &lt;code class=&quot;notion-inline-code&quot;&gt;content&lt;/code&gt; 以外的其他字段都变成多余了，那么后端开发需要重新定一个 &lt;code class=&quot;notion-inline-code&quot;&gt;MinimalCommentSerializer&lt;/code&gt; 来满足新的需求。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-c1041cb777b346d89717b6b8227d5719&quot;&gt;在 REST 基础中，我们增加了 &lt;code class=&quot;notion-inline-code&quot;&gt;fields&lt;/code&gt; 参数，并在 &lt;code class=&quot;notion-inline-code&quot;&gt;DRF Serializer&lt;/code&gt; 里做了&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/TencentBlueKing/bk-user/blob/8c633e0a3821beb839ed120c4514c5733e675862/src/api/bkuser_core/common/viewset.py#L71&quot;&gt;特殊处理（你可以点击查看源码）&lt;/a&gt;，实现的具体效果：&lt;/div&gt;&lt;pre class=&quot;notion-code language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;# 查询 comment，并限制结果返回字段
&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;api&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;comments&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;fields&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;email&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;content

# 返回
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token string-property property&quot;&gt;&quot;results&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token string-property property&quot;&gt;&quot;email&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;foo@bar.com&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string-property property&quot;&gt;&quot;content&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;I love this blog, simple and good looking.&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-f597e7e436cb44f4940b946ac14191db&quot;&gt;而如果我们使用 GraphQL，写法上会更自然：&lt;/div&gt;&lt;pre class=&quot;notion-code language-graphql&quot;&gt;&lt;code class=&quot;language-graphql&quot;&gt;query &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  comment &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    email
    content
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-73155088d28a4e6f8b82bf2551ad1a67&quot;&gt;&lt;b&gt;Underfetching&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-5b93503e6e0c47fa8165bb452f67c8f3&quot;&gt;相较于 Overfetching 是获取了过多数据，Underfetching 则是在请求获取的数据不足够满足需求。&lt;/div&gt;&lt;figure class=&quot;notion-asset-wrapper notion-asset-wrapper-image notion-block-76d7c8f902c246cba62dfd7a00b5c990&quot;&gt;&lt;div style=&quot;position:relative;display:flex;justify-content:center;align-self:center;width:720px;max-width:100%;flex-direction:column&quot;&gt;&lt;img style=&quot;object-fit:contain&quot; src=&quot;https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F7396e0b5-7539-4174-992e-c35a8076984e%2FUntitled.png?table=block&amp;amp;id=76d7c8f9-02c2-46cb-a62d-fd7a00b5c990&amp;amp;cache=v2&quot; loading=&quot;lazy&quot; alt=&quot;传统的 REST 协议&quot; decoding=&quot;async&quot;/&gt;&lt;figcaption class=&quot;notion-asset-caption&quot;&gt;传统的 REST 协议&lt;/figcaption&gt;&lt;/div&gt;&lt;/figure&gt;&lt;div class=&quot;notion-text notion-block-f20ce9deab744d049c5c529571cf5b0a&quot;&gt;假如我们需要获取所有用户维度的评论，我们需要先获取通过 &lt;code class=&quot;notion-inline-code&quot;&gt;/users&lt;/code&gt; 所有用户 id，再使用 id 列表遍历查询 &lt;code class=&quot;notion-inline-code&quot;&gt;/users/&amp;lt;id&amp;gt;/comments&lt;/code&gt; 来获取相关的列表。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-664a1feb5c8f4030a77f313f8f2c05f0&quot;&gt;在 REST 中，为了这个需求我们可能会额外为 &lt;code class=&quot;notion-inline-code&quot;&gt;/users&lt;/code&gt; 增加一个参数 &lt;code class=&quot;notion-inline-code&quot;&gt;with_comments&lt;/code&gt; &lt;/div&gt;&lt;pre class=&quot;notion-code language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;# 查询 users，并限制结果返回字段
&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;api&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;users&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;with_comments&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;

# 返回
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token string-property property&quot;&gt;&quot;results&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token string-property property&quot;&gt;&quot;username&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;foo&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string-property property&quot;&gt;&quot;telephone&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;12345&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string-property property&quot;&gt;&quot;comments&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token string-property property&quot;&gt;&quot;email&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;foo@bar.com&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token string-property property&quot;&gt;&quot;content&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;I love this blog, simple and good looking.&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-blank notion-block-d002648bd6984cb1ac8c6a0951653437&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-511e89a1906b47068da530351636a8ab&quot;&gt;相较于自定义的 REST 协议，使用 GraphQL 可以更简单：&lt;/div&gt;&lt;figure class=&quot;notion-asset-wrapper notion-asset-wrapper-image notion-block-801be6ddb7bf4afd988363ef9ea359ea&quot;&gt;&lt;div style=&quot;position:relative;display:flex;justify-content:center;align-self:center;width:624px;max-width:100%;flex-direction:column&quot;&gt;&lt;img style=&quot;object-fit:contain&quot; src=&quot;https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc730795a-8b87-497e-a6c8-38c4c29f310a%2FUntitled.png?table=block&amp;amp;id=801be6dd-b7bf-4afd-9883-63ef9ea359ea&amp;amp;cache=v2&quot; loading=&quot;lazy&quot; alt=&quot;使用 GraphQL，只需要一次请求&quot; decoding=&quot;async&quot;/&gt;&lt;figcaption class=&quot;notion-asset-caption&quot;&gt;使用 GraphQL，只需要一次请求&lt;/figcaption&gt;&lt;/div&gt;&lt;/figure&gt;&lt;hr class=&quot;notion-hr notion-block-a7cc3850d7d34e9394559e3c484535a8&quot;/&gt;&lt;div class=&quot;notion-blank notion-block-ae2e1ab9de4445e9af25da3b4283ed30&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-e5388855af4c4978ab5d79d928a68fac&quot;&gt;相信通过上面的例子，我们可以清晰地看出，相较于 GraphQL ，基于 REST 扩展协议存在这些问题：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-0c2d157b66104281b7465d60c317263c&quot;&gt;&lt;li&gt;不够通用，用户有额外的学习成本，增加了额外的文档负担。&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-bf511966e9b04e6f9565a4435370aaf7&quot;&gt;&lt;li&gt;基于 REST ，单个请求只能针对单个对象进行描述。需要等待需求沉淀，由后端主动封装，迭代节奏会更慢。&lt;/li&gt;&lt;/ul&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-3db8daa2fcb0409baa596fd5472b9ff3&quot; data-id=&quot;3db8daa2fcb0409baa596fd5472b9ff3&quot;&gt;&lt;span&gt;&lt;div id=&quot;3db8daa2fcb0409baa596fd5472b9ff3&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#3db8daa2fcb0409baa596fd5472b9ff3&quot; title=&quot;什么是 GraphQL 客户端?&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;什么是 GraphQL 客户端?&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-b271423a2db348a9a08562e982457465&quot;&gt;我们主要聚焦于 GraphQL 服务端提供，但是也需要先看一下所谓的客户端究竟做了什么。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-e4ae6016eb264be39a05804c3bd07f25&quot;&gt;简单来说，要想在原生 Javascript 中直接使用 GraphQL 并不是一件特别容易的事，需要一些库来协助拉取和管理 GraphQL 数据。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-3114c568468f4b9cb5b95fe9120d51dd&quot;&gt;相较于原生的 GraphQL ，客户端主要解决了几件事情：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-2729ac7032e44245a0b78c928929cfda&quot;&gt;&lt;li&gt;客户端数据拉取缓存问题（包括缓存一致性、更新缓存等）&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-f3841eb2487b404d8002ecfebcd4e44b&quot;&gt;&lt;li&gt;数据分页、声明式数据获取&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-dd027b39a3d647529443d0b0220299df&quot;&gt;&lt;li&gt;...&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-text notion-block-5b0213aea8b443078ff3c6d9eb1455b5&quot;&gt;主流的客户端框架主要有两种—— &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://relay.dev/&quot;&gt;Relay&lt;/a&gt; 和 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://www.apollographql.com/&quot;&gt;Apollo&lt;/a&gt; ，我们仅从有限的角度来看下二者的异同：&lt;/div&gt;&lt;div class=&quot;notion-collection notion-block-79eac296c4544b138687c18a99776607&quot;&gt;&lt;div class=&quot;notion-collection-header&quot; style=&quot;padding-left:96px;padding-right:96px&quot;&gt;&lt;div class=&quot;notion-collection-header-title&quot;&gt;Relay vs Apollo&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-table&quot; style=&quot;width:1024px;max-width:1024px&quot;&gt;&lt;div class=&quot;notion-table-view&quot; style=&quot;padding-left:96px;padding-right:96px&quot;&gt;&lt;div class=&quot;notion-table-header&quot;&gt;&lt;div class=&quot;notion-table-header-inner&quot;&gt;&lt;div class=&quot;notion-table-th&quot;&gt;&lt;div class=&quot;notion-table-view-header-cell&quot; style=&quot;width:232.66949462890625px&quot;&gt;&lt;div class=&quot;notion-table-view-header-cell-inner&quot;&gt;&lt;div class=&quot;notion-collection-column-title&quot;&gt;&lt;svg viewBox=&quot;0 0 14 14&quot; class=&quot;notion-collection-column-title-icon&quot;&gt;&lt;path d=&quot;M7.74 8.697a.81.81 0 01.073.308.894.894 0 01-.9.888.867.867 0 01-.825-.592l-.333-.961H2.058l-.333.961a.882.882 0 01-.838.592A.884.884 0 010 9.005c0-.11.025-.222.062-.308l2.403-6.211c.222-.58.776-.986 1.442-.986.653 0 1.22.407 1.442.986l2.39 6.211zM2.6 6.824h2.613L3.907 3.102 2.6 6.824zm8.8-3.118c1.355 0 2.6.542 2.6 2.255V9.08a.8.8 0 01-.789.814.797.797 0 01-.788-.703c-.395.468-1.097.764-1.874.764-.949 0-2.07-.64-2.07-1.972 0-1.392 1.121-1.897 2.07-1.897.789 0 1.491.246 1.886.727v-.826c0-.604-.518-.998-1.306-.998-.469 0-.888.123-1.32.394a.64.64 0 01-.307.086.602.602 0 01-.592-.604c0-.221.123-.419.284-.517a3.963 3.963 0 012.206-.641zm-.222 5.188c.505 0 .998-.172 1.257-.517v-.74c-.259-.345-.752-.517-1.257-.517-.616 0-1.122.332-1.122.9 0 .554.506.874 1.122.874zM.656 11.125h12.688a.656.656 0 110 1.313H.656a.656.656 0 110-1.313z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;div class=&quot;notion-collection-column-title-body&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-th&quot;&gt;&lt;div class=&quot;notion-table-view-header-cell&quot; style=&quot;width:232.66949462890625px&quot;&gt;&lt;div class=&quot;notion-table-view-header-cell-inner&quot;&gt;&lt;div class=&quot;notion-collection-column-title&quot;&gt;&lt;svg viewBox=&quot;0 0 14 14&quot; class=&quot;notion-collection-column-title-icon&quot;&gt;&lt;path d=&quot;M7 4.568a.5.5 0 00-.5-.5h-6a.5.5 0 00-.5.5v1.046a.5.5 0 00.5.5h6a.5.5 0 00.5-.5V4.568zM.5 1a.5.5 0 00-.5.5v1.045a.5.5 0 00.5.5h12a.5.5 0 00.5-.5V1.5a.5.5 0 00-.5-.5H.5zM0 8.682a.5.5 0 00.5.5h11a.5.5 0 00.5-.5V7.636a.5.5 0 00-.5-.5H.5a.5.5 0 00-.5.5v1.046zm0 3.068a.5.5 0 00.5.5h9a.5.5 0 00.5-.5v-1.045a.5.5 0 00-.5-.5h-9a.5.5 0 00-.5.5v1.045z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;div class=&quot;notion-collection-column-title-body&quot;&gt;Relay&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-th&quot;&gt;&lt;div class=&quot;notion-table-view-header-cell&quot; style=&quot;width:369.66949462890625px&quot;&gt;&lt;div class=&quot;notion-table-view-header-cell-inner&quot;&gt;&lt;div class=&quot;notion-collection-column-title&quot;&gt;&lt;svg viewBox=&quot;0 0 14 14&quot; class=&quot;notion-collection-column-title-icon&quot;&gt;&lt;path d=&quot;M7 4.568a.5.5 0 00-.5-.5h-6a.5.5 0 00-.5.5v1.046a.5.5 0 00.5.5h6a.5.5 0 00.5-.5V4.568zM.5 1a.5.5 0 00-.5.5v1.045a.5.5 0 00.5.5h12a.5.5 0 00.5-.5V1.5a.5.5 0 00-.5-.5H.5zM0 8.682a.5.5 0 00.5.5h11a.5.5 0 00.5-.5V7.636a.5.5 0 00-.5-.5H.5a.5.5 0 00-.5.5v1.046zm0 3.068a.5.5 0 00.5.5h9a.5.5 0 00.5-.5v-1.045a.5.5 0 00-.5-.5h-9a.5.5 0 00-.5.5v1.045z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;div class=&quot;notion-collection-column-title-body&quot;&gt;Apollo&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-header-placeholder&quot;&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-body&quot;&gt;&lt;div class=&quot;notion-table-row&quot;&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-title&quot; style=&quot;width:232.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-title&quot;&gt;&lt;a class=&quot;notion-page-link&quot; href=&quot;https://www.notion.so/bc1b723e68814b8db570eaa51d4dd328&quot;&gt;&lt;span class=&quot;notion-page-title&quot;&gt;&lt;svg class=&quot;notion-page-title-icon notion-page-icon&quot; alt=&quot;框架支持&quot; viewBox=&quot;0 0 30 30&quot; width=&quot;16&quot;&gt;&lt;path d=&quot;M16,1H4v28h22V11L16,1z M16,3.828L23.172,11H16V3.828z M24,27H6V3h8v10h10V27z M8,17h14v-2H8V17z M8,21h14v-2H8V21z M8,25h14v-2H8V25z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;span class=&quot;notion-page-title-text&quot;&gt;框架支持&lt;/span&gt;&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-text&quot; style=&quot;width:232.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-text&quot;&gt;仅支持 React, React Native&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-text&quot; style=&quot;width:369.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-text&quot;&gt;无框架限定&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-row&quot;&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-title&quot; style=&quot;width:232.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-title&quot;&gt;&lt;a class=&quot;notion-page-link&quot; href=&quot;https://www.notion.so/574b8c14d70949388afad8250db9a9ee&quot;&gt;&lt;span class=&quot;notion-page-title&quot;&gt;&lt;svg class=&quot;notion-page-title-icon notion-page-icon&quot; alt=&quot;GraphQL API&quot; viewBox=&quot;0 0 30 30&quot; width=&quot;16&quot;&gt;&lt;path d=&quot;M16,1H4v28h22V11L16,1z M16,3.828L23.172,11H16V3.828z M24,27H6V3h8v10h10V27z M8,17h14v-2H8V17z M8,21h14v-2H8V21z M8,25h14v-2H8V25z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;span class=&quot;notion-page-title-text&quot;&gt;GraphQL API&lt;/span&gt;&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-text&quot; style=&quot;width:232.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-text&quot;&gt;需要特定的 Schema 支持&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-text&quot; style=&quot;width:369.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-text&quot;&gt;无需特定的 Schema 支持&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-row&quot;&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-title&quot; style=&quot;width:232.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-title&quot;&gt;&lt;a class=&quot;notion-page-link&quot; href=&quot;https://www.notion.so/c0029db1fe0c44948186e6eb55c57632&quot;&gt;&lt;span class=&quot;notion-page-title&quot;&gt;&lt;svg class=&quot;notion-page-title-icon notion-page-icon&quot; alt=&quot;学习成本&quot; viewBox=&quot;0 0 30 30&quot; width=&quot;16&quot;&gt;&lt;path d=&quot;M16,1H4v28h22V11L16,1z M16,3.828L23.172,11H16V3.828z M24,27H6V3h8v10h10V27z M8,17h14v-2H8V17z M8,21h14v-2H8V21z M8,25h14v-2H8V25z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;span class=&quot;notion-page-title-text&quot;&gt;学习成本&lt;/span&gt;&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-text&quot; style=&quot;width:232.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-text&quot;&gt;较高&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-text&quot; style=&quot;width:369.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-text&quot;&gt;较低&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-row&quot;&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-title&quot; style=&quot;width:232.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-title&quot;&gt;&lt;a class=&quot;notion-page-link&quot; href=&quot;https://www.notion.so/5cf89e43953a4289aef7334c7760d81a&quot;&gt;&lt;span class=&quot;notion-page-title&quot;&gt;&lt;svg class=&quot;notion-page-title-icon notion-page-icon&quot; alt=&quot;生产力&quot; viewBox=&quot;0 0 30 30&quot; width=&quot;16&quot;&gt;&lt;path d=&quot;M16,1H4v28h22V11L16,1z M16,3.828L23.172,11H16V3.828z M24,27H6V3h8v10h10V27z M8,17h14v-2H8V17z M8,21h14v-2H8V21z M8,25h14v-2H8V25z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;span class=&quot;notion-page-title-text&quot;&gt;生产力&lt;/span&gt;&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-text&quot; style=&quot;width:232.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-text&quot;&gt;高&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-text&quot; style=&quot;width:369.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-text&quot;&gt;较低&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-row&quot;&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-title&quot; style=&quot;width:232.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-title&quot;&gt;&lt;a class=&quot;notion-page-link&quot; href=&quot;https://www.notion.so/d710e6b7a1a2458493f3a4a06adc7f6e&quot;&gt;&lt;span class=&quot;notion-page-title&quot;&gt;&lt;svg class=&quot;notion-page-title-icon notion-page-icon&quot; alt=&quot;灵活性&quot; viewBox=&quot;0 0 30 30&quot; width=&quot;16&quot;&gt;&lt;path d=&quot;M16,1H4v28h22V11L16,1z M16,3.828L23.172,11H16V3.828z M24,27H6V3h8v10h10V27z M8,17h14v-2H8V17z M8,21h14v-2H8V21z M8,25h14v-2H8V25z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;span class=&quot;notion-page-title-text&quot;&gt;灵活性&lt;/span&gt;&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-text&quot; style=&quot;width:232.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-text&quot;&gt;固定结构&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-text&quot; style=&quot;width:369.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-text&quot;&gt;较灵活&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-row&quot;&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-title&quot; style=&quot;width:232.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-title&quot;&gt;&lt;a class=&quot;notion-page-link&quot; href=&quot;https://www.notion.so/4e0a6851a331441cbb68fd9b6fa17ffb&quot;&gt;&lt;span class=&quot;notion-page-title&quot;&gt;&lt;svg class=&quot;notion-page-title-icon notion-page-icon&quot; alt=&quot;是否支持订阅&quot; viewBox=&quot;0 0 30 30&quot; width=&quot;16&quot;&gt;&lt;path d=&quot;M16,1H4v28h22V11L16,1z M16,3.828L23.172,11H16V3.828z M24,27H6V3h8v10h10V27z M8,17h14v-2H8V17z M8,21h14v-2H8V21z M8,25h14v-2H8V25z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;span class=&quot;notion-page-title-text&quot;&gt;是否支持订阅&lt;/span&gt;&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-text&quot; style=&quot;width:232.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-text&quot;&gt;否&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;notion-table-cell notion-table-cell-text&quot; style=&quot;width:369.66949462890625px&quot;&gt;&lt;span class=&quot;notion-property notion-property-text&quot;&gt;是&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-25bbafb30a124becb56e2e541cd779e4&quot;&gt;简而言之，Realy 更复杂，更能够应对大型应用，Apollo 更轻量，不过需要更多的手工劳动。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-499a5d133c9b493e946a692b0e21a062&quot; data-id=&quot;499a5d133c9b493e946a692b0e21a062&quot;&gt;&lt;span&gt;&lt;div id=&quot;499a5d133c9b493e946a692b0e21a062&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#499a5d133c9b493e946a692b0e21a062&quot; title=&quot;服务端落地：GraphQL → Django&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;服务端落地：GraphQL → Django&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-d82aba35a7ee4c7e896c4366b1d5ec5e&quot;&gt;想要将 GraphQL 引入现有的项目，我们需要安装两个基础的依赖：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-850425fb270440e89da6348449515cbf&quot;&gt;&lt;li&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/graphql-python/graphene-django&quot;&gt;graphene-django&lt;/a&gt; &lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-06516dcbe6bf497184297351f2d2b55c&quot;&gt;&lt;li&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/carltongibson/django-filter&quot;&gt;django-filter&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-text notion-block-7f566dd96e93421b9e7552ca098c92db&quot;&gt;二者分别负责两部分的工作：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-269531b02e9c47c88da2441c19e7ccc0&quot;&gt;&lt;li&gt;Django Model ⇒  Schema&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-17baeebedf8c4e94a698faf2a0dfebd4&quot;&gt;&lt;li&gt;Query  ⇒  Filter Django Model &lt;/li&gt;&lt;/ul&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-8c904f70489a4268a7b5c8f4ca2d51e6&quot; data-id=&quot;8c904f70489a4268a7b5c8f4ca2d51e6&quot;&gt;&lt;span&gt;&lt;div id=&quot;8c904f70489a4268a7b5c8f4ca2d51e6&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#8c904f70489a4268a7b5c8f4ca2d51e6&quot; title=&quot;支持 Relay&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;支持 Relay&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;div class=&quot;notion-text notion-block-e80c823d66984b70aef628752f33c177&quot;&gt;graphene-django 本身 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://docs.graphene-python.org/projects/django/en/latest/tutorial-relay/&quot;&gt;默认支持 Relay&lt;/a&gt;，所以你可以很容易地开启&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;from graphene &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; relay
from graphene_django &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; DjangoObjectType
from ingredients&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;models &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; Category

# Graphene will automatically map the Category model&#x27;s fields onto the CategoryNode&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
# This is configured &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; the CategoryNode&#x27;s Meta &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; you can see below&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;CategoryNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DjangoObjectType&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Meta&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        model &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Category
        filter_fields &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#x27;name&#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#x27;ingredients&#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
        interfaces &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;relay&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Node&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-eecb673cd4084d57ad0a511380cd6b28&quot;&gt;不过很多时候考虑到 Relay 的复杂度，有时都不适合引入，更何况 Relay 需要特殊的 Schema 支持：&lt;/div&gt;&lt;div class=&quot;notion-row notion-block-419c60d4a1a84f0ba4d39bb116e55b71&quot;&gt;&lt;div class=&quot;notion-column notion-block-63a72f800f3946378539183410ea26ba&quot; style=&quot;width:calc((100% - (1 * min(32px, 4vw))) * 0.5)&quot;&gt;&lt;pre class=&quot;notion-code language-graphql&quot;&gt;&lt;code class=&quot;language-graphql&quot;&gt;query &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  allIngredients &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    edges &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      node &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        name
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;figcaption class=&quot;notion-asset-caption&quot;&gt;Relay Schema：edges、node 层级同样会出现在返回值&lt;/figcaption&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;div class=&quot;notion-column notion-block-5c0491f03bc64f83aea39c6375e5f19d&quot; style=&quot;width:calc((100% - (1 * min(32px, 4vw))) * 0.5)&quot;&gt;&lt;pre class=&quot;notion-code language-graphql&quot;&gt;&lt;code class=&quot;language-graphql&quot;&gt;query &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  allIngredients &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    id
    name
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;



&lt;/code&gt;&lt;/pre&gt;&lt;figcaption class=&quot;notion-asset-caption&quot;&gt;原生 Schema： 明显更自然、简洁&lt;/figcaption&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-25b4916ef4774955a012fbc141f700eb&quot;&gt;这时候 graphene-django 就存在一个问题，当不使用 Relay 时，存在一些功能缺失：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-ded5b120c51d4b1b8132a268a7d6b3f9&quot;&gt;&lt;li&gt;Fragment \ Directives &lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-c75d9e445c274d5da510af554f9830a5&quot;&gt;&lt;li&gt;分页、过滤&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-33259eba02144fa9acda4e3e1eaf90ec&quot;&gt;&lt;li&gt;通过 DRF Serializer 定义 Mutations&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-text notion-block-21b3d48f64384238aad0c4a13b125c0f&quot;&gt;所以我们需要引入额外的库来解决。&lt;/div&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-3d929743493649a6a43da55924cdfa5e&quot; data-id=&quot;3d929743493649a6a43da55924cdfa5e&quot;&gt;&lt;span&gt;&lt;div id=&quot;3d929743493649a6a43da55924cdfa5e&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#3d929743493649a6a43da55924cdfa5e&quot; title=&quot;引入 graphene-django-extras&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;引入 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/eamigo86/graphene-django-extras&quot;&gt;graphene-django-extras&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;from graphene &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; ObjectType
from graphene_django_extras &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; DjangoListObjectField&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; DjangoListObjectType
from graphene_django_extras&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;paginations &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; LimitOffsetGraphqlPagination

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;CommentListType&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DjangoListObjectType&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Meta&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        model &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Comment
        fields &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;__all__&quot;&lt;/span&gt;
        pagination &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;LimitOffsetGraphqlPagination&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;default_limit&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ordering&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;-id&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Query&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ObjectType&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    comments &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;DjangoListObjectField&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CommentListType&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; description&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Query all comments&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-7b3762d8e2ad445e9c38eac7bedd68e5&quot;&gt;&lt;b&gt;支持复杂过滤查询&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-6ebe03413a0040f4b7b5295e3b67a824&quot;&gt;可以在列表对象中增加 &lt;code class=&quot;notion-inline-code&quot;&gt;filter_fields&lt;/code&gt; ，针对不同的字段支持不同的 Django 复杂查询方法。&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;CommentListType&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DjangoListObjectType&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Meta&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        model &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Comment
        filter_fields &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token string-property property&quot;&gt;&quot;id&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;exact&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;in&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token string-property property&quot;&gt;&quot;content&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;exact&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;icontains&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;istartswith&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        pagination &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;LimitOffsetGraphqlPagination&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;default_limit&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ordering&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;-username&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-c71e31a767824aff9b82ee53004c179c&quot;&gt;这样就可以将一些 Django 的查询能力释放到前端&lt;/div&gt;&lt;pre class=&quot;notion-code language-graphql&quot;&gt;&lt;code class=&quot;language-graphql&quot;&gt;query &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;comments&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;id__In&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; content_Icontains&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Amazing&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    totalCount
    &lt;span class=&quot;token function&quot;&gt;results&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;limit&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;offset&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      id
      email
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; 
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-208020ce25114ee2a60d8b07df687d43&quot;&gt;&lt;b&gt;自定义查询字段&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-fa290cc6855049289a6df8b9537c6cf3&quot;&gt;Django 默认的查询能力，对于一些特殊字段并不能完全覆盖需求，这时我们就需要针对这些内容手写一些处理逻辑。&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Query&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ObjectType&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    user &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Field&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;UserType&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; description&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Retrieve certain user&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; username&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

		def &lt;span class=&quot;token function&quot;&gt;resolve_user&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        self&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;GraphQLResolveInfo&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Optional&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;int&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; None&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;username&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Optional&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;str&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; None
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; User&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; id is not None&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; User&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;objects&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pk&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; username is None&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
            raise &lt;span class=&quot;token function&quot;&gt;ValueError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;username or pk at least one is required&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

        # &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt; some custom logic
        &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; User&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;objects&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;username&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;username&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-cce7dff50ba44dffa5f85844bfdcf91b&quot;&gt;需要注意的是，当我们使用 &lt;code class=&quot;notion-inline-code&quot;&gt;resolve_&lt;/code&gt; 函数去处理查询时，GraphQL 和 REST 本质上只是查询 DSL 有所区别，都会遇到类似像 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://stackoverflow.com/questions/97197/what-is-the-n1-selects-problem-in-orm-object-relational-mapping&quot;&gt;N+1&lt;/a&gt; 这样的慢查询问题，所以需要谨慎地将前端的查询转换成可靠的 Django ORM 查询。&lt;/div&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-0068853173e54e1bacc12aa21d51205d&quot; data-id=&quot;0068853173e54e1bacc12aa21d51205d&quot;&gt;&lt;span&gt;&lt;div id=&quot;0068853173e54e1bacc12aa21d51205d&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#0068853173e54e1bacc12aa21d51205d&quot; title=&quot;鉴权&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;鉴权&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;div class=&quot;notion-text notion-block-41b09c496df54886b6b685e8f38fb9c5&quot;&gt;由于 API 请求并不再经过传统封装的 ViewSet，原有的鉴权组件不再能使用，你需要引入新的 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/redzej/graphene-permissions&quot;&gt;graphene-permissions&lt;/a&gt; 来解决针对用户的权限控制。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-486546d75ed744b48491c065b47b6915&quot;&gt;本文成文时，graphene-permissions 对于最新的 Graphene 3.x 有一些&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/redzej/graphene-permissions/pull/36&quot;&gt;小的兼容性问题&lt;/a&gt;，由于该库代码量非常小，可以考虑复制到自己的项目手动维护。&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;from &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;mixins &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; AuthNode
from &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;permissions &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; AllowSuperuser

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;UserNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AuthNode&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; DjangoObjectType&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    permission_classes &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AllowAuthenticated&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Meta&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        model &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; User
        filter_fields &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#x27;username&#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        interfaces &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;relay&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Node&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-blank notion-block-3a7758ed778747038fbc0b83f8c7ec6e&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-212d68c0638c45c1a66570938e3eb1c7&quot;&gt;尴尬的是，如果你并不想用 Relay，我们需要针对 graphene-django-extras 做一些自己的定制，而原有的封装没有很好地暴露足够的接口，经过一番探索并无头绪，最终作罢🥴。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-10f53459be3844c7a1355a1ed5bd63b9&quot; data-id=&quot;10f53459be3844c7a1355a1ed5bd63b9&quot;&gt;&lt;span&gt;&lt;div id=&quot;10f53459be3844c7a1355a1ed5bd63b9&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#10f53459be3844c7a1355a1ed5bd63b9&quot; title=&quot;总结&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;总结&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-9d67626a1d9641cd90f5af2e20aa6bc9&quot;&gt;&lt;li&gt;GraphQL 在前端需求迭代频繁的场景下，比 REST 更符合现代开发节奏&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-9f6415435fd9484fbc2ce5c4d2770bfe&quot;&gt;&lt;li&gt;GraphQL 的语言设计比自定义扩展的 REST 更自然，更具备通用性&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-2448995dbf5046fb8d4cf720a8a4991a&quot;&gt;&lt;li&gt;GraphQL 会将比较多的工作放到客户端，适合成熟的客户端开发团队，反之 REST 是更好的选择&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-df526e5ca78840c8a0cf8355e37cf7bf&quot;&gt;&lt;li&gt;Django 相关的生态建设并不完善，没有一个足够强大、开箱即用的整合方案&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-f819d57fbe4b469683400d4b084480c1&quot;&gt;&lt;li&gt;由于查询并不是基于 Uri 维度，会给周边配套的生态—— 监控、日志等 ——带来一些新的挑战&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-blank notion-block-ddaf5c2480f746f791a762c4707709f5&quot;&gt; &lt;/div&gt;&lt;/main&gt;]]&gt;&lt;/content&gt;
    &lt;/entry&gt;
    &lt;entry&gt;
        &lt;title type=&quot;html&quot;&gt;&lt;![CDATA[不要往 AMQP 的 Header 乱塞东西]]&gt;&lt;/title&gt;
        &lt;id&gt;https://next.emergencyexit.xyz//amqp-header-has-frame-max-limit&lt;/id&gt;
        &lt;link href=&quot;https://next.emergencyexit.xyz//amqp-header-has-frame-max-limit&quot;/&gt;
        &lt;updated&gt;2021-11-17T00:00:00.000Z&lt;/updated&gt;
        &lt;summary type=&quot;html&quot;&gt;&lt;![CDATA[内容过度封装，标题过于直白]]&gt;&lt;/summary&gt;
        &lt;content type=&quot;html&quot;&gt;&lt;![CDATA[&lt;main class=&quot;notion light-mode notion-page notion-full-width notion-small-text notion-block-da9db88226ea4516815c75f2f9ddab59&quot;&gt;&lt;div class=&quot;notion-viewport&quot;&gt;&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-2fd1bb98202342939e35ee2f8efff7ae&quot; data-id=&quot;2fd1bb98202342939e35ee2f8efff7ae&quot;&gt;&lt;span&gt;&lt;div id=&quot;2fd1bb98202342939e35ee2f8efff7ae&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#2fd1bb98202342939e35ee2f8efff7ae&quot; title=&quot;前情提要&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;前情提要&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-528ec1ed01944bb0817d5ce684823362&quot;&gt;一直以来，我们在 Python 项目中的后台任务都是使用 celery 搭配 Redis(作为 broker)来完成，同时针对短任务轮询场景我们也&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/TencentBlueKing/bkpaas-python-sdk/tree/master/sdks/blue-krill/blue_krill/async_utils&quot;&gt;做了一些封装&lt;/a&gt;。在项目运行的三~四年间，这套方案完美地承载了我们核心功能。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-20bb6ad0221948d08881077d55bbbc63&quot;&gt;然而，就在不久前的一周，出现一些比较诡异的问题，总是有些后台任务发生阻塞，我们使用的多种异常观测手段（&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://sentry.io/&quot;&gt;Sentry&lt;/a&gt;、日志等）都无法准确定位到具体问题（这或许是另一个故事），于是死马当活马医，我们决定将 Redis 更换为 RabbitMQ，这样能够更为准确地观测到任务具体执行的消息情况（例如是否及时Ack）。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-b75e1c76f97445b8a2dd0c4314fd5fb7&quot; data-id=&quot;b75e1c76f97445b8a2dd0c4314fd5fb7&quot;&gt;&lt;span&gt;&lt;div id=&quot;b75e1c76f97445b8a2dd0c4314fd5fb7&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#b75e1c76f97445b8a2dd0c4314fd5fb7&quot; title=&quot;案发现场&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;案发现场&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-075fe4f158b142519af19e46a7772d99&quot;&gt;更换完 broker 之后，却发现了另一个奇怪的问题（没错，这才是本文的主角）。我们在某一些特殊资源的场景下，celery 任务会直接报错：&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;ConnectionResetError&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;Errno &lt;span class=&quot;token number&quot;&gt;104&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; Connection reset by peer
  File &lt;span class=&quot;token string&quot;&gt;&quot;kombu/connection.py&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; line &lt;span class=&quot;token number&quot;&gt;414&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; _reraise_as_library_errors
    &lt;span class=&quot;token keyword&quot;&gt;yield&lt;/span&gt;
  File &lt;span class=&quot;token string&quot;&gt;&quot;kombu/connection.py&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; line &lt;span class=&quot;token number&quot;&gt;494&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; _ensured
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fun&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;args&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;kwargs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  File &lt;span class=&quot;token string&quot;&gt;&quot;kombu/messaging.py&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; line &lt;span class=&quot;token number&quot;&gt;203&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; _publish
    mandatory&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;mandatory&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; immediate&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;immediate&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  File &lt;span class=&quot;token string&quot;&gt;&quot;amqp/channel.py&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; line &lt;span class=&quot;token number&quot;&gt;1766&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;_basic_publish&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; exchange&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; routing_key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; mandatory&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; immediate&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; msg
  File &lt;span class=&quot;token string&quot;&gt;&quot;amqp/abstract_channel.py&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; line &lt;span class=&quot;token number&quot;&gt;59&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; send_method
    conn&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;frame_writer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;channel_id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; sig&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; content&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  File &lt;span class=&quot;token string&quot;&gt;&quot;amqp/method_framing.py&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; line &lt;span class=&quot;token number&quot;&gt;154&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; write_frame
    &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; channel&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; framelen&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; frame&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0xce&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  File &lt;span class=&quot;token string&quot;&gt;&quot;amqp/transport.py&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; line &lt;span class=&quot;token number&quot;&gt;305&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; write
    self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;_write&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-c68ba31ee3a2430db79b993e87e7dd29&quot;&gt;由于我们使用了一层 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://cloud.tencent.com/product/clb&quot;&gt;CLB&lt;/a&gt; 作为高可用代理，而之前的使用经验中，CLB 可能会有一些长时间无数据断连的情况，所以我们暂时认为可能是某些长时间的阻塞任务会导致 CLB 主动断开，为了排除干扰，我们甩开了 CLB，直接采用 MQ 的多个节点作为地址直连。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-c29cd374f8244d86bbf238b6f7ab9f20&quot;&gt;然而，问题依旧，一时间又没了头绪，我开始漫无目的重新浏览 Sentry 中的错误堆栈以及相关变量。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-2c0cbf6be3564463a1d3f5c7c359cf03&quot; data-id=&quot;2c0cbf6be3564463a1d3f5c7c359cf03&quot;&gt;&lt;span&gt;&lt;div id=&quot;2c0cbf6be3564463a1d3f5c7c359cf03&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#2c0cbf6be3564463a1d3f5c7c359cf03&quot; title=&quot;蛛丝马迹&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;蛛丝马迹&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-edebeefb4a5a4e5fbd8cc7b18d985e42&quot;&gt;无意间，发现在代码中，我们尝试向队列中存储一大段 pickle 过的对象数据，而这些变量在 Sentry 中已经长到无法完整显示而被省略了。&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;
any_task&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;apply_async&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;headers&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;something_big&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-fe84bd6e13c6414b8ac71a4179eb4bb2&quot;&gt;这个问题立马引起了我们的注意🤔，很有可能是这个数据过大而引起写入异常。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-7a1416bab27641539543f1403efffbe1&quot; data-id=&quot;7a1416bab27641539543f1403efffbe1&quot;&gt;&lt;span&gt;&lt;div id=&quot;7a1416bab27641539543f1403efffbe1&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#7a1416bab27641539543f1403efffbe1&quot; title=&quot;破案&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;破案&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-603942a46c0e440c90c00e051afc6b61&quot;&gt;照此思路，经过一番网络冲浪，发现了类似的问题：&lt;/div&gt;&lt;div class=&quot;notion-row&quot;&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-bookmark notion-block-836f467d848d4649920834343af991d9&quot; href=&quot;https://stackoverflow.com/questions/30716002/is-there-a-size-limit-on-a-rabbitmq-message-header&quot;&gt;&lt;div&gt;&lt;div class=&quot;notion-bookmark-title&quot;&gt;stackoverflow.com&lt;/div&gt;&lt;div class=&quot;notion-bookmark-link&quot;&gt;&lt;div&gt;https://stackoverflow.com/questions/30716002/is-there-a-size-limit-on-a-rabbitmq-message-header&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/a&gt;&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-f4e372a376ca4c9aa097e6d90f2e0571&quot;&gt;这时候，再去反查 RabbitMQ 的日志，果然有对应内容：&lt;/div&gt;&lt;pre class=&quot;notion-code language-plain text&quot;&gt;&lt;code class=&quot;language-plain text&quot;&gt;&lt;span class=&quot;token number&quot;&gt;2021&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;19&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;49&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;32.098&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;error&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0.3894&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;.1636&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; Error on &lt;span class=&quot;token constant&quot;&gt;AMQP&lt;/span&gt; connection &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0.3894&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;.1636&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;59823&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5672&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;vhost&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#x27;foo&#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#x27;foo&#x27;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; running&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; channel &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
 operation none caused a connection exception frame_error&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;type 2, all octets = &amp;lt;&amp;lt;&gt;&gt;: {frame_too_large,245629,131064}&quot;&lt;/span&gt;

&lt;span class=&quot;token number&quot;&gt;2021&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;19&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;49&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;35.099&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;error&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0.3894&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;.1636&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; closing &lt;span class=&quot;token constant&quot;&gt;AMQP&lt;/span&gt; connection &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0.3894&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;.1636&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;59823&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5672&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
fatal_frame_error&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-6bf413a4480d4f3a8d9c025ef425f80f&quot;&gt;这里非常明确地指出了，由于我们传递的 frame 大小(&lt;span class=&quot;notion-pink&quot;&gt;245629 bytes&lt;/span&gt;) 大于默认的 &lt;span class=&quot;notion-teal&quot;&gt;131064 + 8(frame header) bytes (128KB)&lt;/span&gt;，所以 RabbitMQ 关闭了连接。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-e2a33f338c1445b79c42d0afc87e057d&quot;&gt;于是我们立即着手，精简了向 &lt;code class=&quot;notion-inline-code&quot;&gt;headers&lt;/code&gt; 传送的数据，重新发布后，终于一切归于正常。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-dc2f5dc2fec34667b5c0ed688a5ad257&quot; data-id=&quot;dc2f5dc2fec34667b5c0ed688a5ad257&quot;&gt;&lt;span&gt;&lt;div id=&quot;dc2f5dc2fec34667b5c0ed688a5ad257&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#dc2f5dc2fec34667b5c0ed688a5ad257&quot; title=&quot;梳理&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;梳理&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-e3c48e89946647c1831ebefdda992ae3&quot;&gt;虽然问题已经得到了解决，但是仍旧需要补齐一下相关知识的短板。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-61e5471f5bcb4261be4d867e4f2e9aa7&quot;&gt;首先，让我们再来简单看看&lt;b&gt; AMQP &lt;/b&gt; &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://www.rabbitmq.com/resources/specs/amqp0-9-1.pdf&quot;&gt;0.9.1 版本&lt;/a&gt; &lt;b&gt;协议有关这部分的内容&lt;/b&gt;。&lt;/div&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-9723aa5f81bb41e391e1f1151f551a9f&quot; data-id=&quot;9723aa5f81bb41e391e1f1151f551a9f&quot;&gt;&lt;span&gt;&lt;div id=&quot;9723aa5f81bb41e391e1f1151f551a9f&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#9723aa5f81bb41e391e1f1151f551a9f&quot; title=&quot;AMQP 协议&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;AMQP 协议&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;div class=&quot;notion-text notion-block-01c08f9939e245b592f65d2bcb7ad82c&quot;&gt;这是协议中所有 TCP/IP 帧组成&lt;/div&gt;&lt;pre class=&quot;notion-code language-plain text&quot;&gt;&lt;code class=&quot;language-plain text&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;      &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;         &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;         &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;                 size&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt; size&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; type &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; channel &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;   size  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;   payload   &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; frame&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;end &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
 octet    short      long      &lt;span class=&quot;token string&quot;&gt;&#x27;size&#x27;&lt;/span&gt; octets     octet&lt;/code&gt;&lt;/pre&gt;&lt;figcaption class=&quot;notion-asset-caption&quot;&gt;General Frame Format&lt;/figcaption&gt;&lt;div class=&quot;notion-text notion-block-5827cff6f99e46808af91cff5775984a&quot;&gt;其中有这么几个关键信息：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-9af4994f707f4d3198e771aeccdac8fd&quot;&gt;&lt;li&gt;0-7 bytes 确定了帧的类型和具体的 channel，确定了类型后将会处理 payload&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-acb5e1e906eb49b489d81b429513a796&quot;&gt;&lt;li&gt;payload 的大小在协议中并没有规定，而是说的是可以通过客户端和服务端的”协商“确定(page 22)&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-390c2b197597418ebdcf846a85bda9fb&quot;&gt;&lt;li&gt;不同类型帧有着不同的 payload 构成&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-text notion-block-a081e54c2a7c4d89bc208e8629086ecc&quot;&gt;当前问题主要是传递应用数据的场景下，所以我们来看具体承载的 Content 帧&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-07bf41aad49f47fc80c8a12325e83a9f&quot;&gt;简单点来说，Content 帧就是一系列的 properties 加上二进制的数据部分。这些 properties 将会组成 &amp;quot;content header frame&amp;quot;，它大概是这样的组成：&lt;/div&gt;&lt;pre class=&quot;notion-code language-plain text&quot;&gt;&lt;code class=&quot;language-plain text&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;          &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;        &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;           &lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;               &lt;span class=&quot;token number&quot;&gt;14&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;id &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; weight &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; body size &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; property flags &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; property list&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;
    short    short    long long        short        remainder&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-0dca7c859bee420589ced554d4f85e43&quot;&gt;也就是在我们的 celery 代码中， &lt;code class=&quot;notion-inline-code&quot;&gt;headers=(...)&lt;/code&gt; 传递的内容将会被塞入 property list 中，在协议中并没有明确具体的大小限制，同时没有表明会做的分块(content body 部分是会的)，所以当前产生的问题限制，主要受制于 RabbitMQ 的具体实现。&lt;/div&gt;&lt;a style=&quot;width:100%&quot; href=&quot;https://blog.rabbitmq.com/posts/2012/11/breaking-things-with-rabbitmq-3-0/&quot; target=&quot;blank_&quot;&gt;&lt;figure class=&quot;notion-asset-wrapper notion-asset-wrapper-image notion-block-18bd8584c6e04a5b874d660b84a9aa41&quot;&gt;&lt;div style=&quot;position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%&quot;&gt;&lt;img style=&quot;object-fit:contain&quot; src=&quot;https://www.notion.so/image/https%3A%2F%2Fs3.us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F13faba46-c644-41e9-80b1-cdb3fb4659ad%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45EIPT3X45%252F20221018%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20221018T100704Z%26X-Amz-Expires%3D86400%26X-Amz-Signature%3D4410aeee25110119b86407f6b2a98d3ee57eb61d7d1b267f8977c863cc8d624f%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject?table=block&amp;amp;id=18bd8584-c6e0-4a5b-874d-660b84a9aa41&amp;amp;cache=v2&quot; loading=&quot;lazy&quot; alt=&quot;https://blog.rabbitmq.com/posts/2012/11/breaking-things-with-rabbitmq-3-0/&quot; decoding=&quot;async&quot;/&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/a&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-59829334ff524b7088f05a5edaa97b62&quot; data-id=&quot;59829334ff524b7088f05a5edaa97b62&quot;&gt;&lt;span&gt;&lt;div id=&quot;59829334ff524b7088f05a5edaa97b62&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#59829334ff524b7088f05a5edaa97b62&quot; title=&quot;三点感悟&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;三点感悟&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-0692431de3bf494bbcfaf7eb798dcdde&quot;&gt;&lt;li&gt;&lt;b&gt;错误监测非常重要&lt;/b&gt;。如果没有 Sentry，问题的定位可能会更加困难，多耗几天精力也未可知。&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-ebefa435969a4d8aac3bd6a6730d457b&quot;&gt;&lt;li&gt;&lt;b&gt;要善于利用不同组件的优势&lt;/b&gt;。之所以一开始使用 Redis 而不是 RabbitMQ，更多是从运营维护的角度出发，在公司内部 Redis 有更完善的基建基础，而 RabbitMQ 的运维更加复杂。但是遇到像这样幽灵般的问题时，RabbitMQ 反而更有优势，完善的流程更容易暴露问题。&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-b4f62d66ce704d938ac544e6dce65dcf&quot;&gt;&lt;li&gt;&lt;b&gt;要适当地了解重点依赖的技术细节&lt;/b&gt;。大多数场景下，简单地使用协议就足够了，而在一些边缘场景中，则更看重技术人员对细节的把控。这类属于重要不紧急的事情，应该定时拿出来有意识去做，虽无近用，却有远益。&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-blank notion-block-e3b1fcaa802046a1ab9e5f2c4f518a22&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-ef7b0aac6baf4b63a07c50093c208254&quot;&gt;参考：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-7dcaa094a6db4402a8894c00ccb96770&quot;&gt;&lt;li&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://www.rabbitmq.com/resources/specs/amqp0-9-1.pdf&quot;&gt;https://www.rabbitmq.com/resources/specs/amqp0-9-1.pdf&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-1e5cb10672c046219ff3b369a125183b&quot;&gt;&lt;li&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://john.eckersberg.com/debugging-rabbitmq-frame_too_large-error.html&quot;&gt;https://john.eckersberg.com/debugging-rabbitmq-frame_too_large-error.html&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-bfb28b545f674bcea5b3bdf1c9959814&quot;&gt;&lt;li&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://stackoverflow.com/questions/30716002/is-there-a-size-limit-on-a-rabbitmq-message-header&quot;&gt;https://stackoverflow.com/questions/30716002/is-there-a-size-limit-on-a-rabbitmq-message-header&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-416d48d7c02546b097551ec6ca3e5552&quot;&gt;&lt;li&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://www.rabbitmq.com/amqp-0-9-1-errata.html#section_11&quot;&gt;https://www.rabbitmq.com/amqp-0-9-1-errata.html#section_11&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-blank notion-block-4d750428c0ef4db09420bab4eabfcffe&quot;&gt; &lt;/div&gt;&lt;/main&gt;]]&gt;&lt;/content&gt;
    &lt;/entry&gt;
    &lt;entry&gt;
        &lt;title type=&quot;html&quot;&gt;&lt;![CDATA[一些 Helm 最(tòng)佳(kǔ)实践]]&gt;&lt;/title&gt;
        &lt;id&gt;https://next.emergencyexit.xyz//helm-pratices&lt;/id&gt;
        &lt;link href=&quot;https://next.emergencyexit.xyz//helm-pratices&quot;/&gt;
        &lt;updated&gt;2021-09-01T00:00:00.000Z&lt;/updated&gt;
        &lt;summary type=&quot;html&quot;&gt;&lt;![CDATA[标题的 emoji 就是我对 Helm 的评价]]&gt;&lt;/summary&gt;
        &lt;content type=&quot;html&quot;&gt;&lt;![CDATA[&lt;main class=&quot;notion light-mode notion-page notion-block-692194e608d34e36a94fdc403d6226e6&quot;&gt;&lt;div class=&quot;notion-viewport&quot;&gt;&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-b9fcb6ecf13e45ec9ccc108cfa563a9c&quot;&gt; &lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-2f89a200d0aa4f0da16f6b08342f5197&quot; data-id=&quot;2f89a200d0aa4f0da16f6b08342f5197&quot;&gt;&lt;span&gt;&lt;div id=&quot;2f89a200d0aa4f0da16f6b08342f5197&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#2f89a200d0aa4f0da16f6b08342f5197&quot; title=&quot;yaml工程师的血泪 shi&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;&lt;code class=&quot;notion-inline-code&quot;&gt;yaml&lt;/code&gt;工程师的血泪 shi&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-be1a0c200df8465293f7023588c8c7dc&quot; data-id=&quot;be1a0c200df8465293f7023588c8c7dc&quot;&gt;&lt;span&gt;&lt;div id=&quot;be1a0c200df8465293f7023588c8c7dc&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#be1a0c200df8465293f7023588c8c7dc&quot; title=&quot;子 Chart 使用中划线时无法作为参数路径选取&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;子 Chart 使用中划线时无法作为参数路径选取&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;pre class=&quot;notion-code language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;# values&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;yaml
sub&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;foo&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;chart&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;preferName&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Happy&quot;&lt;/span&gt;

# _helper&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tpl
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Values&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sub&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;foo&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;chart&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;preferName &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; ❌ 错误写法

&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; index &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Values &lt;span class=&quot;token string&quot;&gt;&quot;sub-foo-chart&quot;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;preferName&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; 💩 正确但丑陋的写法&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-row&quot;&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-bookmark notion-block-753e263d13114c8baeb1ea5f172224cb&quot; href=&quot;https://github.com/helm/helm/issues/2192&quot;&gt;&lt;div&gt;&lt;div class=&quot;notion-bookmark-title&quot;&gt;Accessing values of the subchart with dash in the name · Issue #2192 · helm/helm&lt;/div&gt;&lt;div class=&quot;notion-bookmark-description&quot;&gt;Based on the docs, there is a convention to name charts with dashes. But at the same time based on this doc, you should never have values with dashes. So, let&amp;#x27;s say I have 2 dependent charts: gitlab and gitlab-runner. How can I configure...&lt;/div&gt;&lt;div class=&quot;notion-bookmark-link&quot;&gt;&lt;img src=&quot;https://github.com/favicon.ico&quot; alt=&quot;Accessing values of the subchart with dash in the name · Issue #2192 · helm/helm&quot; loading=&quot;lazy&quot;/&gt;&lt;div&gt;https://github.com/helm/helm/issues/2192&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-bookmark-image&quot;&gt;&lt;img src=&quot;https://opengraph.githubassets.com/bfc0bd61b92c77a24e09f20dd5af7c1b948be1bdd5f1e6bef8a643e4f1be3a67/helm/helm/issues/2192&quot; alt=&quot;Accessing values of the subchart with dash in the name · Issue #2192 · helm/helm&quot; loading=&quot;lazy&quot;/&gt;&lt;/div&gt;&lt;/a&gt;&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-8294e02306dc494d965321332084ebf2&quot;&gt; &lt;/div&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-f5210e6ca3ce4672baef5771b60122e4&quot; data-id=&quot;f5210e6ca3ce4672baef5771b60122e4&quot;&gt;&lt;span&gt;&lt;div id=&quot;f5210e6ca3ce4672baef5771b60122e4&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#f5210e6ca3ce4672baef5771b60122e4&quot; title=&quot;Chart 之间的继承关系只能有一级&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;Chart 之间的继承关系只能有一级&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;div class=&quot;notion-text notion-block-7ccedd92cd344cc28792052af901bc27&quot;&gt;所有的依赖关系必须简化成两层&lt;/div&gt;&lt;pre class=&quot;notion-code language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;# parentchart&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;requirements&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;yaml
&lt;span class=&quot;token literal-property property&quot;&gt;dependencies&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; name&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; childchart
    &lt;span class=&quot;token literal-property property&quot;&gt;repository&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; http&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;localhost&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10191&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.1&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;.0&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;condition&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; childchart&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;enabled

# childchart&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;requirements&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;yaml
&lt;span class=&quot;token literal-property property&quot;&gt;dependencies&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; name&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; grandchildchart
    &lt;span class=&quot;token literal-property property&quot;&gt;repository&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; http&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;localhost&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10191&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.1&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;.0&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;condition&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; grandchildchart1&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;enabled&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;childchart&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;grandchildchart&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;enabled

# parentchart&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;values&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;yaml
&lt;span class=&quot;token literal-property property&quot;&gt;childchart&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;grandchildchart&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;enabled&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;  ❌ 并不能够生效&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-row&quot;&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-bookmark notion-block-d09a4715e5b64c9591f6ed61f316712f&quot; href=&quot;https://github.com/helm/helm/issues/5135&quot;&gt;&lt;div&gt;&lt;div class=&quot;notion-bookmark-title&quot;&gt;Nested sub charts values · Issue #5135 · helm/helm&lt;/div&gt;&lt;div class=&quot;notion-bookmark-description&quot;&gt;You can&amp;#x27;t perform that action at this time. You signed in with another tab or window. You signed out in another tab or window. Reload to refresh your session. Reload to refresh your session.&lt;/div&gt;&lt;div class=&quot;notion-bookmark-link&quot;&gt;&lt;img src=&quot;https://github.com/favicon.ico&quot; alt=&quot;Nested sub charts values · Issue #5135 · helm/helm&quot; loading=&quot;lazy&quot;/&gt;&lt;div&gt;https://github.com/helm/helm/issues/5135&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-bookmark-image&quot;&gt;&lt;img src=&quot;https://opengraph.githubassets.com/2acc1c0f82187220a5dec781e9bc6a86e7417d3b96ab5ce3dd32241264277fa3/helm/helm/issues/5135&quot; alt=&quot;Nested sub charts values · Issue #5135 · helm/helm&quot; loading=&quot;lazy&quot;/&gt;&lt;/div&gt;&lt;/a&gt;&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-b0bea53b8ff94841b76d8ef0a34be617&quot;&gt; &lt;/div&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-77ed95e367b14e8b90ea4c0161fe21fa&quot; data-id=&quot;77ed95e367b14e8b90ea4c0161fe21fa&quot;&gt;&lt;span&gt;&lt;div id=&quot;77ed95e367b14e8b90ea4c0161fe21fa&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#77ed95e367b14e8b90ea4c0161fe21fa&quot; title=&quot;Hook 创建的资源不能被 uninstall&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;Hook 创建的资源不能被 uninstall&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;pre class=&quot;notion-code language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;annotations&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
	&lt;span class=&quot;token string-property property&quot;&gt;&quot;helm.sh/hook&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;pre-install&quot;&lt;/span&gt;
  &lt;span class=&quot;token string-property property&quot;&gt;&quot;helm.sh/hook-weight&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-1&quot;&lt;/span&gt;
  &lt;span class=&quot;token string-property property&quot;&gt;&quot;helm.sh/hook-delete-policy&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; hook&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;failed&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;before&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;hook&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;creation&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-d98735ecd5d4450481862ed7027ee902&quot;&gt;类似这样通过 helm hook 创建出来的资源，是不能够被 &lt;code class=&quot;notion-inline-code&quot;&gt;helm uninstall&lt;/code&gt; 删除的。如果只是用来做一些临时任务当然问题不大，但是我们利用了 hook 创建了一些内建存储，所以无法删除的特性会带来大量的无用存储资源占用，非常头疼。&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-53c2a890dd814d378430b75dfba62485&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-0f9f00ceda3c4ed78774e1eb76bf155c&quot;&gt;可以通过 label 统一删除，一个临时的 workaround 💩：&lt;/div&gt;&lt;pre class=&quot;notion-code language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;kubectl &lt;span class=&quot;token keyword&quot;&gt;delete&lt;/span&gt; deploy&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;sts&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;cronjob&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;pod&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;svc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;ingress&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;secret&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;cm&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;sa&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;pvc &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;n $&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;NAMESPACE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;l app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;kubernetes&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;io&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;instance&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;$&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;RELEASE_NAME&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-row&quot;&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-bookmark notion-block-5054a00d00ee4960b160a65906fcb1a2&quot; href=&quot;https://github.com/helm/helm/issues/9206&quot;&gt;&lt;div&gt;&lt;div class=&quot;notion-bookmark-title&quot;&gt;Manifests with hooks not getting deleted during helm uninstall · Issue #9206 · helm/helm&lt;/div&gt;&lt;div class=&quot;notion-bookmark-description&quot;&gt;tomcruise81 changed the title PodDisruptionBudget with hooks not getting deleted during helm uninstall Hooks not getting deleted during helm uninstall Jan 8, 2021 tomcruise81 changed the title Hooks not getting deleted during helm uninstall Manifests with hooks not getting deleted during helm uninstall Jan 8, 2021 You can&amp;#x27;t perform that action at this time.&lt;/div&gt;&lt;div class=&quot;notion-bookmark-link&quot;&gt;&lt;img src=&quot;https://github.com/favicon.ico&quot; alt=&quot;Manifests with hooks not getting deleted during helm uninstall · Issue #9206 · helm/helm&quot; loading=&quot;lazy&quot;/&gt;&lt;div&gt;https://github.com/helm/helm/issues/9206&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-bookmark-image&quot;&gt;&lt;img src=&quot;https://opengraph.githubassets.com/d56b0963c9d3fd8e0e9035dff30b12ddcc65b9ea136bb3e600ef428bb7aa7f31/helm/helm/issues/9206&quot; alt=&quot;Manifests with hooks not getting deleted during helm uninstall · Issue #9206 · helm/helm&quot; loading=&quot;lazy&quot;/&gt;&lt;/div&gt;&lt;/a&gt;&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-0ec7e3aa50f94be6ba7bc47b62f7cd79&quot;&gt; &lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-55acbb4404c7441a843cc3bf8d644594&quot; data-id=&quot;55acbb4404c7441a843cc3bf8d644594&quot;&gt;&lt;span&gt;&lt;div id=&quot;55acbb4404c7441a843cc3bf8d644594&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#55acbb4404c7441a843cc3bf8d644594&quot; title=&quot;一些苦中作乐的解决方案&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;一些苦中作乐的解决方案&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-blank notion-block-10728219884d423aa0712f69282089e7&quot;&gt; &lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-71917a09e0634f8dbf4e92909aa32e16&quot; data-id=&quot;71917a09e0634f8dbf4e92909aa32e16&quot;&gt;&lt;span&gt;&lt;div id=&quot;71917a09e0634f8dbf4e92909aa32e16&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#71917a09e0634f8dbf4e92909aa32e16&quot; title=&quot;为多个项目模块创建统一的库&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;为多个项目模块创建统一的库&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-3f59efe5595a4a8fb688c2215c160c73&quot;&gt;如果项目中存在多个模块，那么可以通过 subChart 方式统一整合&lt;/div&gt;&lt;pre class=&quot;notion-code language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; v2
&lt;span class=&quot;token literal-property property&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; bk&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;user&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;stack
&lt;span class=&quot;token literal-property property&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;A&lt;/span&gt; Helm chart &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; bk&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;user
&lt;span class=&quot;token literal-property property&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; application
&lt;span class=&quot;token literal-property property&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;.1&lt;/span&gt;
&lt;span class=&quot;token literal-property property&quot;&gt;appVersion&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; v2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3.0&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;a2

&lt;span class=&quot;token literal-property property&quot;&gt;dependencies&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; name&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; bkuserapi
  &lt;span class=&quot;token literal-property property&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;1.0.0&quot;&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;repository&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;file://../api&quot;&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;condition&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; bkuserapi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;enabled

&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; name&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; bkusersaas
  &lt;span class=&quot;token literal-property property&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;1.0.0&quot;&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;repository&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;file://../saas&quot;&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;condition&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; bkusersaas&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;enabled

&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; name&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; mariadb
  &lt;span class=&quot;token literal-property property&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;9.x.x&quot;&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;repository&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;https://charts.bitnami.com/bitnami&quot;&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;condition&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; mariadb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;enabled

&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; name&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; redis
  &lt;span class=&quot;token literal-property property&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;14.x.x&quot;&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;repository&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;https://charts.bitnami.com/bitnami&quot;&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;condition&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; redis&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;enabled&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-48903da852ff4654bebcb266ac18a56d&quot;&gt;由于 &lt;code class=&quot;notion-inline-code&quot;&gt;bkuserapi&lt;/code&gt; 和 &lt;code class=&quot;notion-inline-code&quot;&gt;bkusersaas&lt;/code&gt; 都有类似的架构，所以重复为二者创建 Helm Chart 一定不是明智的选择。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-389b779cb9d24de79409e2838cde401a&quot;&gt;我们针对这种 &lt;code class=&quot;notion-inline-code&quot;&gt;web&lt;/code&gt; 类型的应用&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/TencentBlueKing/bk-user/tree/master/deploy/helm/chartty&quot;&gt;多封装了一层&lt;/a&gt;，能够一定程度上减少重复劳动。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-5deb5080863d43b8adb1bbcdc9adf9f1&quot;&gt;可以通过自定义的 &lt;code class=&quot;notion-inline-code&quot;&gt;processes&lt;/code&gt; 变量完成对于 workload 的定义和封装：&lt;/div&gt;&lt;pre class=&quot;notion-code language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;# 定义应用内的多个进程
&lt;span class=&quot;token literal-property property&quot;&gt;processes&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;web&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;ingress&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;enabled&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;bkuser-api.{{ .Values.global.sharedDomain }}&quot;&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;/&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;replicas&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;resources&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;limits&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token literal-property property&quot;&gt;cpu&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; 1024m
        &lt;span class=&quot;token literal-property property&quot;&gt;memory&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; 1024Mi
      &lt;span class=&quot;token literal-property property&quot;&gt;requests&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token literal-property property&quot;&gt;cpu&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; 200m
        &lt;span class=&quot;token literal-property property&quot;&gt;memory&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; 128Mi
    &lt;span class=&quot;token literal-property property&quot;&gt;readinessProbe&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;tcpSocket&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token literal-property property&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8000&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;initialDelaySeconds&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;periodSeconds&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;livenessProbe&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;httpGet&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token literal-property property&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;ping
        &lt;span class=&quot;token literal-property property&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; http
      &lt;span class=&quot;token literal-property property&quot;&gt;initialDelaySeconds&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;periodSeconds&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;celery&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;replicas&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; bash
    &lt;span class=&quot;token literal-property property&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;app&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;start_celery&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sh
  &lt;span class=&quot;token literal-property property&quot;&gt;beat&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;replicas&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; bash
    &lt;span class=&quot;token literal-property property&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;app&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;start_beat&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sh&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-bd9828d26e8646299268870c66857d6f&quot;&gt;具体内容可以参考 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/TencentBlueKing/bk-user&quot;&gt;TencentBlueking/bk-user&lt;/a&gt; 的&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/TencentBlueKing/bk-user/tree/master/deploy&quot;&gt;部署配置&lt;/a&gt;，结合 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/TencentBlueKing/bk-user/blob/master/Makefile&quot;&gt;&lt;code class=&quot;notion-inline-code&quot;&gt;Makefile&lt;/code&gt;&lt;/a&gt; 可以实现一件部署\卸载，一定程度上缓解了 Helm 设计弊病带来的不便。&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-f17074b08ac04df2b7195042e95bfde2&quot;&gt; &lt;/div&gt;&lt;/main&gt;]]&gt;&lt;/content&gt;
    &lt;/entry&gt;
    &lt;entry&gt;
        &lt;title type=&quot;html&quot;&gt;&lt;![CDATA[再见 Helm，你好 CUE]]&gt;&lt;/title&gt;
        &lt;id&gt;https://next.emergencyexit.xyz//cue-vs-helm&lt;/id&gt;
        &lt;link href=&quot;https://next.emergencyexit.xyz//cue-vs-helm&quot;/&gt;
        &lt;updated&gt;2021-06-22T00:00:00.000Z&lt;/updated&gt;
        &lt;summary type=&quot;html&quot;&gt;&lt;![CDATA[长江后浪推前浪]]&gt;&lt;/summary&gt;
        &lt;content type=&quot;html&quot;&gt;&lt;![CDATA[&lt;main class=&quot;notion light-mode notion-page notion-block-29fc49e0b5974f2e9d53b7dd247adf4b&quot;&gt;&lt;div class=&quot;notion-viewport&quot;&gt;&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-cee3d36736784353b735b94e70aae135&quot; data-id=&quot;cee3d36736784353b735b94e70aae135&quot;&gt;&lt;span&gt;&lt;div id=&quot;cee3d36736784353b735b94e70aae135&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#cee3d36736784353b735b94e70aae135&quot; title=&quot;什么是 CUE &quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;什么是 CUE &lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;blockquote class=&quot;notion-quote notion-block-93713b54067e4d4d8fd5545ceafef31d&quot;&gt;CUE 是一种开源数据验证语言和推理引擎，其根源在于逻辑编程&lt;/blockquote&gt;&lt;div class=&quot;notion-text notion-block-23670d28c3264f668879dc43957ecc39&quot;&gt;说实话，我一开始也没看懂这句描述。我们先来看个小例子：&lt;/div&gt;&lt;div class=&quot;notion-row notion-block-cae7abf2157a4a958f807af5d39f5d74&quot;&gt;&lt;div class=&quot;notion-column notion-block-bdc687866d83412db46e4f4e1e2bf19d&quot; style=&quot;width:calc((100% - (2 * min(32px, 4vw))) * 0.33333333333333337)&quot;&gt;&lt;div class=&quot;notion-text notion-block-5d0d8b148df94f75afc8a87c406f1fd1&quot;&gt;Data&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;div class=&quot;notion-column notion-block-9590d8c1563e4e47b47a3f5c28213eac&quot; style=&quot;width:calc((100% - (2 * min(32px, 4vw))) * 0.33333333333333337)&quot;&gt;&lt;div class=&quot;notion-text notion-block-5aa9bb2472764b88b56fe7e5e6dc669a&quot;&gt;Schema&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;div class=&quot;notion-column notion-block-9cd9597644984f859723306e3c59a763&quot; style=&quot;width:calc((100% - (2 * min(32px, 4vw))) * 0.3333333333333333)&quot;&gt;&lt;div class=&quot;notion-text notion-block-03ee002f73a548968ed4c1145a85dda7&quot;&gt;CUE&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-row notion-block-8c6214435c474c919da623ccf2f0ad43&quot;&gt;&lt;div class=&quot;notion-column notion-block-36219f7a636c46db92ad53105e6e7e82&quot; style=&quot;width:calc((100% - (2 * min(32px, 4vw))) * 0.33333333333333337)&quot;&gt;&lt;pre class=&quot;notion-code language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;moscow&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;    &lt;span class=&quot;token string&quot;&gt;&quot;Moscow&quot;&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;pop&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;     &lt;span class=&quot;token number&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;92M
  &lt;span class=&quot;token literal-property property&quot;&gt;capital&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;div class=&quot;notion-column notion-block-a107bd2b6297400194e47487a70a43cd&quot; style=&quot;width:calc((100% - (2 * min(32px, 4vw))) * 0.33333333333333337)&quot;&gt;&lt;pre class=&quot;notion-code language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;municipality&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;    string
  &lt;span class=&quot;token literal-property property&quot;&gt;pop&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;     int
  &lt;span class=&quot;token literal-property property&quot;&gt;capital&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; bool
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;div class=&quot;notion-column notion-block-1cc796762de7497a964b3a198fc0e0c8&quot; style=&quot;width:calc((100% - (2 * min(32px, 4vw))) * 0.3333333333333333)&quot;&gt;&lt;pre class=&quot;notion-code language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;largeCapital&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;    string
  &lt;span class=&quot;token literal-property property&quot;&gt;pop&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;     &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;5M
  &lt;span class=&quot;token literal-property property&quot;&gt;capital&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-b27f8ba6b225468d86d2df217ce99943&quot;&gt;在定义 JSON 数据时，我们通常会将 Data 和 Schema 分开处理。而 CUE 则将二者结合在一起，既可以指定数据字段类型，也可以直接填写具体值，也就是 CUE 并不会特意地区分 “类型” 和 “值”， &lt;code class=&quot;notion-inline-code&quot;&gt;string&lt;/code&gt; 和 &lt;code class=&quot;notion-inline-code&quot;&gt;&amp;quot;Moscow&amp;quot;&lt;/code&gt; 都会被当作值 ，但是二者之间有包含的先后顺序，在这里 &lt;code class=&quot;notion-inline-code&quot;&gt;&amp;quot;Moscow&amp;quot;&lt;/code&gt; 可以背归纳于 &lt;code class=&quot;notion-inline-code&quot;&gt;string&lt;/code&gt; 的一种，那么 &lt;code class=&quot;notion-inline-code&quot;&gt;string&lt;/code&gt; 在格(lattice)中会优先于 &lt;code class=&quot;notion-inline-code&quot;&gt;&amp;quot;Moscow&amp;quot;&lt;/code&gt; 。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-ce8295f9201c4044901fde22c24da2e4&quot;&gt;更多关于 CUE 的介绍，可以通过 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://cuelang.org/docs/&quot;&gt;官方文档&lt;/a&gt; 和 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/cuelang/cue/blob/master/doc/ref/spec.md&quot;&gt;定义&lt;/a&gt; 了解过多，这里就不展开了。&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-23c5e5877a1b40cfbb5565ceec5d59fd&quot; data-id=&quot;23c5e5877a1b40cfbb5565ceec5d59fd&quot;&gt;&lt;span&gt;&lt;div id=&quot;23c5e5877a1b40cfbb5565ceec5d59fd&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#23c5e5877a1b40cfbb5565ceec5d59fd&quot; title=&quot;使用 CUE 做模版渲染&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;使用 CUE 做模版渲染&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-5701749373fe49fc90bd4bbddfdad9b9&quot;&gt;CUE 有&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://cuelang.org/docs/usecases/&quot;&gt;很多很酷的使用场景&lt;/a&gt;，而先让我们关注其中的配置文件渲染能力。&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-813bf42ff6b14b3fa56e2cbd0132e95c&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-99d6d1fd68744bb2a4d815f7faab754c&quot;&gt;我们在这里借用 &lt;code class=&quot;notion-inline-code&quot;&gt;KubeVela&lt;/code&gt; &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://kubevela.io/docs/platform-engineers/cue/trait#using-cue-as-trait-schematic&quot;&gt;文档中的例子&lt;/a&gt;&lt;/div&gt;&lt;pre class=&quot;notion-code language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;parameter&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;domain&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; string
      &lt;span class=&quot;token literal-property property&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;string&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; int
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// trait template can have multiple outputs in one trait&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;outputs&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; service&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;v1&quot;&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;       &lt;span class=&quot;token string&quot;&gt;&quot;Service&quot;&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token literal-property property&quot;&gt;selector&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
              &lt;span class=&quot;token literal-property property&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name
          &lt;span class=&quot;token literal-property property&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
              &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; k&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; v &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; parameter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;http &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                  &lt;span class=&quot;token literal-property property&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;       v
                  &lt;span class=&quot;token literal-property property&quot;&gt;targetPort&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; v
              &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token literal-property property&quot;&gt;outputs&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; ingress&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;networking.k8s.io/v1beta1&quot;&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;       &lt;span class=&quot;token string&quot;&gt;&quot;Ingress&quot;&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token literal-property property&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name
      &lt;span class=&quot;token literal-property property&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token literal-property property&quot;&gt;rules&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
              &lt;span class=&quot;token literal-property property&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; parameter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;domain
              &lt;span class=&quot;token literal-property property&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                  &lt;span class=&quot;token literal-property property&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
                      &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; k&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; v &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; parameter&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;http &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                          &lt;span class=&quot;token literal-property property&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; k
                          &lt;span class=&quot;token literal-property property&quot;&gt;backend&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                              &lt;span class=&quot;token literal-property property&quot;&gt;serviceName&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name
                              &lt;span class=&quot;token literal-property property&quot;&gt;servicePort&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; v
                          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
                      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                  &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
              &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-f8746dd32b484b7bb77bcd730761af68&quot;&gt;可以看到，只需要传入 &lt;code class=&quot;notion-inline-code&quot;&gt;parameter&lt;/code&gt; ，就可以得到包含 &lt;code class=&quot;notion-inline-code&quot;&gt;Service&lt;/code&gt; 和 &lt;code class=&quot;notion-inline-code&quot;&gt;Ingress&lt;/code&gt; 的 &lt;code class=&quot;notion-inline-code&quot;&gt;output&lt;/code&gt; 。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-71a44bc81b3b4c4ebf936a1e1c58159d&quot;&gt;这样的写法立刻让我们想到了一个类似的工具—— &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/helm/helm&quot;&gt;Helm&lt;/a&gt;，作为较早的 CNCF 毕业项目，Helm 已经慢慢演进成在 k8s 配置定义领域的事实意义上的工业标准。那么相较于 Helm，用 CUE 来写配置文件渲染，又有什么异同呢？&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-5d00daa945db42608448bda03b815c2b&quot; data-id=&quot;5d00daa945db42608448bda03b815c2b&quot;&gt;&lt;span&gt;&lt;div id=&quot;5d00daa945db42608448bda03b815c2b&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#5d00daa945db42608448bda03b815c2b&quot; title=&quot;CUE vs Helm&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;CUE vs Helm&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-989008d01b664635b96d2dc42f9e7a9a&quot;&gt;最直观的感受就是，在模版编写上 CUE 比 Helm 流畅太多了。主要的原因二者在最初的设计思路差异，Helm &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://helm.sh/docs/chart_template_guide/functions_and_pipelines/&quot;&gt;借助的是 Go 和 Spring 的&lt;/a&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://helm.sh/docs/chart_template_guide/functions_and_pipelines/&quot;&gt;&lt;b&gt;纯文本渲染能力&lt;/b&gt;&lt;/a&gt;，而对于 CUE，JSON 才是一等公民。所以在 K8S 这类 yaml（JSON 超集） 文件渲染上，CUE（也是 JSON 超集） 拥有天然的优势。&lt;/div&gt;&lt;blockquote class=&quot;notion-quote notion-block-e9405b964f2c42f286fe9f7a0d6b8e2c&quot;&gt;Talk is cheap， show me the code.&lt;/blockquote&gt;&lt;div class=&quot;notion-text notion-block-88029b498f7c4e97bbe5214631cfeafc&quot;&gt;我们一起来看几个常用的场景。&lt;/div&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-031ba65fcac24aa2b36de15636aa056f&quot; data-id=&quot;031ba65fcac24aa2b36de15636aa056f&quot;&gt;&lt;span&gt;&lt;div id=&quot;031ba65fcac24aa2b36de15636aa056f&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#031ba65fcac24aa2b36de15636aa056f&quot; title=&quot;Named Templates&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;Named Templates&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;div class=&quot;notion-row notion-block-9cf427e0baa84f1c8dddb87577625c37&quot;&gt;&lt;div class=&quot;notion-column notion-block-b241cd7038c34a49875649595afad489&quot; style=&quot;width:calc((100% - (1 * min(32px, 4vw))) * 0.5)&quot;&gt;&lt;div class=&quot;notion-text notion-block-21b01c95bc74473a874a93c14502279c&quot;&gt;&lt;b&gt;Helm&lt;/b&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;div class=&quot;notion-column notion-block-491c44b34b474bfcb09fc70afdfa8cea&quot; style=&quot;width:calc((100% - (1 * min(32px, 4vw))) * 0.5)&quot;&gt;&lt;div class=&quot;notion-text notion-block-ce820d37b02e46079668dece7d0c3be6&quot;&gt;&lt;b&gt;CUE&lt;/b&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;notion-row notion-block-f3a383cdf740401b9bea7ff394a41113&quot;&gt;&lt;div class=&quot;notion-column notion-block-d2f540afac254402a8ce7ad3444e4d6f&quot; style=&quot;width:calc((100% - (1 * min(32px, 4vw))) * 0.5)&quot;&gt;&lt;pre class=&quot;notion-code language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;# values&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;yaml
&lt;span class=&quot;token literal-property property&quot;&gt;app_name&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;example_code&quot;&lt;/span&gt;
&lt;span class=&quot;token literal-property property&quot;&gt;other_attr1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;foo&quot;&lt;/span&gt;
&lt;span class=&quot;token literal-property property&quot;&gt;other_attr2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;bar&quot;&lt;/span&gt;

# labels&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tpl
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; define &lt;span class=&quot;token string&quot;&gt;&quot;foo.labels&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token literal-property property&quot;&gt;label1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Values&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;app_name &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; required &lt;span class=&quot;token string&quot;&gt;&quot;app_name is required&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; 
&lt;span class=&quot;token literal-property property&quot;&gt;label2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Values&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;other_attr2 &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; include &lt;span class=&quot;token string&quot;&gt;&quot;foo.selectorLabels&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; end &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; define &lt;span class=&quot;token string&quot;&gt;&quot;foo.selectorLabels&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token literal-property property&quot;&gt;label3&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; printf &lt;span class=&quot;token string&quot;&gt;&quot;%s-%s&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Values&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;app_name &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Values&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;other_attr1 &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; end &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;div class=&quot;notion-column notion-block-c64eb6ff84e147e0bf6a8631cff370e4&quot; style=&quot;width:calc((100% - (1 * min(32px, 4vw))) * 0.49999999999999994)&quot;&gt;&lt;pre class=&quot;notion-code language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;# labels&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cue
&lt;span class=&quot;token literal-property property&quot;&gt;app_name&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;example_code&quot;&lt;/span&gt; ｜ string
&lt;span class=&quot;token literal-property property&quot;&gt;other_attr1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;foo&quot;&lt;/span&gt;
&lt;span class=&quot;token literal-property property&quot;&gt;other_attr2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;bar&quot;&lt;/span&gt;

&lt;span class=&quot;token literal-property property&quot;&gt;selector_labels&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token literal-property property&quot;&gt;label3&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;\( app_name )-\( other_attr2 )&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token literal-property property&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token literal-property property&quot;&gt;label1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; app_name
  &lt;span class=&quot;token literal-property property&quot;&gt;label2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; other_attr2
	selector_labels
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&quot;notion-spacer&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-8ffe96551d2348138a1fe110c1eef1ed&quot;&gt;&lt;li&gt;Helm 可以在 &lt;code class=&quot;notion-inline-code&quot;&gt;.tpl&lt;/code&gt; 文件中定义可复用的模版，并支持其他模版引用它，同时，也只有定义了的模版才能被复用，在复杂的 Chart 项目里你&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://github.com/bitnami/charts/tree/master/bitnami/common/templates&quot;&gt;需要额外定义非常多的基础模版&lt;/a&gt;。&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-9b9466c6f7da4fc8a16106adb6406054&quot;&gt;&lt;li&gt;相对于 Helm 繁琐的写法， 在 CUE 中所有内容均为 JSON 对象，不需要额外的语法去指定模版，任意 JSON 对象都可以互相引用。&lt;/li&gt;&lt;/ul&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-9040cb44603649f1ae931d70b56f2db7&quot; data-id=&quot;9040cb44603649f1ae931d70b56f2db7&quot;&gt;&lt;span&gt;&lt;div id=&quot;9040cb44603649f1ae931d70b56f2db7&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#9040cb44603649f1ae931d70b56f2db7&quot; title=&quot;空行和缩进&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;空行和缩进&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;div class=&quot;notion-text notion-block-c5a1284edb90411baed1881cd6a1be60&quot;&gt;&lt;b&gt;Helm&lt;/b&gt;&lt;/div&gt;&lt;pre class=&quot;notion-code language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; apps&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;v1
&lt;span class=&quot;token literal-property property&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Deployment
&lt;span class=&quot;token literal-property property&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; include &lt;span class=&quot;token string&quot;&gt;&quot;foo.deploymentName&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; include &lt;span class=&quot;token string&quot;&gt;&quot;foo.labels&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; nindent &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token literal-property property&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;replicas&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Values&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;replicaCount &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;selector&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;matchLabels&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; include &lt;span class=&quot;token string&quot;&gt;&quot;foo.selectorLabels&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; nindent &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;strategy&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; include &lt;span class=&quot;token string&quot;&gt;&quot;foo.updateStrategy&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; nindent &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;revisionHistoryLimit&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Values&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;revisionHistoryLimit &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Values&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;podAnnotations &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;annotations&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; toYaml &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; nindent &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; end &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token literal-property property&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; include &lt;span class=&quot;token string&quot;&gt;&quot;foo.labels&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; nindent &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-2c08e8f37d03498694d0e06547f46453&quot;&gt;&lt;b&gt;CUE&lt;/b&gt;&lt;/div&gt;&lt;pre class=&quot;notion-code language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;deployment&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token literal-property property&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;apps/v1&quot;&lt;/span&gt;
	&lt;span class=&quot;token literal-property property&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;       &lt;span class=&quot;token string&quot;&gt;&quot;Deployment&quot;&lt;/span&gt;
	&lt;span class=&quot;token literal-property property&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token literal-property property&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;   deployment_name
		&lt;span class=&quot;token literal-property property&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; labels
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;token literal-property property&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token literal-property property&quot;&gt;replicas&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; runtime&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;replicas
		&lt;span class=&quot;token literal-property property&quot;&gt;selector&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; matchLabels&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; selector_labels
		&lt;span class=&quot;token literal-property property&quot;&gt;strategy&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;             update_strategy
		&lt;span class=&quot;token literal-property property&quot;&gt;revisionHistoryLimit&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; revision_history_limit&lt;/code&gt;&lt;/pre&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-b5fcb07810f8485e99a38e65c1b42d39&quot;&gt;&lt;li&gt; Helm 中有大量的 &lt;code class=&quot;notion-inline-code&quot;&gt;{{- include }}&lt;/code&gt; 和 &lt;code class=&quot;notion-inline-code&quot;&gt;nindent&lt;/code&gt; 等和实际逻辑无关的标记字符，需要在每一次引用的地方计算空格和缩进。&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-38b9565048334fb692f4fb38e1eccd09&quot;&gt;&lt;li&gt;而在 CUE 中无用编码更少，不需要过多的 &lt;code class=&quot;notion-inline-code&quot;&gt;{{ * }}&lt;/code&gt; 来标记代码块，信息密度更高，而且在缩进和空格方面得到了完全的解放。&lt;/li&gt;&lt;/ul&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-23d0196aa8e4404abb2cfa6af7e01572&quot; data-id=&quot;23d0196aa8e4404abb2cfa6af7e01572&quot;&gt;&lt;span&gt;&lt;div id=&quot;23d0196aa8e4404abb2cfa6af7e01572&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#23d0196aa8e4404abb2cfa6af7e01572&quot; title=&quot;values.yaml 自引用&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;values.yaml 自引用&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;div class=&quot;notion-text notion-block-e0ebfa7c177e450c92f3fc6c9a54835c&quot;&gt;在 Helm 中，一个长久以来的头疼问题就是，无法优雅地实现 &lt;code class=&quot;notion-inline-code&quot;&gt;values.yaml&lt;/code&gt; 引用问题。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-7984173a56cb4bddbbd8efb7f62c2e0f&quot;&gt;我们看下面的例子：&lt;/div&gt;&lt;pre class=&quot;notion-code language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;rootDomain&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;

# 我们期待的是通过引用 rootDomain 拼接，例如：&lt;span class=&quot;token string&quot;&gt;&quot;foo.{{ .Values.rootDomain }}&quot;&lt;/span&gt;
&lt;span class=&quot;token literal-property property&quot;&gt;productDomain&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-f5e89f66c62b4209b64afdb7a67e7970&quot;&gt;通常的情况下，Chart 的使用者需要针对这两个变量分别填写内容，增加了出错的可能。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-81310d6b8e99401bacf09b9c7fe2da52&quot;&gt;虽然我们可以通过定义模版来实现：&lt;/div&gt;&lt;pre class=&quot;notion-code language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;# values&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;yaml
&lt;span class=&quot;token literal-property property&quot;&gt;rootDomain&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;
&lt;span class=&quot;token literal-property property&quot;&gt;productDomain&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;foo.{{ .Values.rootDomain }}&quot;&lt;/span&gt;

# helpers&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tpl
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; define &lt;span class=&quot;token string&quot;&gt;&quot;foo.productDomain&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; tpl &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Values&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;productDomain $ &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; end &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

# ingress&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;yaml
&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;token literal-property property&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;rules&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; host&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; include &lt;span class=&quot;token string&quot;&gt;&quot;foo.productDomain&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; quote &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-c207daf5e6d04e42aa28ca6867a86049&quot;&gt;但在实际使用中，所有引用的地方都需要额外 &lt;code class=&quot;notion-inline-code&quot;&gt;include&lt;/code&gt; ，同时定义的维护也非常耗费心力（要时刻保证空行、缩进不出错）。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-dba38137957a4468a22a83273ff5a207&quot;&gt;而在 CUE 中，相互引用显得自然而舒服。&lt;/div&gt;&lt;pre class=&quot;notion-code language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;rootDomain&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; string
&lt;span class=&quot;token literal-property property&quot;&gt;productDomain&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;foo.\( rootDomain )&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; string&lt;/code&gt;&lt;/pre&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-2d212d1d74ca4f558165434d9a67aa5d&quot; data-id=&quot;2d212d1d74ca4f558165434d9a67aa5d&quot;&gt;&lt;span&gt;&lt;div id=&quot;2d212d1d74ca4f558165434d9a67aa5d&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#2d212d1d74ca4f558165434d9a67aa5d&quot; title=&quot;导入 Kubernetes 包&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;导入 Kubernetes 包&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;div class=&quot;notion-text notion-block-f56cc7da728d41d1a2a8b1d24e94e30a&quot;&gt;CUE 的另一大杀器，可以针对原生 Kubernetes 源码生成描述 cue 文件，所有 k8s 资源相关的配置文件，都可以天然地拥有 schema 校验。具体教程可以查看 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://cue.googlesource.com/cue/+/HEAD/doc/tutorial/kubernetes/README.md&quot;&gt;Kubernetes tutorial&lt;/a&gt;。&lt;/div&gt;&lt;pre class=&quot;notion-code language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;package&lt;/span&gt; templates

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
	apps &lt;span class=&quot;token string&quot;&gt;&quot;k8s.io/api/apps/v1&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token literal-property property&quot;&gt;deployment&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; apps&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;#Deployment

&lt;span class=&quot;token literal-property property&quot;&gt;deployment&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token literal-property property&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;apps/v1&quot;&lt;/span&gt;
	&lt;span class=&quot;token literal-property property&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;       &lt;span class=&quot;token string&quot;&gt;&quot;Deployment&quot;&lt;/span&gt;
	&lt;span class=&quot;token literal-property property&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token literal-property property&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;   deployment_name
		&lt;span class=&quot;token literal-property property&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; _labels
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-1011b4ce77c143f7972cc817a33b4dc5&quot;&gt;类似这个例子中，我们定义的 &lt;code class=&quot;notion-inline-code&quot;&gt;deployment&lt;/code&gt; 将会通过 &lt;code class=&quot;notion-inline-code&quot;&gt;apps.#Deployment&lt;/code&gt; 校验，轻松检测出不合法的字段。理论上，你可以针对多个不同版本的 k8s 资源都生成 cue 文件，并且都作为 &lt;code class=&quot;notion-inline-code&quot;&gt;deployment&lt;/code&gt; 的模型定义，这样可以实现资源定义的多版本兼容能力。&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-858fcc7fe3e04cc588a79ab7fefd25fc&quot;&gt; &lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-c355ab655f264eb08bbb13cd6597b2d3&quot; data-id=&quot;c355ab655f264eb08bbb13cd6597b2d3&quot;&gt;&lt;span&gt;&lt;div id=&quot;c355ab655f264eb08bbb13cd6597b2d3&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#c355ab655f264eb08bbb13cd6597b2d3&quot; title=&quot;说了这么多好处，现在就把所有 Helm Chart 都替换成 CUE？&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;说了这么多好处，现在就把所有 Helm Chart 都替换成 CUE？&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-76ee41cf0b014ab58342d9dadfa0dc96&quot;&gt;且慢，还没到时候。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-66385d718ce5497e80a494732f243c56&quot;&gt;因为 Helm 作为 &lt;code class=&quot;notion-inline-code&quot;&gt;Package Manager&lt;/code&gt; ，除了 Chart 渲染，本身还具备一定的应用管理功能，例如 &lt;code class=&quot;notion-inline-code&quot;&gt;Helm install&lt;/code&gt; 、 &lt;code class=&quot;notion-inline-code&quot;&gt;Helm rollback&lt;/code&gt; 等，而 CUE 仅仅是模版。所以在某些我们只使用了 Helm 的模版功能的情况下，可以考虑迁移到 CUE，其他情况，还是用 Helm 吧。&lt;/div&gt;&lt;h4 class=&quot;notion-h notion-h3 notion-h-indent-1 notion-block-212420499e7c482a85115d93d0ea1e20&quot; data-id=&quot;212420499e7c482a85115d93d0ea1e20&quot;&gt;&lt;span&gt;&lt;div id=&quot;212420499e7c482a85115d93d0ea1e20&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#212420499e7c482a85115d93d0ea1e20&quot; title=&quot;脑洞&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;脑洞&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;&lt;div class=&quot;notion-text notion-block-5b0d52293b8a424fab06cdfdd4e39da1&quot;&gt;做一个开源的 CLI，支持将多个文件聚合为一个应用统一管理：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-56634d78612a4897aee018a9de4fd74a&quot;&gt;&lt;li&gt;类似 Helm 的能力，支持安装、更新、回滚&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-f8a5efbf33194fe1a7b8fbb887ab358e&quot;&gt;&lt;li&gt;针对配置，支持裸配置和 CUE 文件&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-text notion-block-b29766be75ec4f8b92d692f6e90ff696&quot;&gt;好了，先说这么多，我去尝试写一写，下篇文章见 👋 ～&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-5731d426beec4b59aae40ca01dd3b6e5&quot;&gt; &lt;/div&gt;&lt;/main&gt;]]&gt;&lt;/content&gt;
    &lt;/entry&gt;
&lt;/feed&gt;</div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"xmlFeed":"\u003c?xml version=\"1.0\" encoding=\"utf-8\"?\u003e\n\u003cfeed xmlns=\"http://www.w3.org/2005/Atom\"\u003e\n    \u003cid\u003ehttps://next.emergencyexit.xyz//\u003c/id\u003e\n    \u003ctitle\u003e布鲁斯鱼的妙想天开\u003c/title\u003e\n    \u003cupdated\u003e2022-10-18T10:07:05.450Z\u003c/updated\u003e\n    \u003cgenerator\u003ehttps://github.com/jpmonette/feed\u003c/generator\u003e\n    \u003cauthor\u003e\n        \u003cname\u003ebluesyu\u003c/name\u003e\n        \u003cemail\u003ebluesedenyu@gmail.com\u003c/email\u003e\n        \u003curi\u003ehttps://next.emergencyexit.xyz/\u003c/uri\u003e\n    \u003c/author\u003e\n    \u003clink rel=\"alternate\" href=\"https://next.emergencyexit.xyz//\"/\u003e\n    \u003csubtitle\u003e此间的博文大抵有两类，一种是水的，另一种仍是水的罢。 —— 鲁迅\u003c/subtitle\u003e\n    \u003cicon\u003ehttps://next.emergencyexit.xyz//favicon.svg\u003c/icon\u003e\n    \u003crights\u003eAll rights reserved 2022, bluesyu\u003c/rights\u003e\n    \u003centry\u003e\n        \u003ctitle type=\"html\"\u003e\u003c![CDATA[WTF Go: Constants]]\u003e\u003c/title\u003e\n        \u003cid\u003ehttps://next.emergencyexit.xyz//wtf-go-constants\u003c/id\u003e\n        \u003clink href=\"https://next.emergencyexit.xyz//wtf-go-constants\"/\u003e\n        \u003cupdated\u003e2022-10-11T00:00:00.000Z\u003c/updated\u003e\n        \u003csummary type=\"html\"\u003e\u003c![CDATA[ WTF Go: 初看反直觉，仔细研究却大有设计]]\u003e\u003c/summary\u003e\n        \u003ccontent type=\"html\"\u003e\u003c![CDATA[\u003cmain class=\"notion light-mode notion-page notion-block-f6ba5dfd50004e1580b47d3456bc676a\"\u003e\u003cdiv class=\"notion-viewport\"\u003e\u003c/div\u003e\u003cpre class=\"notion-code language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n\t\u003cspan class=\"token string\"\u003e\"time\"\u003c/span\u003e\n\t\u003cspan class=\"token string\"\u003e\"math/rand\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// invalid operation: rand.Intn(10) * 1000 * time.Millisecond (mismatched types int and time.Duration)\u003c/span\u003e\ntime\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSleep\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erand\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eIntn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMillisecond\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e ❌\n\n\u003cspan class=\"token comment\"\u003e// 🤔 make sense.\u003c/span\u003e\ntime\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSleep\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etime\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eDuration\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erand\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eIntn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMillisecond\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e ✅\n\n\u003cspan class=\"token comment\"\u003e// wtf ?!\u003c/span\u003e\ntime\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSleep\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1000\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMillisecond\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e ✅ \n\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-c39aa2c506de4a38884207f6cc0666f4\"\u003e看看上面这个简单的例子：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-94339645b11c4208ac1de17ef66e21d6\"\u003e\u003cli\u003e第一个错误很容易理解： 整型不能和 \u003ccode class=\"notion-inline-code\"\u003etime.Duration\u003c/code\u003e 相乘\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-90a7e274dd4740ac97bd29e4c8b56822\"\u003e\u003cli\u003e第二个例子修正了这一问题，符合预期\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-f1ecf287e16c4698bfa18a71b4789179\"\u003e\u003cli\u003e第三个例子带来了疑问，为什么 \u003ccode class=\"notion-inline-code\"\u003e1000 * time.Millisecond\u003c/code\u003e 却没有问题？明明 \u003ccode class=\"notion-inline-code\"\u003e1000\u003c/code\u003e 也是个整型？编译器戴了有色眼镜？\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-text notion-block-2aa15d50137b414bb6ed5569ce63f326\"\u003e别慌，仔细看看 \u003ccode class=\"notion-inline-code\"\u003erand.Intn(10) * 1000\u003c/code\u003e 和 \u003ccode class=\"notion-inline-code\"\u003e1000\u003c/code\u003e 的区别在于：前者是变量，类型已经确定了，通不过编译是情理之中；而后者是常量，类型并不是 \u003ccode class=\"notion-inline-code\"\u003eint\u003c/code\u003e ，属于 \u003ccode class=\"notion-inline-code\"\u003euntyped constants\u003c/code\u003e ，编译器会尝试将它转换成 \u003ccode class=\"notion-inline-code\"\u003etime.Duration\u003c/code\u003e 。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-4b6e7022ba1c41dc9dec86be35016e6a\"\u003e这就勾起了我的好奇心，那如果我写个一个 \u003ccode class=\"notion-inline-code\"\u003efloat\u003c/code\u003e 常量会怎样呢？\u003c/div\u003e\u003cpre class=\"notion-code language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// (untyped float constant) truncated to int64\u003c/span\u003e\ntime\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSleep\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1000.1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMillisecond\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e ❌\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-5581a723f1c9437da180b271dde64dfb\"\u003e果然是不行的。那么究竟这个无类型常量的类型转换是依照什么规则进行的呢？\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-fda4059895d742c18a5c11fcd2834e98\"\u003e首先每一种常量的\u003cb\u003e写法\u003c/b\u003e都会对应着一种默认类型：\u003c/div\u003e\u003cfigure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-bead2efbe82d41e6a20ac11ad6d2aa44\"\u003e\u003cdiv style=\"position:relative;display:flex;justify-content:center;align-self:center;width:540px;max-width:100%;flex-direction:column\"\u003e\u003cimg style=\"object-fit:contain\" src=\"https://www.notion.so/image/https%3A%2F%2Fs3.us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F4841bfb7-5a0d-42ae-ba4c-55881d39feec%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45EIPT3X45%252F20221018%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20221018T100700Z%26X-Amz-Expires%3D86400%26X-Amz-Signature%3D87cbcf360f645c59babfc23cfc3ca0c32f8d8d0fb9ed179fe191b88bad48ea85%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject?table=block\u0026amp;id=bead2efb-e82d-41e6-a20a-c11ad6d2aa44\u0026amp;cache=v2\" loading=\"lazy\" alt=\"notion image\" decoding=\"async\"/\u003e\u003c/div\u003e\u003c/figure\u003e\u003cdiv class=\"notion-blank notion-block-fd185c5379f34f0a8f0cafca86305977\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-b39975e4a04d40b4b8693d417031d653\"\u003e然后，看看 \u003ccode class=\"notion-inline-code\"\u003etime.Duration\u003c/code\u003e 的定义：\u003c/div\u003e\u003cpre class=\"notion-code language-go\"\u003e\u003ccode class=\"language-go\"\u003etype Duration int64\n\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    Nanosecond  Duration \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n    Microsecond          \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e Nanosecond\n    Millisecond          \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e Microsecond\n    Second               \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e Millisecond\n    Minute               \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e60\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e Second\n    Hour                 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e60\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e Minute\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-b8de09386e5b45e7a5f0ae8bfc054707\"\u003e也就是说 \u003ccode class=\"notion-inline-code\"\u003e1000\u003c/code\u003e 的写法默认类型为 \u003ccode class=\"notion-inline-code\"\u003eint\u003c/code\u003e ，编译器会尝试做一次类型转换 \u003ccode class=\"notion-inline-code\"\u003eint\u003c/code\u003e → \u003ccode class=\"notion-inline-code\"\u003etime.Duration\u003c/code\u003e ，而 \u003ccode class=\"notion-inline-code\"\u003eint64\u003c/code\u003e 和 \u003ccode class=\"notion-inline-code\"\u003eint\u003c/code\u003e 又能做到完全兼容，所以编译通过。\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-bb978502225d458d8ea95627d61232a4\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-73679d6edd4946938e9b7e3de693eee1\"\u003eWTF，Go…\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-387dcc99be4b4d9bb32787dccb641d7b\" data-id=\"387dcc99be4b4d9bb32787dccb641d7b\"\u003e\u003cspan\u003e\u003cdiv id=\"387dcc99be4b4d9bb32787dccb641d7b\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#387dcc99be4b4d9bb32787dccb641d7b\" title=\"参考：\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e参考：\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cul class=\"notion-list notion-list-disc notion-block-ba5cdf07de3944ea84183d9fab8c5efb\"\u003e\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://go.dev/blog/constants\"\u003ehttps://go.dev/blog/constants\u003c/a\u003e （本文主要搬运来源）\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-f7b45bfc8bf8475193cb2ae92d69b169\"\u003e\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://blog.learngoprogramming.com/learn-golang-typed-untyped-constants-70b4df443b61\"\u003ehttps://blog.learngoprogramming.com/learn-golang-typed-untyped-constants-70b4df443b61\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-blank notion-block-3554b88ab160438cae51c7eecbae9b14\"\u003e \u003c/div\u003e\u003c/main\u003e]]\u003e\u003c/content\u003e\n    \u003c/entry\u003e\n    \u003centry\u003e\n        \u003ctitle type=\"html\"\u003e\u003c![CDATA[Google 软件工程 读后感 Part I]]\u003e\u003c/title\u003e\n        \u003cid\u003ehttps://next.emergencyexit.xyz//software-engineering-at-google-impression\u003c/id\u003e\n        \u003clink href=\"https://next.emergencyexit.xyz//software-engineering-at-google-impression\"/\u003e\n        \u003cupdated\u003e2022-09-20T00:00:00.000Z\u003c/updated\u003e\n        \u003csummary type=\"html\"\u003e\u003c![CDATA[有趣的比喻集合]]\u003e\u003c/summary\u003e\n        \u003ccontent type=\"html\"\u003e\u003c![CDATA[\u003cmain class=\"notion light-mode notion-page notion-block-3927ece3993146e88e7e91d5e0b5c326\"\u003e\u003cdiv class=\"notion-viewport\"\u003e\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-ec27187857af4dd7909a8b90936e43ea\"\u003e总的来说，这本书值得所有软件开发从业者阅读。一些观点可能不至于奉之圭臬，但也可以提供另一种处理问题的视角。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-897150010d224de4ba48d1ff6f8b1392\"\u003e它将很多\u003cb\u003e存在于意识而尚未落成语言的软件工程共识\u003c/b\u003e，用简单易读的方式总结表达了出来，相信对于大多数软件工程师都会有帮助。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-c2ba7cfd50b3425084f45603fcbff89f\"\u003e分享书中一些有趣的说法，如果你也觉得有意思，那么就买来读一读吧。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-39594e9a3fce41e49b9a5210fdf01fa3\"\u003e（如果你的「洋文🤓」够好，也可以直接\u003cspan class=\"notion-teal\"\u003e\u003cb\u003e免费\u003c/b\u003e\u003c/span\u003e阅读 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://abseil.io/resources/swe-book/html/toc.html\"\u003e英文原版\u003c/a\u003e）\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-07d4b358fcd44b0b90fb5a295bd4b1dd\" data-id=\"07d4b358fcd44b0b90fb5a295bd4b1dd\"\u003e\u003cspan\u003e\u003cdiv id=\"07d4b358fcd44b0b90fb5a295bd4b1dd\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#07d4b358fcd44b0b90fb5a295bd4b1dd\" title=\"海勒姆定律（Hyrum’s Law）\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e海勒姆定律（Hyrum’s Law）\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cblockquote class=\"notion-quote notion-block-57a7a82e02e64c1ca392536ae1ba3027\"\u003e当一个 API 有足够多的用户时，在约定中你所承诺的已不重要：所有在你系统里面被观察到的行为都会被一些用户所依赖。\u003c/blockquote\u003e\u003cdiv class=\"notion-text notion-block-4a142d26df674781897ce80fd220c487\"\u003e我从中读出来的关键点：拒绝侥幸心理。当用户体量足够大时，任何改动都需要通过测试来收尾，侥幸心理自认为某些逻辑人畜无害，一两次可能可以省事儿，但总有一天会翻船。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-78bb3c9293c94075b5e2d2754f376ba1\" data-id=\"78bb3c9293c94075b5e2d2754f376ba1\"\u003e\u003cspan\u003e\u003cdiv id=\"78bb3c9293c94075b5e2d2754f376ba1\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#78bb3c9293c94075b5e2d2754f376ba1\" title=\"巴士系数（Truck Factor）\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e巴士系数（\u003cb\u003eTruck Factor\u003c/b\u003e）\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cblockquote class=\"notion-quote notion-block-c067d91017c642edaf839e01370db824\"\u003e指多少关键开发者被巴士撞了会让项目停摆。\u003c/blockquote\u003e\u003cdiv class=\"notion-text notion-block-11cde37630c343f0a75319a674254b53\"\u003e开发者被巴士撞了虽然有点残忍，但确实是一个很形象的表述——当成员突然不参与工作或失去通讯能力。可能在很多团队中，开发者的\u003cb\u003e突然离职\u003c/b\u003e是更贴近这种场景的情况。想要尽量避免因为关键人物的离开而导致项目停摆，书中也列举了基础的预防措施：备份或者结对编程，“每一个人在工作时都需要第二双眼睛的监督”，最重要的是 “拒绝隐藏”。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-33bed20e701b40cb81c0322f955c84b9\"\u003e就我个人的经验而言，在项目开发过程中保持良好的文档记录习惯是一种“美德”，在一些更有追求的团队，更应该是“义务”。良好的文档可以一定程度上保持当“巴士”袭来时，团队能够依靠文档维持相当程度的稳定。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-ec305ffabbeb455098df8f3d02b657c0\"\u003e当然以上都是从 \u003cb\u003e“团队最优” \u003c/b\u003e的角度来说，并不是所有公司都有 Google 的优秀风气，我还在别的团队听过”教会徒弟，饿死师傅“的说法。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-e4707ad77bbc4cafb4441ddf3eba5912\"\u003e这其中孰对孰错，是分享还是私藏，很难在这篇读后感中用几百字讨论清楚。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-6898e8ff30cf46638d1d72ec2c563dad\"\u003e我们需要保持清醒：互联网从业有它的特殊性——知识获取门槛极低，任何领域都可以通过网络资源轻松入门，但同时也有其他行业相似的普遍性——在资本逐利的背景下，行业失去高增长，更低成本的人力总是会更有竞争力。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-0f50d6ae1c1e4bf4a295cb1abb100879\" data-id=\"0f50d6ae1c1e4bf4a295cb1abb100879\"\u003e\u003cspan\u003e\u003cdiv id=\"0f50d6ae1c1e4bf4a295cb1abb100879\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#0f50d6ae1c1e4bf4a295cb1abb100879\" title=\"左移思想（Left Shift）\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e左移思想（Left Shift）\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cblockquote class=\"notion-quote notion-block-8864520720f8419ab3d1ea039198f93d\"\u003e在开发人员工作流的早期发现问题通常会降低成本。\u003c/blockquote\u003e\u003cfigure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-64e5a128d5ba4638a1c92360e5482d1a\"\u003e\u003cdiv style=\"position:relative;display:flex;justify-content:center;align-self:center;width:432px;max-width:100%;flex-direction:column\"\u003e\u003cimg style=\"object-fit:contain\" src=\"https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F33295efc-1f2c-441e-8829-fb516edd724c%2FUntitled.png?table=block\u0026amp;id=64e5a128-d5ba-4638-a1c9-2360e5482d1a\u0026amp;cache=v2\" loading=\"lazy\" alt=\"notion image\" decoding=\"async\"/\u003e\u003c/div\u003e\u003c/figure\u003e\u003cdiv class=\"notion-text notion-block-12c690895f02451998de285e999ba4b5\"\u003e配合此图，还是非常容易理解的。从开发人员的角度来看，可能存在的问题在越前端解决付出的成本肯定是越小的。举个小例子，陶文在 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://zhuanlan.zhihu.com/p/357411780\"\u003e《不要以 DRY 之名，发明低代码 DSL 去残害你的同事》\u003c/a\u003e提到过，缺乏与上游（比如产品、策划）的沟通，只是在开发侧 “一厢情愿” 的抽象可能是一个误区：“先要把需求的源头给按住了。而不是在需求的下游，用可复用抽象代码来兜底”。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-aac58e9671844d35ad0ccc013e987983\"\u003e类似地，在敏捷开发和 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://devops.com/devops-shift-left-avoid-failure/\"\u003eDevOps 开发理论中也提到过\u003c/a\u003e ，同时还有一个 “\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://devops.com/shift-right-testing-the-emergence-of-testops/\"\u003e测试右移\u003c/a\u003e” 的概念，在测试或者是性能检查时，尽量从贴近用户端出发来保证整个产品流程的质量。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-0d9a2e22b9e049a8bac1ff5ca37930de\" data-id=\"0d9a2e22b9e049a8bac1ff5ca37930de\"\u003e\u003cspan\u003e\u003cdiv id=\"0d9a2e22b9e049a8bac1ff5ca37930de\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#0d9a2e22b9e049a8bac1ff5ca37930de\" title=\"经理人炎症（Manageritis）\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e经理人炎症（Manageritis）\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cblockquote class=\"notion-quote notion-block-0fe7688ff117426b89f4240ba74b020c\"\u003e对于处于进步边缘的有抱负的或者那些刚刚晋升的领导者，存在一种高度危险的自我炎症，称为“管理炎”。\u003c/blockquote\u003e\u003cdiv class=\"notion-text notion-block-f6c396005f6a40a086d0c1750da40ca2\"\u003e更简单说法是 “刻意管理”，这种症状多数出现在从个人贡献者 → 管理者身份转变期。很大的原因是，作为技术开发者，我们已经很习惯于在专业技能上投资，并有着合适的回报预期：比如定期在某个领域深入学习，你就能立马获得该领域的技能提升。但是转变到“经理”时，这个回报周期变得不一样了（通常会更长），带领团队向上提升，个体的技能成长反而不容易被感知，会导致做出更高频次的“投资”动作，更加”努力管理”，更容易显得刻意。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-5dee97aa820d411fbc7f0b9e60bcc51b\"\u003e还有一个方面的原因，从个人贡献者到管理者后，将会面临很多抉择的场景：\u003cem\u003e自己动手，快速解决问题 \u003c/em\u003evs \u003cem\u003e交给他人，更慢更困难地解决问题\u003c/em\u003e，及时从更长尺度上来看，后者收益会更高，但在这个抉择面前，没有经验的管理者还是会显得非常犹豫。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-af607e49d1ed49c0ad3bb362bf92ffbe\" data-id=\"af607e49d1ed49c0ad3bb362bf92ffbe\"\u003e\u003cspan\u003e\u003cdiv id=\"af607e49d1ed49c0ad3bb362bf92ffbe\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#af607e49d1ed49c0ad3bb362bf92ffbe\" title=\"碧昂丝规则（Beyoncé Rule）\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e碧昂丝规则（Beyoncé Rule）\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cblockquote class=\"notion-quote notion-block-08f7f47edaa44f40a7387935ba510099\"\u003e“如果你喜欢它，你就应该测试它”。\u003c/blockquote\u003e\u003cdiv class=\"notion-text notion-block-06be070f5c2f4fe29ec84970faf12195\"\u003e原型是：\u0026quot;If you liked it then you shoulda put a ring on it”，来自于碧昂斯 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://www.youtube.com/watch?v=4m1EFMoRFvY\"\u003eSingle Lady(Put a Ring on It)\u003c/a\u003e 歌词（我感觉关联性不大，我猜是碧昂斯粉丝的私货 🤣）。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-b55310de83394d8a8578c751aa107df5\"\u003e意思是“所有不想被破坏的东西”都应该被测试。当你的项目依赖于某些外部系统时，如果想确保一些特性能够符合预期，那么唯一的办法就是在自己的项目编写测试。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-7b582dc921d64925af13c234ff261fe9\"\u003e这一点容易被泛化到外部系统的所有特性，我的理解是需要妥善处理依赖的外部系统\u003cb\u003e常见的重点场景\u003c/b\u003e出现异常的情况，而不是全部，也不应该关注全部。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-140a4fcfb666460b9428f70357693cbd\"\u003e在 Google 内部常有一种说法：“如果一个产品由于基础设施的变更出现中断或其它问题，但是在我们的持续集成(CI)系统中的自动化测试用例并没有发现这个问题，那么就不应该由负责基础设施的团队承担责任。”\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-c0789386a8ff49b3941623f22c3334df\"\u003e在我们日常的工作场景中，大家普遍是没有这个意识的，如果基础设施出问题，无论我们是否有预料，黑锅都可以毫无负担的甩下去，也造成基础设施部门普遍承受了过多压力 xD。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-42d3995b003b481b880565f8f241d6b8\" data-id=\"42d3995b003b481b880565f8f241d6b8\"\u003e\u003cspan\u003e\u003cdiv id=\"42d3995b003b481b880565f8f241d6b8\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#42d3995b003b481b880565f8f241d6b8\" title=\"Fin\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eFin\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-f4922f38c9ce4edc8ea1d08ddecb407b\"\u003e书中还有一些更大值得讨论的话题，以后或许有机会可以结合自己的项目经历写出来聊聊\u003cem\u003e\u003cs\u003e（典型的挖坑不埋）\u003c/s\u003e\u003c/em\u003e。\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-161f0f3cd34d432493910405685342ba\"\u003e \u003c/div\u003e\u003c/main\u003e]]\u003e\u003c/content\u003e\n    \u003c/entry\u003e\n    \u003centry\u003e\n        \u003ctitle type=\"html\"\u003e\u003c![CDATA[Django ORM：天使与魔鬼 II]]\u003e\u003c/title\u003e\n        \u003cid\u003ehttps://next.emergencyexit.xyz//django-orm-best-practice-II\u003c/id\u003e\n        \u003clink href=\"https://next.emergencyexit.xyz//django-orm-best-practice-II\"/\u003e\n        \u003cupdated\u003e2022-09-09T00:00:00.000Z\u003c/updated\u003e\n        \u003csummary type=\"html\"\u003e\u003c![CDATA[CRUD boy 回来了]]\u003e\u003c/summary\u003e\n        \u003ccontent type=\"html\"\u003e\u003c![CDATA[\u003cmain class=\"notion light-mode notion-page notion-block-6ad26f7b18284d64a9483cc6367f6901\"\u003e\u003cdiv class=\"notion-viewport\"\u003e\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-917f169ee9c34019a62c5f85892e3620\"\u003e最近重操 CRUD 旧业，又有一些新的发现，故增加一篇 \u003ca class=\"notion-link\" href=\"https://www.notion.so/982e294cabb247aa878134d8bb6fd6ce\"\u003eDjango ORM：天使与魔鬼\u003c/a\u003e Part II。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-4d19de6795b04c9f89f8e3a758d0954c\" data-id=\"4d19de6795b04c9f89f8e3a758d0954c\"\u003e\u003cspan\u003e\u003cdiv id=\"4d19de6795b04c9f89f8e3a758d0954c\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#4d19de6795b04c9f89f8e3a758d0954c\" title=\"利用 batch_size 控制数据库单次提交的大小\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e利用 batch_size 控制数据库单次提交的大小\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-4441855d1bb34da0aed6aa17fcf05202\"\u003e\u003ccode class=\"notion-inline-code\"\u003ebulk_create\u003c/code\u003e 和 \u003ccode class=\"notion-inline-code\"\u003ebulk_update\u003c/code\u003e 是我们常用的批量创建、更新的方法，但批量提速一时爽，提交过长会直接导致任务失败。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-5c409ae54dae4b2b882909acbbeec43c\"\u003e之前没有细致查阅文档，想当然 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/TencentBlueKing/bk-user/blob/cd3d14b72d92de0cf687e9466a797b9fd07e0daf/src/api/bkuser_core/common/db_sync.py#L140\"\u003e手写了批量提交分片的逻辑\u003c/a\u003e ，虽然也完全实现了功能，但终究多了一份需要维护的逻辑，实际上直接用 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://docs.djangoproject.com/zh-hans/4.1/ref/models/querysets/#bulk-create\"\u003eDjango 默认提供的 \u003c/a\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://docs.djangoproject.com/zh-hans/4.1/ref/models/querysets/#bulk-create\"\u003e\u003ccode class=\"notion-inline-code\"\u003ebatch_size\u003c/code\u003e\u003c/a\u003e 即可。\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003efrom itertools \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e islice\n\nbatch_size \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e100\u003c/span\u003e\nobjs \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eEntry\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eheadline\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e'Test %s'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e%\u003c/span\u003e i\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e i \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"token function\"\u003erange\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1000\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e \u003cspan class=\"token literal-property property\"\u003eTrue\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    batch \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003elist\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eislice\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eobjs\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e batch_size\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e not batch\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ebreak\u003c/span\u003e\n    Entry\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eobjects\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ebulk_create\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebatch\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e batch_size\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-4560c1f2cdc34fc8b26c830584140494\" data-id=\"4560c1f2cdc34fc8b26c830584140494\"\u003e\u003cspan\u003e\u003cdiv id=\"4560c1f2cdc34fc8b26c830584140494\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#4560c1f2cdc34fc8b26c830584140494\" title=\"通过 Prefetch 控制预取的查询\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e通过 Prefetch 控制预取的查询\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-942fb49c92dd440eacbde16315aa4e4c\"\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://stackoverflow.com/questions/97197/what-is-the-n1-selects-problem-in-orm-object-relational-mapping\"\u003eN + 1 问题\u003c/a\u003e是非常常见的查询效率杀手。在 Django 中我们通常会使用 \u003ccode class=\"notion-inline-code\"\u003eselected_related\u003c/code\u003e 或\u003ccode class=\"notion-inline-code\"\u003eprefetch_related\u003c/code\u003e 来预取关联对象，来减少和 DB 之间的交互，但是在使用上也需要有一些注意的地方。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-29fd3c9a717c4acaa7d4af894c3bf0e7\"\u003e首先，预取需要精确控制到字段。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-e116a47ba91e4fe3a33d9bbd54be8429\"\u003eDjango 默认的查询方式都是粗放的，例如普通查询不使用 \u003ccode class=\"notion-inline-code\"\u003evalues\u003c/code\u003e 或者 \u003ccode class=\"notion-inline-code\"\u003eonly\u003c/code\u003e 时都是 \u003ccode class=\"notion-inline-code\"\u003eselect *\u003c/code\u003e ，而预取也不例外，看看下面这个例子。\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eFoo\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodels\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eModel\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n\t\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodels\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eModel\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n\tfoo \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e models\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eForeignKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eFoo\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBaz\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodels\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eModel\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"A very large table\"\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\n\tfoo \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e models\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eForeignKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eFoo\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-844a600b3a5c44fb806ca38269fa0a16\"\u003e我们在查询 \u003ccode class=\"notion-inline-code\"\u003eFoo\u003c/code\u003e 时，会尝试预取关联字段以加速后续数据读取，但如果我们在调用时不加任何参数：\u003ccode class=\"notion-inline-code\"\u003eFoo.objects.all().prefetch_related()\u003c/code\u003e ，\u003cb\u003e默认地 Django 会将所有关联字段都取出来\u003c/b\u003e，加入 \u003ccode class=\"notion-inline-code\"\u003eBaz\u003c/code\u003e 表无比巨大，本来用作性能优化的 \u003ccode class=\"notion-inline-code\"\u003eprefetch_related\u003c/code\u003e 就会摇身变成耗时怪兽。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-05eabf30586c4efd84335bcd09602fed\"\u003e此外，我们还会遇到级联预取的场景。\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eFoo\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodels\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eModel\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n\t\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodels\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eModel\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n\tfoo \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e models\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eForeignKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eFoo\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e related_name\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"bars\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBaz\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodels\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eModel\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n\tbar \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e models\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eForeignKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eBar\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e related_name\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"bazs\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\tlarge_config \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e models\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eJSONField\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-f2e6729bc91346c6ad21fd1a2bcd4ff4\"\u003e此时在后续的循环处理中，我们需要通过 \u003ccode class=\"notion-inline-code\"\u003eFoo\u003c/code\u003e 对象查询到 \u003ccode class=\"notion-inline-code\"\u003eBaz\u003c/code\u003e 的数据，为了避免 N + 1 我们也会多级预取:\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003eFoo\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eobjects\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eselect_related\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"bars\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eprefetch_related\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"bars__bazs\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-e7a383c89d8a47d98bb03ea1215373c5\"\u003e此时二级预取也是默认获取全部字段，倘若 \u003ccode class=\"notion-inline-code\"\u003eBaz\u003c/code\u003e 表中有一个需要额外耗时序列化的字段，同样会使优化适得其反。这时可以考虑引入 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://docs.djangoproject.com/zh-hans/4.1/ref/models/querysets/#prefetch-objects\"\u003e\u003ccode class=\"notion-inline-code\"\u003ePrefetch\u003c/code\u003e\u003c/a\u003e 对象，做更细致的查询控制。\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003eFoo\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eobjects\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eselect_related\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"bars\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eprefetch_related\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n\t\u003cspan class=\"token function\"\u003ePrefetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"bars__bazs\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e queryset\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eBaz\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eobjects\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edefer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"large_config\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-blank notion-block-49ad21cac56745f889392cedcb9e5b71\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-744cc7796009402fab94db362da28356\"\u003e是不是觉得 ORM 查询本身也挺繁杂的？用 SQL 有时会更直接清晰地多。所以也会有一些完全\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://dev.solita.fi/2021/06/01/why-avoid-an-orm.html\"\u003e不使用 ORM 的观点\u003c/a\u003e。在我看来，ORM 能让 90% 的查询都变得结构化更清晰、更易维护、甚至更安全，但剩下的 10% 也许会耗费更多的精力，所以何时使用 ORM 是根据具体项目场景来定的，不能因噎废食。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-b5a4d66ac57a4ca8b13e1028109b39c7\" data-id=\"b5a4d66ac57a4ca8b13e1028109b39c7\"\u003e\u003cspan\u003e\u003cdiv id=\"b5a4d66ac57a4ca8b13e1028109b39c7\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#b5a4d66ac57a4ca8b13e1028109b39c7\" title=\"小广告\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e小广告\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-f88ddea20edb497b87e46b9377a818d2\"\u003e是不是觉得 Part II 内容有点少？没关系，更多的内容我都放在了这里。\u003c/div\u003e\u003cdiv class=\"notion-row\"\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-bookmark notion-block-11be5a01c4ec4b2abb68cbf4b3bc73dc\" href=\"https://github.com/TencentBlueKing/python-best-practices\"\u003e\u003cdiv\u003e\u003cdiv class=\"notion-bookmark-title\"\u003eGitHub - TencentBlueKing/python-best-practices\u003c/div\u003e\u003cdiv class=\"notion-bookmark-description\"\u003eContribute to TencentBlueKing/python-best-practices development by creating an account on GitHub.\u003c/div\u003e\u003cdiv class=\"notion-bookmark-link\"\u003e\u003cimg src=\"https://github.com/favicon.ico\" alt=\"GitHub - TencentBlueKing/python-best-practices\" loading=\"lazy\"/\u003e\u003cdiv\u003ehttps://github.com/TencentBlueKing/python-best-practices\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-bookmark-image\"\u003e\u003cimg src=\"https://opengraph.githubassets.com/e9d11601584d87c0fbb4092264f7ab23a33987f8d05dfb8b0e0c57157aecc9b3/TencentBlueKing/python-best-practices\" alt=\"GitHub - TencentBlueKing/python-best-practices\" loading=\"lazy\"/\u003e\u003c/div\u003e\u003c/a\u003e\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-c4cb7b9d7d92463eb7dd154161269031\"\u003e我和团队小伙伴整理了很多 Python\\Django\\DRF 的最佳实践经验，项目会持续更新，欢迎一起探讨维护，希望每一个 CRUD 男孩/女孩都能少踩坑。\u003c/div\u003e\u003c/main\u003e]]\u003e\u003c/content\u003e\n    \u003c/entry\u003e\n    \u003centry\u003e\n        \u003ctitle type=\"html\"\u003e\u003c![CDATA[ReDoS：正则也许会让你的系统更脆弱]]\u003e\u003c/title\u003e\n        \u003cid\u003ehttps://next.emergencyexit.xyz//redos-and-why\u003c/id\u003e\n        \u003clink href=\"https://next.emergencyexit.xyz//redos-and-why\"/\u003e\n        \u003cupdated\u003e2022-03-01T00:00:00.000Z\u003c/updated\u003e\n        \u003csummary type=\"html\"\u003e\u003c![CDATA[“充数的文章描述”]]\u003e\u003c/summary\u003e\n        \u003ccontent type=\"html\"\u003e\u003c![CDATA[\u003cmain class=\"notion light-mode notion-page notion-block-9d18b689cdc24d3f81daa690c700caee\"\u003e\u003cdiv class=\"notion-viewport\"\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-of-contents notion-gray notion-block-71c5c2ad3a0042a5854d1ffd540fb85b\"\u003e\u003ca href=\"#16167b014e884180872922c343d81f2f\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:0\"\u003e引\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#06a24e1d70ff4b4d8890c4411ad92c88\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:0\"\u003eEvil Regex 大敌当前\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#11ab27b4d2ec4f7399a9aecafa750e00\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:0\"\u003e知己知彼，百战不殆\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#1596c45ca40b4f4998f3be993530b2ee\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:24px\"\u003eNFA vs DFA\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#b0f1e34a5f0242bb83f7f49d56c2621f\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:24px\"\u003eThompson NFA 构造 vs DFA\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#ddeb7f785eb14d7b868a6917822d6ab5\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:24px\"\u003e为什么主流编程语言这么慢？\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#6e320bb2c4334d31af6172db35ede111\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:0\"\u003e正面对抗 Evil Regex\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#8a414c655d0842eb9a242a88266b28e7\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:24px\"\u003epyre2\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#12c4a78bedf14dcf8397441db47e3f36\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:24px\"\u003eregex\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#8ef69d8b54184936a684009d1c35948e\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:0\"\u003e总结\u003c/span\u003e\u003c/a\u003e\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-16167b014e884180872922c343d81f2f\" data-id=\"16167b014e884180872922c343d81f2f\"\u003e\u003cspan\u003e\u003cdiv id=\"16167b014e884180872922c343d81f2f\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#16167b014e884180872922c343d81f2f\" title=\"引\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e引\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-64a4a303b845467c8de321306c3fee84\"\u003e这里有一段看起来稀松平常、人畜无害的 Python 代码，你可以试着执行一下：\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e re\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e time\n\n\nvalue \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"aaaaaaaaaaaaaaaaaaaaaaaaaaaaabs\"\u003c/span\u003e\nstrange_regex \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e re\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecompile\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"(a+)+s\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\nstart \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003etime\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nre\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ematch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estrange_regex\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e value\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nend \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003etime\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eend \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e start\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-6bb9397fa1ab4801b7edd5bff3e9243b\"\u003e不知道大家执行了多久，在我开发机上使用 Python 3.6+（包括 3.10.x）\u003cb\u003e需要耗费20秒以上\u003c/b\u003e，即使 CPU ——Apple M1 Pro 的性能已经相当强悍了。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-e33e99798c1f48bd897156f2a344cbf3\"\u003e可以试想一下，如果在生产环境服务的关键请求链路中存在这样正则匹配，加上不可控的用户输入，很容易落入“性能陷阱”，轻则拖慢系统，重则直接让服务暴露在 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://en.wikipedia.org/wiki/ReDoS\"\u003eReDoS\u003c/a\u003e (Regual Expression Denial-of-Service) 的风险之下。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-429048f3ea3c4f989258b2e1a3aa81c4\"\u003e随手一搜，已经有不少相关的案例发生：\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-23343\"\u003eCVE-2021-23343\u003c/a\u003e 、\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-41817\"\u003eCVE-2021-41817\u003c/a\u003e。所以，它值得我们格外重视。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-06a24e1d70ff4b4d8890c4411ad92c88\" data-id=\"06a24e1d70ff4b4d8890c4411ad92c88\"\u003e\u003cspan\u003e\u003cdiv id=\"06a24e1d70ff4b4d8890c4411ad92c88\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#06a24e1d70ff4b4d8890c4411ad92c88\" title=\"Evil Regex 大敌当前\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eEvil Regex 大敌当前\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-421e347965f04238accb85b4748a20b0\"\u003e先来看一些和上面例子类似的、典型的邪恶正则：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-98d8301372354699a816e8fd5bc08002\"\u003e\u003cli\u003e\u003ccode class=\"notion-inline-code\"\u003e(a+)+\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-0d6cd58d075b49089d85ceaf2ab1753e\"\u003e\u003cli\u003e\u003ccode class=\"notion-inline-code\"\u003e([a-zA-Z]+)*\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-51804104983f4c3981f8d0f152a88f9f\"\u003e\u003cli\u003e\u003ccode class=\"notion-inline-code\"\u003e(a|aa)+\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-d0d2e591195a4ac8b863524a9b98eba7\"\u003e\u003cli\u003e\u003ccode class=\"notion-inline-code\"\u003e(a|a?)+\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-c6b2c4201dcd4463b918ba3275a4887b\"\u003e\u003cli\u003e\u003ccode class=\"notion-inline-code\"\u003e(a|a)+$\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-b4e5e7f0f44740ff8b09a30eb3ab254a\"\u003e\u003cli\u003e \u003ccode class=\"notion-inline-code\"\u003e(.*a){x} for x \\\u0026gt; 10\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-text notion-block-95a16b9277c84bd788ffad18af9382a9\"\u003e它们都有共同的一些特点：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-eb56bd6f90c74deaaf58989c90b25b0a\"\u003e\u003cli\u003e存在子表达重复——形如 \u003ccode class=\"notion-inline-code\"\u003e()+\u003c/code\u003e 、 \u003ccode class=\"notion-inline-code\"\u003e()*\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-0f99c854d6a74797b1fb0c53db1de6a8\"\u003e\u003cli\u003e在重复的子表达中：\u003c/li\u003e\u003cul class=\"notion-list notion-list-disc notion-block-0f99c854d6a74797b1fb0c53db1de6a8\"\u003e\u003cli\u003e存在重复项—— \u003ccode class=\"notion-inline-code\"\u003e(a+)+\u003c/code\u003e\u003c/li\u003e\u003cli\u003e存在交替重复—— \u003ccode class=\"notion-inline-code\"\u003e(a|aa)+\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-481496a757be470f9f6e511dc06659e9\"\u003e\u003cli\u003e在重复的子表达的末尾，存在一个子表达式无法匹配的内容，例如 \u003ccode class=\"notion-inline-code\"\u003e(a|a)+$\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-text notion-block-a492ebc689144979995324686ba5ca7f\"\u003e那么为什么这些重复会导致匹配速度如此之慢呢？我们要看看正则的具体实现思路。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-11ab27b4d2ec4f7399a9aecafa750e00\" data-id=\"11ab27b4d2ec4f7399a9aecafa750e00\"\u003e\u003cspan\u003e\u003cdiv id=\"11ab27b4d2ec4f7399a9aecafa750e00\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#11ab27b4d2ec4f7399a9aecafa750e00\" title=\"知己知彼，百战不殆\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e知己知彼，百战不殆\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-492dbeb1cfc1451b95d0a1dbecd70d7a\"\u003e当前主流语言的正则实现机制都是构建\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://en.wikipedia.org/wiki/Nondeterministic_finite_automaton\"\u003e\u003cb\u003e非确定有限状态自动机(NFA)\u003c/b\u003e\u003c/a\u003e\u003cb\u003e \u003c/b\u003e，相较于\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://en.wikipedia.org/wiki/Deterministic_finite_automaton\"\u003e\u003cb\u003e确定有限状态自动机(DFA)\u003c/b\u003e\u003c/a\u003e，前者会使用\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://en.wikipedia.org/wiki/Backtracking\"\u003e回溯法(backtracking)\u003c/a\u003e，这也是导致邪恶正则存在的根因。\u003c/div\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-1596c45ca40b4f4998f3be993530b2ee\" data-id=\"1596c45ca40b4f4998f3be993530b2ee\"\u003e\u003cspan\u003e\u003cdiv id=\"1596c45ca40b4f4998f3be993530b2ee\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#1596c45ca40b4f4998f3be993530b2ee\" title=\"NFA vs DFA\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eNFA vs DFA\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cdiv class=\"notion-text notion-block-3f9b78a623b0451c9cf0799a903fdc0b\"\u003e（该章节中的图例均来自\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://swtch.com/~rsc/regexp/regexp1.html\"\u003e这篇文章\u003c/a\u003e，我在这里做了内容简化，建议有兴趣的同学阅读英文原文）\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-620943d008c0426da775e5a82b0f2f74\"\u003eFA 有限自动机，又称 FSM 有限状态机，在当前的语境下，我们统一都是用 FA 来描述。这种计算模型比较常见，所以我们就着重关注 NFA 和 DFA 的对比。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-36f538b5c08e41df94547097e1490efd\"\u003e首先，来看一个简单的正则表达式—— \u003ccode class=\"notion-inline-code\"\u003ea(bb)+a\u003c/code\u003e ，它可以转换成以下两种表达：\u003c/div\u003e\u003cdiv class=\"notion-row notion-block-8b914cd473c64b568ab10330ec59c60f\"\u003e\u003cdiv class=\"notion-column notion-block-9cbe557272fc42eb982c33bdfb7972bd\" style=\"width:calc((100% - (1 * min(32px, 4vw))) * 0.5)\"\u003e\u003cfigure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-64d3af5c94464206883ad1543abd6203\"\u003e\u003cdiv style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:54px\"\u003e\u003cimg style=\"object-fit:contain\" src=\"https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fe41cc1a4-ae04-422e-8a4d-22e77e03d496%2FUntitled.png?table=block\u0026amp;id=64d3af5c-9446-4206-883a-d1543abd6203\u0026amp;cache=v2\" loading=\"lazy\" alt=\"DFA\" decoding=\"async\"/\u003e\u003cfigcaption class=\"notion-asset-caption\"\u003eDFA\u003c/figcaption\u003e\u003c/div\u003e\u003c/figure\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003cdiv class=\"notion-column notion-block-3a10ae26ed6b4fee9b000d4e03623deb\" style=\"width:calc((100% - (1 * min(32px, 4vw))) * 0.5)\"\u003e\u003cfigure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-6fdf1be8b201455488080f316c0cea35\"\u003e\u003cdiv style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:54px\"\u003e\u003cimg style=\"object-fit:contain\" src=\"https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F18765429-1c82-4046-9afe-21a3a68d505d%2FUntitled.png?table=block\u0026amp;id=6fdf1be8-b201-4554-8808-0f316c0cea35\u0026amp;cache=v2\" loading=\"lazy\" alt=\"NFA\" decoding=\"async\"/\u003e\u003cfigcaption class=\"notion-asset-caption\"\u003eNFA\u003c/figcaption\u003e\u003c/div\u003e\u003c/figure\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-351ce2ee5b03445fa5e21f10c9d4c8f5\"\u003e上面两张图能够很清晰地表现出二者的不同：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-0f74de50e44b48628c88eb34d668addd\"\u003e\u003cli\u003eDFA 中，每一个状态在接收到输入时，下一个状态都是确定的。\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-6db506c14054421eb3826a97952bf93c\"\u003e\u003cli\u003eNFA 中，存在某些状态在接收到输入时，无法确定下一个状态：例如图中的 S2 接收到字符 b，S1 和 S3 都是可能的下一个状态。所以系统在分支选择时，需要进行猜测。\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-text notion-block-1b2eff3ae49e4c19b23519afe1033bfd\"\u003e理论上，每一条正则表达式都可以等同转换成一个 NFA 状态机，那么如果使用 NFA 进行匹配，如何处理猜测分支就很重要了。下面我们来看一个简单遍历猜测的例子。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-61de96581b8649f9a63000513ca7458b\"\u003e根据正则 \u003ccode class=\"notion-inline-code\"\u003eabab|abbb\u003c/code\u003e 我们可以建立如下的 NFA：\u003c/div\u003e\u003cfigure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-a81212ec0de24ed5befc71a01610d802\"\u003e\u003cdiv style=\"position:relative;display:flex;justify-content:center;align-self:center;width:364px;max-width:100%;flex-direction:column\"\u003e\u003cimg style=\"object-fit:contain\" src=\"https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F100299f6-ef9d-41f6-b77c-dfbcb1644614%2FUntitled.png?table=block\u0026amp;id=a81212ec-0de2-4ed5-befc-71a01610d802\u0026amp;cache=v2\" loading=\"lazy\" alt=\"notion image\" decoding=\"async\"/\u003e\u003c/div\u003e\u003c/figure\u003e\u003cdiv class=\"notion-text notion-block-9d8ec084d55741759e4c296c58045065\"\u003e模拟计算机匹配输入 \u003ccode class=\"notion-inline-code\"\u003eabbb\u003c/code\u003e，可以有如下两种路径：\u003c/div\u003e\u003cfigure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-e4c28ba34b134c6ca5a9a0d69c02ed8f\"\u003e\u003cdiv style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"\u003e\u003cimg style=\"object-fit:contain\" src=\"https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F2d01c07f-0cde-40f3-8ad1-837137c1d9d8%2FUntitled.png?table=block\u0026amp;id=e4c28ba3-4b13-4c6c-a5a9-a0d69c02ed8f\u0026amp;cache=v2\" loading=\"lazy\" alt=\"notion image\" decoding=\"async\"/\u003e\u003c/div\u003e\u003c/figure\u003e\u003cdiv class=\"notion-text notion-block-0fd8ce7c02894191b05b1c13de3bf6d6\"\u003e以 Step 0 开始的路径，在匹配到第三个字符时出错，此时不得不采用回溯，再次从一开始进行匹配，即 Step 4 → Step 8。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-98ec072a50a04ad68c2e3b7317d2b355\"\u003e通过这个回溯方法，我们来思考正则表达式 \u003cspan role=\"button\" tabindex=\"0\" class=\"notion-equation notion-equation-inline\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e 与字符串 \u003cspan role=\"button\" tabindex=\"0\" class=\"notion-equation notion-equation-inline\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e 匹配：\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-50124f3a5808418c8ce289482e7c3f29\"\u003e如果每一次判断 \u003cspan role=\"button\" tabindex=\"0\" class=\"notion-equation notion-equation-inline\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e 是否存在时，都会尝试匹配“存在”的情况，再匹配不存在的情况，而整个字符串长度为 \u003cspan role=\"button\" tabindex=\"0\" class=\"notion-equation notion-equation-inline\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e，也就是时间复杂度为  \u003cspan role=\"button\" tabindex=\"0\" class=\"notion-equation notion-equation-inline\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-d65ba5a0c9b140f9a94c6fd9c0987fce\"\u003e当前主流的语言（Perl, PCRE, Python, Ruby等）采用了\u003cb\u003e递归\u003c/b\u003e来实现深度优先回溯，相较于 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://en.wikipedia.org/wiki/Thompson%27s_construction\"\u003eThompson NFA\u003c/a\u003e，最终实现的效果都是惊人的糟糕。\u003c/div\u003e\u003cdiv class=\"notion-row notion-block-4088dc8fdb2b46e39e930be62fcd58b6\"\u003e\u003cdiv class=\"notion-column notion-block-cf952c80f58d42c494f54b20d578f2b2\" style=\"width:calc((100% - (1 * min(32px, 4vw))) * 0.5)\"\u003e\u003cfigure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-08040b98a5b94de2945d4247f370a6ec\"\u003e\u003cdiv style=\"position:relative;display:flex;justify-content:center;align-self:center;width:301px;max-width:100%;flex-direction:column\"\u003e\u003cimg style=\"object-fit:contain\" src=\"https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F62d6c97a-651f-4dae-9157-3711b51864ef%2FUntitled.png?table=block\u0026amp;id=08040b98-a5b9-4de2-945d-4247f370a6ec\u0026amp;cache=v2\" loading=\"lazy\" alt=\"notion image\" decoding=\"async\"/\u003e\u003c/div\u003e\u003c/figure\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003cdiv class=\"notion-column notion-block-98b4b7afbadd4ca487963dc17f121754\" style=\"width:calc((100% - (1 * min(32px, 4vw))) * 0.5)\"\u003e\u003cfigure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-46b7fb61de5e43cda2bb4539a1289ce4\"\u003e\u003cdiv style=\"position:relative;display:flex;justify-content:center;align-self:center;width:302px;max-width:100%;flex-direction:column\"\u003e\u003cimg style=\"object-fit:contain\" src=\"https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc1b2f543-8d54-4deb-be08-868bc57b76b6%2FUntitled.png?table=block\u0026amp;id=46b7fb61-de5e-43cd-a2bb-4539a1289ce4\u0026amp;cache=v2\" loading=\"lazy\" alt=\"notion image\" decoding=\"async\"/\u003e\u003c/div\u003e\u003c/figure\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003c/div\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-b0f1e34a5f0242bb83f7f49d56c2621f\" data-id=\"b0f1e34a5f0242bb83f7f49d56c2621f\"\u003e\u003cspan\u003e\u003cdiv id=\"b0f1e34a5f0242bb83f7f49d56c2621f\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#b0f1e34a5f0242bb83f7f49d56c2621f\" title=\"Thompson NFA 构造 vs DFA\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eThompson NFA 构造 vs DFA\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cdiv class=\"notion-text notion-block-afff615182dc435797079cc33b8aefd7\"\u003e为什么使用了 Thompson NFA 构造出的正则匹配会快这么多呢？主要的原因是：通过划分多个子表达式，合并相同的内容，从而减少了回溯次数。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-6cdd0a3f42c640deb1ff811859b6d99d\"\u003e\u003cspan role=\"button\" tabindex=\"0\" class=\"notion-equation notion-equation-inline\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e 可以转换成 Thompson 构造，图示：\u003c/div\u003e\u003cfigure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-bd7f13b291b6492a8f8a5d6ca6538309\"\u003e\u003cdiv style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"\u003e\u003cimg style=\"object-fit:contain\" src=\"https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F72c2591d-be7f-4f93-b93b-30904f2f6b6c%2FUntitled.png?table=block\u0026amp;id=bd7f13b2-91b6-492a-8f8a-5d6ca6538309\u0026amp;cache=v2\" loading=\"lazy\" alt=\"notion image\" decoding=\"async\"/\u003e\u003c/div\u003e\u003c/figure\u003e\u003cdiv class=\"notion-text notion-block-4adb904d36044ce89832ec563f19787d\"\u003e稍微做一些解释：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-294f0999d9db457992ec78d4fcf9fe15\"\u003e\u003cli\u003eq 是开始，f 是结束，白圈是状态，连线是流转\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-c912429971304c0ca8c14ebace72871d\"\u003e\u003cli\u003eε 代表着无输入\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-text notion-block-9e2bbaa903264df6abc8ed9da0294974\"\u003e通过以上的结构，Thompson NFA 匹配的时间复杂度为  \u003cspan role=\"button\" tabindex=\"0\" class=\"notion-equation notion-equation-inline\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e，空间复杂度为\u003cspan role=\"button\" tabindex=\"0\" class=\"notion-equation notion-equation-inline\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e。\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-260ec4a9ed5046938614b4ab45ae7d56\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-bd241b5ae0bf4d23b71a7cdd8c3e8648\"\u003e而 DFA 更容易理解，因为它是典型的空间换时间。\u003c/div\u003e\u003cdiv class=\"notion-row notion-block-8b5cf75e5a9943e0899a0d186eb3497b\"\u003e\u003cdiv class=\"notion-column notion-block-acc05c036d394d77997d269693990926\" style=\"width:calc((100% - (1 * min(32px, 4vw))) * 0.5)\"\u003e\u003cfigure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-dd9acf4affef4e29a77df33a9f6ee061\"\u003e\u003cdiv style=\"position:relative;display:flex;justify-content:center;align-self:center;width:424px;max-width:100%;flex-direction:column\"\u003e\u003cimg style=\"object-fit:contain\" src=\"https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F7febb121-726d-47a6-80c5-9351397addd6%2FUntitled.png?table=block\u0026amp;id=dd9acf4a-ffef-4e29-a77d-f33a9f6ee061\u0026amp;cache=v2\" loading=\"lazy\" alt=\"NFA\" decoding=\"async\"/\u003e\u003cfigcaption class=\"notion-asset-caption\"\u003eNFA\u003c/figcaption\u003e\u003c/div\u003e\u003c/figure\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003cdiv class=\"notion-column notion-block-c621a865b06447f4b2fd833d81b688d3\" style=\"width:calc((100% - (1 * min(32px, 4vw))) * 0.5)\"\u003e\u003cfigure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-d8d60f096b0f4e069dc8b2409811f5ac\"\u003e\u003cdiv style=\"position:relative;display:flex;justify-content:center;align-self:center;width:496px;max-width:100%;flex-direction:column\"\u003e\u003cimg style=\"object-fit:contain\" src=\"https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F903b942f-49b7-4953-923c-55fb6d520bd5%2FUntitled.png?table=block\u0026amp;id=d8d60f09-6b0f-4e06-9dc8-b2409811f5ac\u0026amp;cache=v2\" loading=\"lazy\" alt=\"DFA\" decoding=\"async\"/\u003e\u003cfigcaption class=\"notion-asset-caption\"\u003eDFA\u003c/figcaption\u003e\u003c/div\u003e\u003c/figure\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-323df8cbfe25433eba3d392eb38f2e8b\"\u003e可以看到每一个 DFA 的状态都等同于某一时刻 NFA 状态列表，所以 DFA 在最坏情况下，空间复杂度 \u003cspan role=\"button\" tabindex=\"0\" class=\"notion-equation notion-equation-inline\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e，也会在构建阶段消耗更多时间。同时没有了回溯，整个匹配时间就是字符串长度，复杂度为 \u003cspan role=\"button\" tabindex=\"0\" class=\"notion-equation notion-equation-inline\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e。为了保证 DFA 的空间消耗，一般都会额外对构建出的 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://en.wikipedia.org/wiki/DFA_minimization\"\u003eDFA 做简化\u003c/a\u003e，减少图的大小。\u003c/div\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-ddeb7f785eb14d7b868a6917822d6ab5\" data-id=\"ddeb7f785eb14d7b868a6917822d6ab5\"\u003e\u003cspan\u003e\u003cdiv id=\"ddeb7f785eb14d7b868a6917822d6ab5\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#ddeb7f785eb14d7b868a6917822d6ab5\" title=\"为什么主流编程语言这么慢？\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e为什么主流编程语言这么慢？\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cdiv class=\"notion-text notion-block-556cfad12c9a4e90bc6a5aa982a85b89\"\u003e说来有趣，Thompson NFA 构造法应该是编译原理的基础概念，DFA 方法从概念上也是比较简单，为什么当前的主流语言没有采用，反而采用了一个带有回溯的、效果远逊的版本？\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-4b68cbc5f2e14f5bbff6d29e174812aa\"\u003e经过一番冲浪搜索，简单概括我找到的结论：\u003cb\u003e历史的局限\u003c/b\u003e。\u003c/div\u003e\u003cblockquote class=\"notion-quote notion-block-f0186a0b42784296a704da19665a61ff\"\u003e\u003cem\u003eWhile writing the text editor sam [6] in the early 1980s, Rob Pike wrote a new regular expression implementation, which Dave Presotto extracted into a library that appeared in the Eighth Edition. Pike\u0026#x27;s implementation incorporated submatch tracking into an efficient NFA simulation but, like the rest of the Eighth Edition source, was not widely distributed. Pike himself did not realize that his technique was anything new. \u003c/em\u003e\u003cspan class=\"notion-red\"\u003e\u003cem\u003eHenry Spencer reimplemented the Eighth Edition library interface from scratch, but using backtracking, and released his implementation into the public domain.\u003c/em\u003e\u003c/span\u003e\u003cem\u003e \u003c/em\u003e\u003cspan class=\"notion-red\"\u003e\u003cem\u003eIt became very widely used, eventually serving as the basis for the slow regular expression implementations mentioned earlier: Perl, PCRE, Python, and so on.\u003c/em\u003e\u003c/span\u003e\u003c/blockquote\u003e\u003cdiv class=\"notion-text notion-block-7f091f2eb6e74c62bbd877d83c1d92a8\"\u003e可以从上文得知，正则匹配的实现首先需要兼容原来的使用方式，而当时开发者并未了解 NFA 模拟方法，而是自己从零实现了一个回溯方法，并且被广泛地传播开了。即使这个实现很慢，但是由于已经被大规模采用，且能满足大多数的使用场景，各个主流语言也没有替换它。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-6e320bb2c4334d31af6172db35ede111\" data-id=\"6e320bb2c4334d31af6172db35ede111\"\u003e\u003cspan\u003e\u003cdiv id=\"6e320bb2c4334d31af6172db35ede111\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#6e320bb2c4334d31af6172db35ede111\" title=\"正面对抗 Evil Regex\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e正面对抗 Evil Regex\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-ed1e3a4cebbf4d4689dc02e9e576134b\"\u003e既然当前主流语言的实现肯定会存在性能陷阱，我们是否有办法检测邪恶正则呢？答案是肯定的。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-787a7eab4c8143eea147b25f34efb1c4\"\u003e在社区里有不少相关项目，例如：\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/doyensec/regexploit\"\u003eregexploit\u003c/a\u003e 、\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/olivo/redos-detector\"\u003eredos-detector\u003c/a\u003e 、\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/davisjam/vuln-regex-detector\"\u003evuln-regex-detector\u003c/a\u003e 等，它们都可以扫描出有风险的正则，就像这样：\u003c/div\u003e\u003cpre class=\"notion-code language-shell\"\u003e\u003ccode class=\"language-shell\"\u003e$ echo \u003cspan class=\"token string\"\u003e\"(a+)+s\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e regexploit\n\u003cspan class=\"token literal-property property\"\u003ePattern\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003es\n\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eRedos\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estarriness\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e11\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e prefix_sequence\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token constant\"\u003eSEQ\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e redos_sequence\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token constant\"\u003eSEQ\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003es\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e repeated_character\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e killer\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eNone\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nWorst\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"token literal-property property\"\u003ecomplexity\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e11\u003c/span\u003e \u003cspan class=\"token function\"\u003e⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eexponential\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nRepeated character\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token literal-property property\"\u003eExample\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'a'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e3456\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-1e6c9924ca8148c2adbe7335b9bf6c62\"\u003e但是它们局限于静态的正则扫描，对于我们开发者而言，静态防御并不能完全清除风险。更好的思路是直接替换语言的默认实现。以 Python 举例，我们也找到了一些替换库：\u003c/div\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-8a414c655d0842eb9a242a88266b28e7\" data-id=\"8a414c655d0842eb9a242a88266b28e7\"\u003e\u003cspan\u003e\u003cdiv id=\"8a414c655d0842eb9a242a88266b28e7\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#8a414c655d0842eb9a242a88266b28e7\" title=\"pyre2\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003epyre2\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cpre class=\"notion-code language-shell\"\u003e\u003ccode class=\"language-shell\"\u003epip install pyre2\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-efda542abaf5447f92a67e6709475006\"\u003e来自 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/google/re2/\"\u003eGoogle re2\u003c/a\u003e 模块的 Python 封装 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/facebook/pyre2\"\u003epyre2\u003c/a\u003e，使用了 DFA 的构造方式。可以替换原生 \u003ccode class=\"notion-inline-code\"\u003ere\u003c/code\u003e 模块，大多数场景都可以得到速度的稳步提升，不存在性能陷阱。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-289140745a58440b96faea1ec82f6395\"\u003e但对于 DFA 模拟来说，都是自古华山一条道，比如 \u003ccode class=\"notion-inline-code\"\u003e(?P=\u0026lt;name\u0026gt;)\u003c/code\u003e 这样的属于 \u003ccode class=\"notion-inline-code\"\u003ebackreference\u003c/code\u003e 的捕获组语法就无法支持了。\u003c/div\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-12c4a78bedf14dcf8397441db47e3f36\" data-id=\"12c4a78bedf14dcf8397441db47e3f36\"\u003e\u003cspan\u003e\u003cdiv id=\"12c4a78bedf14dcf8397441db47e3f36\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#12c4a78bedf14dcf8397441db47e3f36\" title=\"regex\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eregex\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cpre class=\"notion-code language-shell\"\u003e\u003ccode class=\"language-shell\"\u003epip install regex\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-1f35e9047a1c4d47a37d67ce17ed1e04\"\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/mrabarnett/mrab-regex\"\u003eregex\u003c/a\u003e 模块\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/mrabarnett/mrab-regex/issues/136\"\u003e并未使用 DFA 构造\u003c/a\u003e，在完全兼容 \u003ccode class=\"notion-inline-code\"\u003ere\u003c/code\u003e 模块的同时，支持了一些\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/mrabarnett/mrab-regex#old-vs-new-behaviour\"\u003e新特性\u003c/a\u003e。由于实现方案的不同，也没有很明确的文档阐述，尚不清楚它具体的算法（\u003cem\u003e有待进一步从代码层面解读\u003c/em\u003e），但是从效果上，它的性能要\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/mrabarnett/mrab-regex/issues/320\"\u003e略好于原生模块\u003c/a\u003e，仅从文中里例子测试看来，也规避了性能陷阱，可以谨慎采用。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-8ef69d8b54184936a684009d1c35948e\" data-id=\"8ef69d8b54184936a684009d1c35948e\"\u003e\u003cspan\u003e\u003cdiv id=\"8ef69d8b54184936a684009d1c35948e\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#8ef69d8b54184936a684009d1c35948e\" title=\"总结\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e总结\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cul class=\"notion-list notion-list-disc notion-block-4c31a30c7e0e4ba19ea2a53dafd478c5\"\u003e\u003cli\u003e和很多其他场景一样，程序需要时刻警惕用户的输入，任何不经过校验的内容都可能将程序拖垮。\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-18e7ee68eda94a45b67b4c11dffeb5a7\"\u003e\u003cli\u003e理论和实际存在各种各样的鸿沟，在面临现实场景时，理想的想法落地总是困难的。\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-a5f4f5f11c0843a7b1ab7a3cbee60843\"\u003e\u003cli\u003e原生不代表就是最优秀的。有特殊需求时可以使用社区方案进行替换。\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-blank notion-block-3672e91b6a7c4125b6980f6f543b1536\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-b38fb92df2184f5096ca8ac1e6c65b00\"\u003e参考：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-2d5c165011ab41b7950ff02c9a393e88\"\u003e\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://swtch.com/~rsc/regexp/regexp1.html\"\u003ehttps://swtch.com/~rsc/regexp/regexp1.html\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-67c19c430a1c49d1ac8563f6f162c2ef\"\u003e\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS\"\u003ehttps://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-b05ea5bd8ae540baa38b654a5b723fac\"\u003e\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://shivankaul.com/blog/nfa-dfa-and-regexes\"\u003ehttps://shivankaul.com/blog/nfa-dfa-and-regexes\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-0049a5a2d6d54dae964b80639ecb4144\"\u003e\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://arstechnica.com/civis/viewtopic.php?f=20\u0026amp;t=1195549\"\u003ehttps://arstechnica.com/civis/viewtopic.php?f=20\u0026amp;t=1195549\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-237dd0aa005e4059a61b62f30bed7dc0\"\u003e\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://news.ycombinator.com/item?id=466957\"\u003ehttps://news.ycombinator.com/item?id=466957\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-9da5e5cb8a684f21bd2f67051397c140\"\u003e\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://medium.com/swlh/visualizing-thompsons-construction-algorithm-for-nfas-step-by-step-f92ef378581b\"\u003ehttps://medium.com/swlh/visualizing-thompsons-construction-algorithm-for-nfas-step-by-step-f92ef378581b\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-blank notion-block-3f8d2e743c47466294fb92ded6f58558\"\u003e \u003c/div\u003e\u003c/main\u003e]]\u003e\u003c/content\u003e\n    \u003c/entry\u003e\n    \u003centry\u003e\n        \u003ctitle type=\"html\"\u003e\u003c![CDATA[旧代码拾遗：如何在 Python 代码中修改 DNS 解析]]\u003e\u003c/title\u003e\n        \u003cid\u003ehttps://next.emergencyexit.xyz//update-dns-in-python\u003c/id\u003e\n        \u003clink href=\"https://next.emergencyexit.xyz//update-dns-in-python\"/\u003e\n        \u003cupdated\u003e2022-02-18T00:00:00.000Z\u003c/updated\u003e\n        \u003csummary type=\"html\"\u003e\u003c![CDATA[旧代码拾遗]]\u003e\u003c/summary\u003e\n        \u003ccontent type=\"html\"\u003e\u003c![CDATA[\u003cmain class=\"notion light-mode notion-page notion-block-a6c3c98f9ef945de9d524baec7327464\"\u003e\u003cdiv class=\"notion-viewport\"\u003e\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-38daf52d57c342d4be99642547e69bec\" data-id=\"38daf52d57c342d4be99642547e69bec\"\u003e\u003cspan\u003e\u003cdiv id=\"38daf52d57c342d4be99642547e69bec\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#38daf52d57c342d4be99642547e69bec\" title=\"Why\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eWhy\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-86d81791a3264f1f850f6fb0215f7f8e\"\u003e我们访问 K8S 的 ApiServer 服务，由于为了保证安全性，证书中签发的域名仅包括 \u003ccode class=\"notion-inline-code\"\u003ekubernetes\u003c/code\u003e 和初始的有限 IP 列表，当 ApiServer 服务的 Master 节点需要被替换时，就无法使用新的节点 IP 访问了。解决的方案就是将 \u003ccode class=\"notion-inline-code\"\u003ekubernetes\u003c/code\u003e 域名和新的 IP 临时绑定，骗过证书校验。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-57a46d1303cc45398d79ae16a961b878\" data-id=\"57a46d1303cc45398d79ae16a961b878\"\u003e\u003cspan\u003e\u003cdiv id=\"57a46d1303cc45398d79ae16a961b878\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#57a46d1303cc45398d79ae16a961b878\" title=\"How？\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eHow？\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-0134574ed5fc47fdb7044f7ae5305657\"\u003e废话不多说，直接看代码\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003e# \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e coding\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e utf\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token number\"\u003e8\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e contextlib\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e importlib\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e threading\nfrom typing \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e Callable\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Dict\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Optional\n\nfrom urllib3\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eutil \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e connection\n\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eCustomLocalDnsResolver\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ethreading\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elocal\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\"支持线程级自定义 Dns 记录\n    \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\"\n\n    def \u003cspan class=\"token function\"\u003e__init__\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eself\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token literal-property property\"\u003edns_map\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e Optional\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003edict\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eNone\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        # 线程保存各自 dns_map，但是访问入口均为 dns_map\n        self\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edns_map \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e dns_map or \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\ndef \u003cspan class=\"token function\"\u003eget_patch_create_connection_with_dns\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edns_resolver\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e Callable\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"simply get patched create_connection\"\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\n\n    # 保留原方法\n    _orig_create_connection \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003egetattr\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eimportlib\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eimport_module\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'urllib3.util.connection'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e'create_connection'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n    def \u003cspan class=\"token function\"\u003epatched_create_connection\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaddress\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eargs\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e**\u003c/span\u003ekwargs\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"在 urllib3's create_connection 流程前解析 address\"\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\n        domain\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e port \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e address\n        # 当 _local_dns\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edns_map 为空，对正常流程无影响\n        host \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e dns_resolver\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edns_map\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edomain\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e domain\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003e_orig_create_connection\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehost\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e port\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eargs\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e**\u003c/span\u003ekwargs\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e patched_create_connection\n\n\n_local_dns \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eCustomLocalDnsResolver\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# patch 全局 create_connection\nconnection\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecreate_connection \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eget_patch_create_connection_with_dns\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e_local_dns\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\n@contextlib\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003econtextmanager\ndef \u003cspan class=\"token function\"\u003eupdate_local_dns_once\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edns_map\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e Dict\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"一次性修改线程 dns 解析\"\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\n    _local_dns\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edns_map \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e dns_map\n    \u003cspan class=\"token keyword\"\u003eyield\u003c/span\u003e\n    _local_dns\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edns_map \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\n# 具体的使用场景\n\u003cspan class=\"token keyword\"\u003ewith\u003c/span\u003e \u003cspan class=\"token function\"\u003eupdate_local_dns_once\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token string-property property\"\u003e\"kubernetes\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"192.168.1.1\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    # 可以在该 context 中请求外部系统\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-blank notion-block-d6c4207d6e5f406d98f2f7f01373402a\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-1798e8cd901544068cc7e842253d62bc\"\u003e \u003c/div\u003e\u003c/main\u003e]]\u003e\u003c/content\u003e\n    \u003c/entry\u003e\n    \u003centry\u003e\n        \u003ctitle type=\"html\"\u003e\u003c![CDATA[小记：如何将 Logstash7 镜像替换为 KonaJDK]]\u003e\u003c/title\u003e\n        \u003cid\u003ehttps://next.emergencyexit.xyz//use-konajdk-in-logstash-image\u003c/id\u003e\n        \u003clink href=\"https://next.emergencyexit.xyz//use-konajdk-in-logstash-image\"/\u003e\n        \u003cupdated\u003e2021-12-28T00:00:00.000Z\u003c/updated\u003e\n        \u003csummary type=\"html\"\u003e\u003c![CDATA[随手记录，简单却防遗忘]]\u003e\u003c/summary\u003e\n        \u003ccontent type=\"html\"\u003e\u003c![CDATA[\u003cmain class=\"notion light-mode notion-page notion-block-f7327b98b06a423a8b9f646e5ba2123f\"\u003e\u003cdiv class=\"notion-viewport\"\u003e\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-db808c0aadf3437d856ba61c501ddc3f\"\u003e \u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-56d00d6fc33c42f993dac1cac2f1192d\" data-id=\"56d00d6fc33c42f993dac1cac2f1192d\"\u003e\u003cspan\u003e\u003cdiv id=\"56d00d6fc33c42f993dac1cac2f1192d\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#56d00d6fc33c42f993dac1cac2f1192d\" title=\"Step 0 预备环境\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eStep 0 预备环境\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-a6c6802f89cd49ffa227d1412ba85e2e\"\u003eRake 是一个由 Ruby 实现的 Make-like 工具，可以用 Ruby 来编排项目任务流程，例如出二进制包、构建镜像等。在 GitHub Logstash 项目的 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/elastic/logstash/blob/main/rakelib/artifacts.rake\"\u003erakelib\u003c/a\u003e 里找到镜像构建逻辑。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-e2aa50674a46414493bdf4a5db0a4b63\"\u003e构建之前，需要保证构建机包含以下工具：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-21edbc015296410cb6d699195fb2c21a\"\u003e\u003cli\u003eDocker\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-b097a4840a8244bb9c6f71c05339decc\"\u003e\u003cli\u003eGNU Make\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-e3e863afff554e338340b7d47028d284\"\u003e\u003cli\u003ePython 3.5+ with Virtualenv\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-ec9f85330613463c8cb3c0baf40783b6\"\u003e\u003cli\u003eJRuby 9.1+ （实际上 Mac 自带 Ruby 也是可行的）\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-text notion-block-481102291cd947a7b7755166ccfb5104\"\u003e然后将 Logstash 项目 clone 到本地，并切换到预期修改的版本：\u003c/div\u003e\u003cpre class=\"notion-code language-bash\"\u003e\u003ccode class=\"language-bash\"\u003egit checkout v7\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token number\"\u003e16.2\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-77fd59e96d934fc29d55c6ffb4e0fb71\" data-id=\"77fd59e96d934fc29d55c6ffb4e0fb71\"\u003e\u003cspan\u003e\u003cdiv id=\"77fd59e96d934fc29d55c6ffb4e0fb71\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#77fd59e96d934fc29d55c6ffb4e0fb71\" title=\"Step 1 精简构建步骤\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eStep 1 精简构建步骤\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-71b0a3dec2a74de8a3cfddbcd89f377b\"\u003e构建步骤中，默认会包括 Windows\\MacOS 以及 Arm 的构建，如果你并不需要这些平台，可以如下手动修改构建步骤，能够大大加快你的构建速度：\u003c/div\u003e\u003cpre class=\"notion-code language-ruby\"\u003e\u003ccode class=\"language-ruby\"\u003e# \u003cspan class=\"token function\"\u003ecreate_archive_pack\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003elicense_details\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"x86_64\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"linux\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"windows\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"darwin\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003ecreate_archive_pack\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003elicense_details\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"x86_64\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"linux\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n# \u003cspan class=\"token function\"\u003ecreate_archive_pack\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003elicense_details\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"arm64\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"linux\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cfigcaption class=\"notion-asset-caption\"\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/elastic/logstash/blob/2cf6675f538247be091df9d31cc455538f029a07/rakelib/artifacts.rake#L142\"\u003eartifacts.rake\u003c/a\u003e\u003c/figcaption\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-912a6e2fab744f6e8b0f4b434806f701\" data-id=\"912a6e2fab744f6e8b0f4b434806f701\"\u003e\u003cspan\u003e\u003cdiv id=\"912a6e2fab744f6e8b0f4b434806f701\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#912a6e2fab744f6e8b0f4b434806f701\" title=\"Step 2 修改 Python 版本\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eStep 2 修改 Python 版本\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-2adb74e716a2480ea35f6f3b07850e98\"\u003e如果你不想为了构建镜像额外下载其他 Python 版本，可以手动修改 Makefile\u003c/div\u003e\u003cpre class=\"notion-code language-makefile\"\u003e\u003ccode class=\"language-makefile\"\u003e# \u003cspan class=\"token constant\"\u003ePY_VERSION\u003c/span\u003e \u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e3.6\u003c/span\u003e\u003cspan class=\"token number\"\u003e.13\u003c/span\u003e\n# \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e\n\u003cspan class=\"token constant\"\u003ePY_VERSION\u003c/span\u003e \u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e3.6\u003c/span\u003e\u003cspan class=\"token number\"\u003e.7\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cfigcaption class=\"notion-asset-caption\"\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/elastic/logstash/blob/2cf6675f538247be091df9d31cc455538f029a07/docker/Makefile#L3\"\u003eMakefile\u003c/a\u003e\u003c/figcaption\u003e\u003cdiv class=\"notion-text notion-block-bad578fd54a34a018be8aa73abcb9e3b\"\u003e理论上保证 Python 版本大于 3.5 即可。\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-53071725dbcc47bbacf124bd49fbb662\"\u003e \u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-2c3c96643334464f9ebc93d14cea61c2\" data-id=\"2c3c96643334464f9ebc93d14cea61c2\"\u003e\u003cspan\u003e\u003cdiv id=\"2c3c96643334464f9ebc93d14cea61c2\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#2c3c96643334464f9ebc93d14cea61c2\" title=\"Step 3 指定 JDK 版本\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eStep 3 指定 JDK 版本\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-9fc57152348c48088f81bdd78a10d2f1\"\u003e如标题所示，我们的目标是将 Logstash 镜像里的 OpenJDK 替换成 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/Tencent/TencentKona-11\"\u003eKonaJDK\u003c/a\u003e。构建时手动指定 JDK 地址即可\u003c/div\u003e\u003cpre class=\"notion-code language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token constant\"\u003eJDK_URL\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003ehttps\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003egithub\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecom\u003cspan class=\"token operator\"\u003e/\u003c/span\u003eTencent\u003cspan class=\"token operator\"\u003e/\u003c/span\u003eTencentKona\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token number\"\u003e11\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003ereleases\u003cspan class=\"token operator\"\u003e/\u003c/span\u003edownload\u003cspan class=\"token operator\"\u003e/\u003c/span\u003ekona11\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token number\"\u003e0.13\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003efiber\u003cspan class=\"token operator\"\u003e/\u003c/span\u003eTencentKona\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token number\"\u003e11.0\u003c/span\u003e\u003cspan class=\"token number\"\u003e.13\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eb1_jdk_fiber_linux\u003cspan class=\"token operator\"\u003e-\u003c/span\u003ex86_64\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etar\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003egz rake artifact\u003cspan class=\"token operator\"\u003e:\u003c/span\u003edocker\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-blank notion-block-26ebe1cc373b40a2af4165805f5c18f8\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-bf0dcb10928d45a9a50662a45d504b34\"\u003e等待构建，大功告成 xD\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-46d2d7251c9f4e1398e84f133d1796db\"\u003e \u003c/div\u003e\u003c/main\u003e]]\u003e\u003c/content\u003e\n    \u003c/entry\u003e\n    \u003centry\u003e\n        \u003ctitle type=\"html\"\u003e\u003c![CDATA[用 GraphQL 查询你的 Django 应用]]\u003e\u003c/title\u003e\n        \u003cid\u003ehttps://next.emergencyexit.xyz//use-graphql-with-django\u003c/id\u003e\n        \u003clink href=\"https://next.emergencyexit.xyz//use-graphql-with-django\"/\u003e\n        \u003cupdated\u003e2021-11-27T00:00:00.000Z\u003c/updated\u003e\n        \u003csummary type=\"html\"\u003e\u003c![CDATA[强是挺强，但适用场景依旧有限]]\u003e\u003c/summary\u003e\n        \u003ccontent type=\"html\"\u003e\u003c![CDATA[\u003cmain class=\"notion light-mode notion-page notion-full-width notion-block-9a08823eeec64cc09ec8890cb0650aa7\"\u003e\u003cdiv class=\"notion-viewport\"\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-of-contents notion-gray notion-block-7cbbabf5b06b4f1b832fe664023382bd\"\u003e\u003ca href=\"#6f80cc74a749486d8ad82ae7a1aea572\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:0\"\u003e什么是 GraphQL ？\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#5041039329414c21aaebd26612c47d03\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:0\"\u003e它有什么有意思的特性\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#5be2fa55f8854b9dae359baadc092859\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:24px\"\u003eFragments\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#51381a94e35a4a2790d130b10e46dbd2\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:24px\"\u003eDirectives\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#f7baf2676dcd4b14a48a5960996fbfbb\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:0\"\u003e和 REST 相比较有什么优势和劣势？\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#8b386b3470f74f38862ae13b9c8ee6e9\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:24px\"\u003eTLDR\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#1d318237ebd04d408d49f9a6ac2982d0\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:24px\"\u003evs 扩展的 REST 协议\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#3db8daa2fcb0409baa596fd5472b9ff3\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:0\"\u003e什么是 GraphQL 客户端?\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#499a5d133c9b493e946a692b0e21a062\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:0\"\u003e服务端落地：GraphQL → Django\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#8c904f70489a4268a7b5c8f4ca2d51e6\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:24px\"\u003e支持 Relay\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#3d929743493649a6a43da55924cdfa5e\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:24px\"\u003e引入 graphene-django-extras\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#0068853173e54e1bacc12aa21d51205d\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:24px\"\u003e鉴权\u003c/span\u003e\u003c/a\u003e\u003ca href=\"#10f53459be3844c7a1355a1ed5bd63b9\" class=\"notion-table-of-contents-item\"\u003e\u003cspan class=\"notion-table-of-contents-item-body\" style=\"display:inline-block;margin-left:0\"\u003e总结\u003c/span\u003e\u003c/a\u003e\u003c/div\u003e\u003cdiv class=\"notion-callout notion-gray_background_co notion-block-2986488d269c41b787a73096363557d2\"\u003e\u003cspan class=\"notion-page-icon\" role=\"img\" aria-label=\"😶‍🌫️\"\u003e😶‍🌫️\u003c/span\u003e\u003cdiv class=\"notion-callout-text\"\u003e全文以后端开发视角写作，部分涉及到前端开发的介绍可能存在错误或者不准确，欢迎在评论区斧正\u003c/div\u003e\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-6f80cc74a749486d8ad82ae7a1aea572\" data-id=\"6f80cc74a749486d8ad82ae7a1aea572\"\u003e\u003cspan\u003e\u003cdiv id=\"6f80cc74a749486d8ad82ae7a1aea572\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#6f80cc74a749486d8ad82ae7a1aea572\" title=\"什么是 GraphQL ？\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e什么是 GraphQL ？\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-9ce07e2a85a94064abc0f2e22d9324cf\"\u003e先来看看 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://zh.wikipedia.org/wiki/GraphQL\"\u003ewikipedia\u003c/a\u003e：\u003c/div\u003e\u003cblockquote class=\"notion-quote notion-block-5e3b15ce4caa4fc9a4bdf513a497a202\"\u003eGraphQL 是一个开源的，面向 API 而创造出来的数据查询操作语言以及相应的服务端运行环境。\u003c/blockquote\u003e\u003cdiv class=\"notion-text notion-block-46ff6eaaa64045318192214e00ed3b7a\"\u003eGraphQL 首先是一种查询语言，它定义了一种通用的数据查询方式，可以理解为一种通用的 SQL，只不过前者面向抽象的数据集，后者往往是具体的关系型数据库。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-2cbc564d204a449faf4f770a57101a88\"\u003e其次，它还包括一种服务端运行时，用于实现查询语句解析、数据类型定义。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-5041039329414c21aaebd26612c47d03\" data-id=\"5041039329414c21aaebd26612c47d03\"\u003e\u003cspan\u003e\u003cdiv id=\"5041039329414c21aaebd26612c47d03\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#5041039329414c21aaebd26612c47d03\" title=\"它有什么有意思的特性\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e它有什么有意思的特性\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-78e75c481cda4072b1e02f6cd843e186\"\u003e仅从后端开发视角，列举几个觉得有意思的特性\u003c/div\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-5be2fa55f8854b9dae359baadc092859\" data-id=\"5be2fa55f8854b9dae359baadc092859\"\u003e\u003cspan\u003e\u003cdiv id=\"5be2fa55f8854b9dae359baadc092859\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#5be2fa55f8854b9dae359baadc092859\" title=\"Fragments\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eFragments\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cpre class=\"notion-code language-graphql\"\u003e\u003ccode class=\"language-graphql\"\u003equery \u003cspan class=\"token function\"\u003eHeroComparison\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e\u003cspan class=\"token literal-property property\"\u003e$first\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e Int \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003eleftComparison\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token function\"\u003ehero\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e\u003cspan class=\"token literal-property property\"\u003eepisode\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token constant\"\u003eEMPIRE\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e...\u003c/span\u003ecomparisonFields\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003erightComparison\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token function\"\u003ehero\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e\u003cspan class=\"token literal-property property\"\u003eepisode\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token constant\"\u003eJEDI\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e...\u003c/span\u003ecomparisonFields\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\nfragment comparisonFields on Character \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  name\n  \u003cspan class=\"token function\"\u003efriendsConnection\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e\u003cspan class=\"token literal-property property\"\u003efirst\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e $first\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    totalCount\n    edges \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      node \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        name\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-c04278bd4ae44492a254104fde035325\"\u003e使用 Fragment 复用查询内容，并且可以定义参数\u003c/div\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-51381a94e35a4a2790d130b10e46dbd2\" data-id=\"51381a94e35a4a2790d130b10e46dbd2\"\u003e\u003cspan\u003e\u003cdiv id=\"51381a94e35a4a2790d130b10e46dbd2\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#51381a94e35a4a2790d130b10e46dbd2\" title=\"Directives\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eDirectives\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cpre class=\"notion-code language-graphql\"\u003e\u003ccode class=\"language-graphql\"\u003equery \u003cspan class=\"token function\"\u003eHero\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e\u003cspan class=\"token literal-property property\"\u003e$episode\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e Episode\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token literal-property property\"\u003e$withFriends\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e Boolean\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token function\"\u003ehero\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e\u003cspan class=\"token literal-property property\"\u003eepisode\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e $episode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    name\n    friends @\u003cspan class=\"token function\"\u003einclude\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e $withFriends\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      name\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n# variables\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token string-property property\"\u003e\"episode\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"JEDI\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token string-property property\"\u003e\"withFriends\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-50804a4e6c7d45c1a89613654cb0eedd\"\u003e可以通过通用的两种指令来控制一些字段的返回：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-b6b987cd363943509af04767f54d1795\"\u003e\u003cli\u003e \u003ccode class=\"notion-inline-code\"\u003e@include(if: Boolean)\u003c/code\u003e \u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-9d6988932833425689d6246356037357\"\u003e\u003cli\u003e \u003ccode class=\"notion-inline-code\"\u003e@skip(if: Boolean)\u003c/code\u003e \u003c/li\u003e\u003c/ul\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-f7baf2676dcd4b14a48a5960996fbfbb\" data-id=\"f7baf2676dcd4b14a48a5960996fbfbb\"\u003e\u003cspan\u003e\u003cdiv id=\"f7baf2676dcd4b14a48a5960996fbfbb\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#f7baf2676dcd4b14a48a5960996fbfbb\" title=\"和 REST 相比较有什么优势和劣势？\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e和 REST 相比较有什么优势和劣势？\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-8b386b3470f74f38862ae13b9c8ee6e9\" data-id=\"8b386b3470f74f38862ae13b9c8ee6e9\"\u003e\u003cspan\u003e\u003cdiv id=\"8b386b3470f74f38862ae13b9c8ee6e9\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#8b386b3470f74f38862ae13b9c8ee6e9\" title=\"TLDR\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eTLDR\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cdiv class=\"notion-text notion-block-b286d02d551a49ceb9c46c7736257409\"\u003eREST 更多是从 HTTP 协议出发的一种约定协议，因为受制于 HTTP 协议本身的设计，在\u003cb\u003e表达能力\u003c/b\u003e上是弱于\u003cb\u003e作为查询语言\u003c/b\u003e的 GraphQL 的。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-a88e97e928ae41ab81936449989916a6\"\u003e同时，REST 通常都是由后端开发者主动封装，而 GraphQL 则是由前端主动拼装。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-865d80be70cf4e4aaacde0d426f1e966\"\u003e所以如果面对的场景是\u003cspan class=\"notion-teal\"\u003e前端需求复杂而多变，GraphQL 肯定比 REST 更适合快速迭代。\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-d59f255d52314c30b7292fcf4312e374\"\u003e也正因此，GraphQL 在实现上更加繁复，所以\u003cspan class=\"notion-pink\"\u003e面对 API 数量少、需求不会轻易的场景时，REST 反而是更适合的技术选型。\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-dd6dda57e33e4cc4a158fe795567d923\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-bae7469dcdf3408cab30219494171505\"\u003e\u003cem\u003e作为后端开发，学习和使用 GraphQL 的动力，更多是\u003c/em\u003e\u003cem\u003e\u003cb\u003e想将自己从 CRUD 的泥沼中拯救出来，\u003c/b\u003e\u003c/em\u003e\u003cem\u003e将更多的精力放在其他更重要的技术上。\u003c/em\u003e\u003c/div\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-1d318237ebd04d408d49f9a6ac2982d0\" data-id=\"1d318237ebd04d408d49f9a6ac2982d0\"\u003e\u003cspan\u003e\u003cdiv id=\"1d318237ebd04d408d49f9a6ac2982d0\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#1d318237ebd04d408d49f9a6ac2982d0\" title=\"vs 扩展的 REST 协议\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003evs 扩展的 REST 协议\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cdiv class=\"notion-text notion-block-9b5c1dee8abf461f85b0cc6ab7187b8c\"\u003e（此小节中图片拷贝自\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://www.howtographql.com/basics/1-graphql-is-th\"\u003e网络\u003c/a\u003e，懒得画）\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-9f3b0d45de334ab4bbd7ee7edf38e4ff\"\u003e和 REST 一样，GraphQL 并不是什么开发框架，它只是定义了一种通用型查询的 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://en.wikipedia.org/wiki/Domain-specific_language\"\u003eDSL\u003c/a\u003e。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-9a384f67fe30477f978ff21b22e36de9\"\u003e而使用 REST 协议进行资源拉取，我们总是会面临一些实际的问题，而 GraphQL 可以在一定程度上解决。那么肯定会有同学在想，REST 是非常灵活的，完全可以通过自建一个查询语法，弥补上述的 REST 缺陷，何必要另外引入 GraphQL 徒增复杂度呢。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-016edec76cf34328ac821ba4bc4268e3\"\u003e说的没错，所以我们在阐述这些问题的时候，也会附上我们当前基于 REST 的解决方案。\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-9151f0fa7aa04512bd8567f9b597b835\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-86523c26bb6f4ca881988768cfd86c64\"\u003e\u003cb\u003eOverfetching：\u003c/b\u003e\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-261e9041ab2347b7aa5f4f2ac4bf7283\"\u003e假如我们定义了一个 \u003ccode class=\"notion-inline-code\"\u003e/comments\u003c/code\u003e 的 API，输出评论列表。以 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://www.django-rest-framework.org/\"\u003edjango-rest-framework\u003c/a\u003e 为例，我们都会定义一个 \u003ccode class=\"notion-inline-code\"\u003eSerializer\u003c/code\u003e 来声明它的输入和输出。\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003efrom rest_framework \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e serializers\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eCommentSerializer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eserializers\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eSerializer\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    email \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e serializers\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eEmailField\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    content \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e serializers\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eCharField\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emax_length\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e200\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    logo \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e serializer\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eImageField\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e省略数不清的字段\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    created \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e serializers\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eDateTimeField\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    ip_from \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e serializers\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eIPAddressField\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-9243ba0ad276413398efd52a86e73c76\"\u003e看起来符合常理，它可以轻松满足大多数评论列表的需求。但是也许某一天，我们需要一个评论的精简列表的 API，当前返回内容中，除了 \u003ccode class=\"notion-inline-code\"\u003econtent\u003c/code\u003e 以外的其他字段都变成多余了，那么后端开发需要重新定一个 \u003ccode class=\"notion-inline-code\"\u003eMinimalCommentSerializer\u003c/code\u003e 来满足新的需求。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-c1041cb777b346d89717b6b8227d5719\"\u003e在 REST 基础中，我们增加了 \u003ccode class=\"notion-inline-code\"\u003efields\u003c/code\u003e 参数，并在 \u003ccode class=\"notion-inline-code\"\u003eDRF Serializer\u003c/code\u003e 里做了\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/TencentBlueKing/bk-user/blob/8c633e0a3821beb839ed120c4514c5733e675862/src/api/bkuser_core/common/viewset.py#L71\"\u003e特殊处理（你可以点击查看源码）\u003c/a\u003e，实现的具体效果：\u003c/div\u003e\u003cpre class=\"notion-code language-json\"\u003e\u003ccode class=\"language-json\"\u003e# 查询 comment，并限制结果返回字段\n\u003cspan class=\"token operator\"\u003e/\u003c/span\u003eapi\u003cspan class=\"token operator\"\u003e/\u003c/span\u003ecomments\u003cspan class=\"token operator\"\u003e?\u003c/span\u003efields\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eemail\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003econtent\n\n# 返回\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token string-property property\"\u003e\"results\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token string-property property\"\u003e\"email\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"foo@bar.com\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token string-property property\"\u003e\"content\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"I love this blog, simple and good looking.\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-f597e7e436cb44f4940b946ac14191db\"\u003e而如果我们使用 GraphQL，写法上会更自然：\u003c/div\u003e\u003cpre class=\"notion-code language-graphql\"\u003e\u003ccode class=\"language-graphql\"\u003equery \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  comment \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    email\n    content\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-73155088d28a4e6f8b82bf2551ad1a67\"\u003e\u003cb\u003eUnderfetching\u003c/b\u003e\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-5b93503e6e0c47fa8165bb452f67c8f3\"\u003e相较于 Overfetching 是获取了过多数据，Underfetching 则是在请求获取的数据不足够满足需求。\u003c/div\u003e\u003cfigure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-76d7c8f902c246cba62dfd7a00b5c990\"\u003e\u003cdiv style=\"position:relative;display:flex;justify-content:center;align-self:center;width:720px;max-width:100%;flex-direction:column\"\u003e\u003cimg style=\"object-fit:contain\" src=\"https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F7396e0b5-7539-4174-992e-c35a8076984e%2FUntitled.png?table=block\u0026amp;id=76d7c8f9-02c2-46cb-a62d-fd7a00b5c990\u0026amp;cache=v2\" loading=\"lazy\" alt=\"传统的 REST 协议\" decoding=\"async\"/\u003e\u003cfigcaption class=\"notion-asset-caption\"\u003e传统的 REST 协议\u003c/figcaption\u003e\u003c/div\u003e\u003c/figure\u003e\u003cdiv class=\"notion-text notion-block-f20ce9deab744d049c5c529571cf5b0a\"\u003e假如我们需要获取所有用户维度的评论，我们需要先获取通过 \u003ccode class=\"notion-inline-code\"\u003e/users\u003c/code\u003e 所有用户 id，再使用 id 列表遍历查询 \u003ccode class=\"notion-inline-code\"\u003e/users/\u0026lt;id\u0026gt;/comments\u003c/code\u003e 来获取相关的列表。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-664a1feb5c8f4030a77f313f8f2c05f0\"\u003e在 REST 中，为了这个需求我们可能会额外为 \u003ccode class=\"notion-inline-code\"\u003e/users\u003c/code\u003e 增加一个参数 \u003ccode class=\"notion-inline-code\"\u003ewith_comments\u003c/code\u003e \u003c/div\u003e\u003cpre class=\"notion-code language-json\"\u003e\u003ccode class=\"language-json\"\u003e# 查询 users，并限制结果返回字段\n\u003cspan class=\"token operator\"\u003e/\u003c/span\u003eapi\u003cspan class=\"token operator\"\u003e/\u003c/span\u003eusers\u003cspan class=\"token operator\"\u003e?\u003c/span\u003ewith_comments\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n\n# 返回\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token string-property property\"\u003e\"results\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token string-property property\"\u003e\"username\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"foo\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token string-property property\"\u003e\"telephone\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"12345\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token string-property property\"\u003e\"comments\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"token string-property property\"\u003e\"email\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"foo@bar.com\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"token string-property property\"\u003e\"content\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"I love this blog, simple and good looking.\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-blank notion-block-d002648bd6984cb1ac8c6a0951653437\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-511e89a1906b47068da530351636a8ab\"\u003e相较于自定义的 REST 协议，使用 GraphQL 可以更简单：\u003c/div\u003e\u003cfigure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-801be6ddb7bf4afd988363ef9ea359ea\"\u003e\u003cdiv style=\"position:relative;display:flex;justify-content:center;align-self:center;width:624px;max-width:100%;flex-direction:column\"\u003e\u003cimg style=\"object-fit:contain\" src=\"https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc730795a-8b87-497e-a6c8-38c4c29f310a%2FUntitled.png?table=block\u0026amp;id=801be6dd-b7bf-4afd-9883-63ef9ea359ea\u0026amp;cache=v2\" loading=\"lazy\" alt=\"使用 GraphQL，只需要一次请求\" decoding=\"async\"/\u003e\u003cfigcaption class=\"notion-asset-caption\"\u003e使用 GraphQL，只需要一次请求\u003c/figcaption\u003e\u003c/div\u003e\u003c/figure\u003e\u003chr class=\"notion-hr notion-block-a7cc3850d7d34e9394559e3c484535a8\"/\u003e\u003cdiv class=\"notion-blank notion-block-ae2e1ab9de4445e9af25da3b4283ed30\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-e5388855af4c4978ab5d79d928a68fac\"\u003e相信通过上面的例子，我们可以清晰地看出，相较于 GraphQL ，基于 REST 扩展协议存在这些问题：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-0c2d157b66104281b7465d60c317263c\"\u003e\u003cli\u003e不够通用，用户有额外的学习成本，增加了额外的文档负担。\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-bf511966e9b04e6f9565a4435370aaf7\"\u003e\u003cli\u003e基于 REST ，单个请求只能针对单个对象进行描述。需要等待需求沉淀，由后端主动封装，迭代节奏会更慢。\u003c/li\u003e\u003c/ul\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-3db8daa2fcb0409baa596fd5472b9ff3\" data-id=\"3db8daa2fcb0409baa596fd5472b9ff3\"\u003e\u003cspan\u003e\u003cdiv id=\"3db8daa2fcb0409baa596fd5472b9ff3\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#3db8daa2fcb0409baa596fd5472b9ff3\" title=\"什么是 GraphQL 客户端?\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e什么是 GraphQL 客户端?\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-b271423a2db348a9a08562e982457465\"\u003e我们主要聚焦于 GraphQL 服务端提供，但是也需要先看一下所谓的客户端究竟做了什么。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-e4ae6016eb264be39a05804c3bd07f25\"\u003e简单来说，要想在原生 Javascript 中直接使用 GraphQL 并不是一件特别容易的事，需要一些库来协助拉取和管理 GraphQL 数据。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-3114c568468f4b9cb5b95fe9120d51dd\"\u003e相较于原生的 GraphQL ，客户端主要解决了几件事情：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-2729ac7032e44245a0b78c928929cfda\"\u003e\u003cli\u003e客户端数据拉取缓存问题（包括缓存一致性、更新缓存等）\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-f3841eb2487b404d8002ecfebcd4e44b\"\u003e\u003cli\u003e数据分页、声明式数据获取\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-dd027b39a3d647529443d0b0220299df\"\u003e\u003cli\u003e...\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-text notion-block-5b0213aea8b443078ff3c6d9eb1455b5\"\u003e主流的客户端框架主要有两种—— \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://relay.dev/\"\u003eRelay\u003c/a\u003e 和 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://www.apollographql.com/\"\u003eApollo\u003c/a\u003e ，我们仅从有限的角度来看下二者的异同：\u003c/div\u003e\u003cdiv class=\"notion-collection notion-block-79eac296c4544b138687c18a99776607\"\u003e\u003cdiv class=\"notion-collection-header\" style=\"padding-left:96px;padding-right:96px\"\u003e\u003cdiv class=\"notion-collection-header-title\"\u003eRelay vs Apollo\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-table\" style=\"width:1024px;max-width:1024px\"\u003e\u003cdiv class=\"notion-table-view\" style=\"padding-left:96px;padding-right:96px\"\u003e\u003cdiv class=\"notion-table-header\"\u003e\u003cdiv class=\"notion-table-header-inner\"\u003e\u003cdiv class=\"notion-table-th\"\u003e\u003cdiv class=\"notion-table-view-header-cell\" style=\"width:232.66949462890625px\"\u003e\u003cdiv class=\"notion-table-view-header-cell-inner\"\u003e\u003cdiv class=\"notion-collection-column-title\"\u003e\u003csvg viewBox=\"0 0 14 14\" class=\"notion-collection-column-title-icon\"\u003e\u003cpath d=\"M7.74 8.697a.81.81 0 01.073.308.894.894 0 01-.9.888.867.867 0 01-.825-.592l-.333-.961H2.058l-.333.961a.882.882 0 01-.838.592A.884.884 0 010 9.005c0-.11.025-.222.062-.308l2.403-6.211c.222-.58.776-.986 1.442-.986.653 0 1.22.407 1.442.986l2.39 6.211zM2.6 6.824h2.613L3.907 3.102 2.6 6.824zm8.8-3.118c1.355 0 2.6.542 2.6 2.255V9.08a.8.8 0 01-.789.814.797.797 0 01-.788-.703c-.395.468-1.097.764-1.874.764-.949 0-2.07-.64-2.07-1.972 0-1.392 1.121-1.897 2.07-1.897.789 0 1.491.246 1.886.727v-.826c0-.604-.518-.998-1.306-.998-.469 0-.888.123-1.32.394a.64.64 0 01-.307.086.602.602 0 01-.592-.604c0-.221.123-.419.284-.517a3.963 3.963 0 012.206-.641zm-.222 5.188c.505 0 .998-.172 1.257-.517v-.74c-.259-.345-.752-.517-1.257-.517-.616 0-1.122.332-1.122.9 0 .554.506.874 1.122.874zM.656 11.125h12.688a.656.656 0 110 1.313H.656a.656.656 0 110-1.313z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003cdiv class=\"notion-collection-column-title-body\"\u003e\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-th\"\u003e\u003cdiv class=\"notion-table-view-header-cell\" style=\"width:232.66949462890625px\"\u003e\u003cdiv class=\"notion-table-view-header-cell-inner\"\u003e\u003cdiv class=\"notion-collection-column-title\"\u003e\u003csvg viewBox=\"0 0 14 14\" class=\"notion-collection-column-title-icon\"\u003e\u003cpath d=\"M7 4.568a.5.5 0 00-.5-.5h-6a.5.5 0 00-.5.5v1.046a.5.5 0 00.5.5h6a.5.5 0 00.5-.5V4.568zM.5 1a.5.5 0 00-.5.5v1.045a.5.5 0 00.5.5h12a.5.5 0 00.5-.5V1.5a.5.5 0 00-.5-.5H.5zM0 8.682a.5.5 0 00.5.5h11a.5.5 0 00.5-.5V7.636a.5.5 0 00-.5-.5H.5a.5.5 0 00-.5.5v1.046zm0 3.068a.5.5 0 00.5.5h9a.5.5 0 00.5-.5v-1.045a.5.5 0 00-.5-.5h-9a.5.5 0 00-.5.5v1.045z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003cdiv class=\"notion-collection-column-title-body\"\u003eRelay\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-th\"\u003e\u003cdiv class=\"notion-table-view-header-cell\" style=\"width:369.66949462890625px\"\u003e\u003cdiv class=\"notion-table-view-header-cell-inner\"\u003e\u003cdiv class=\"notion-collection-column-title\"\u003e\u003csvg viewBox=\"0 0 14 14\" class=\"notion-collection-column-title-icon\"\u003e\u003cpath d=\"M7 4.568a.5.5 0 00-.5-.5h-6a.5.5 0 00-.5.5v1.046a.5.5 0 00.5.5h6a.5.5 0 00.5-.5V4.568zM.5 1a.5.5 0 00-.5.5v1.045a.5.5 0 00.5.5h12a.5.5 0 00.5-.5V1.5a.5.5 0 00-.5-.5H.5zM0 8.682a.5.5 0 00.5.5h11a.5.5 0 00.5-.5V7.636a.5.5 0 00-.5-.5H.5a.5.5 0 00-.5.5v1.046zm0 3.068a.5.5 0 00.5.5h9a.5.5 0 00.5-.5v-1.045a.5.5 0 00-.5-.5h-9a.5.5 0 00-.5.5v1.045z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003cdiv class=\"notion-collection-column-title-body\"\u003eApollo\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-header-placeholder\"\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-body\"\u003e\u003cdiv class=\"notion-table-row\"\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-title\" style=\"width:232.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-title\"\u003e\u003ca class=\"notion-page-link\" href=\"https://www.notion.so/bc1b723e68814b8db570eaa51d4dd328\"\u003e\u003cspan class=\"notion-page-title\"\u003e\u003csvg class=\"notion-page-title-icon notion-page-icon\" alt=\"框架支持\" viewBox=\"0 0 30 30\" width=\"16\"\u003e\u003cpath d=\"M16,1H4v28h22V11L16,1z M16,3.828L23.172,11H16V3.828z M24,27H6V3h8v10h10V27z M8,17h14v-2H8V17z M8,21h14v-2H8V21z M8,25h14v-2H8V25z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003cspan class=\"notion-page-title-text\"\u003e框架支持\u003c/span\u003e\u003c/span\u003e\u003c/a\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-text\" style=\"width:232.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-text\"\u003e仅支持 React, React Native\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-text\" style=\"width:369.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-text\"\u003e无框架限定\u003c/span\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-row\"\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-title\" style=\"width:232.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-title\"\u003e\u003ca class=\"notion-page-link\" href=\"https://www.notion.so/574b8c14d70949388afad8250db9a9ee\"\u003e\u003cspan class=\"notion-page-title\"\u003e\u003csvg class=\"notion-page-title-icon notion-page-icon\" alt=\"GraphQL API\" viewBox=\"0 0 30 30\" width=\"16\"\u003e\u003cpath d=\"M16,1H4v28h22V11L16,1z M16,3.828L23.172,11H16V3.828z M24,27H6V3h8v10h10V27z M8,17h14v-2H8V17z M8,21h14v-2H8V21z M8,25h14v-2H8V25z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003cspan class=\"notion-page-title-text\"\u003eGraphQL API\u003c/span\u003e\u003c/span\u003e\u003c/a\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-text\" style=\"width:232.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-text\"\u003e需要特定的 Schema 支持\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-text\" style=\"width:369.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-text\"\u003e无需特定的 Schema 支持\u003c/span\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-row\"\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-title\" style=\"width:232.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-title\"\u003e\u003ca class=\"notion-page-link\" href=\"https://www.notion.so/c0029db1fe0c44948186e6eb55c57632\"\u003e\u003cspan class=\"notion-page-title\"\u003e\u003csvg class=\"notion-page-title-icon notion-page-icon\" alt=\"学习成本\" viewBox=\"0 0 30 30\" width=\"16\"\u003e\u003cpath d=\"M16,1H4v28h22V11L16,1z M16,3.828L23.172,11H16V3.828z M24,27H6V3h8v10h10V27z M8,17h14v-2H8V17z M8,21h14v-2H8V21z M8,25h14v-2H8V25z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003cspan class=\"notion-page-title-text\"\u003e学习成本\u003c/span\u003e\u003c/span\u003e\u003c/a\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-text\" style=\"width:232.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-text\"\u003e较高\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-text\" style=\"width:369.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-text\"\u003e较低\u003c/span\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-row\"\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-title\" style=\"width:232.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-title\"\u003e\u003ca class=\"notion-page-link\" href=\"https://www.notion.so/5cf89e43953a4289aef7334c7760d81a\"\u003e\u003cspan class=\"notion-page-title\"\u003e\u003csvg class=\"notion-page-title-icon notion-page-icon\" alt=\"生产力\" viewBox=\"0 0 30 30\" width=\"16\"\u003e\u003cpath d=\"M16,1H4v28h22V11L16,1z M16,3.828L23.172,11H16V3.828z M24,27H6V3h8v10h10V27z M8,17h14v-2H8V17z M8,21h14v-2H8V21z M8,25h14v-2H8V25z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003cspan class=\"notion-page-title-text\"\u003e生产力\u003c/span\u003e\u003c/span\u003e\u003c/a\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-text\" style=\"width:232.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-text\"\u003e高\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-text\" style=\"width:369.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-text\"\u003e较低\u003c/span\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-row\"\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-title\" style=\"width:232.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-title\"\u003e\u003ca class=\"notion-page-link\" href=\"https://www.notion.so/d710e6b7a1a2458493f3a4a06adc7f6e\"\u003e\u003cspan class=\"notion-page-title\"\u003e\u003csvg class=\"notion-page-title-icon notion-page-icon\" alt=\"灵活性\" viewBox=\"0 0 30 30\" width=\"16\"\u003e\u003cpath d=\"M16,1H4v28h22V11L16,1z M16,3.828L23.172,11H16V3.828z M24,27H6V3h8v10h10V27z M8,17h14v-2H8V17z M8,21h14v-2H8V21z M8,25h14v-2H8V25z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003cspan class=\"notion-page-title-text\"\u003e灵活性\u003c/span\u003e\u003c/span\u003e\u003c/a\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-text\" style=\"width:232.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-text\"\u003e固定结构\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-text\" style=\"width:369.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-text\"\u003e较灵活\u003c/span\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-row\"\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-title\" style=\"width:232.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-title\"\u003e\u003ca class=\"notion-page-link\" href=\"https://www.notion.so/4e0a6851a331441cbb68fd9b6fa17ffb\"\u003e\u003cspan class=\"notion-page-title\"\u003e\u003csvg class=\"notion-page-title-icon notion-page-icon\" alt=\"是否支持订阅\" viewBox=\"0 0 30 30\" width=\"16\"\u003e\u003cpath d=\"M16,1H4v28h22V11L16,1z M16,3.828L23.172,11H16V3.828z M24,27H6V3h8v10h10V27z M8,17h14v-2H8V17z M8,21h14v-2H8V21z M8,25h14v-2H8V25z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003cspan class=\"notion-page-title-text\"\u003e是否支持订阅\u003c/span\u003e\u003c/span\u003e\u003c/a\u003e\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-text\" style=\"width:232.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-text\"\u003e否\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\"notion-table-cell notion-table-cell-text\" style=\"width:369.66949462890625px\"\u003e\u003cspan class=\"notion-property notion-property-text\"\u003e是\u003c/span\u003e\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-25bbafb30a124becb56e2e541cd779e4\"\u003e简而言之，Realy 更复杂，更能够应对大型应用，Apollo 更轻量，不过需要更多的手工劳动。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-499a5d133c9b493e946a692b0e21a062\" data-id=\"499a5d133c9b493e946a692b0e21a062\"\u003e\u003cspan\u003e\u003cdiv id=\"499a5d133c9b493e946a692b0e21a062\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#499a5d133c9b493e946a692b0e21a062\" title=\"服务端落地：GraphQL → Django\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e服务端落地：GraphQL → Django\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-d82aba35a7ee4c7e896c4366b1d5ec5e\"\u003e想要将 GraphQL 引入现有的项目，我们需要安装两个基础的依赖：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-850425fb270440e89da6348449515cbf\"\u003e\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/graphql-python/graphene-django\"\u003egraphene-django\u003c/a\u003e \u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-06516dcbe6bf497184297351f2d2b55c\"\u003e\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/carltongibson/django-filter\"\u003edjango-filter\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-text notion-block-7f566dd96e93421b9e7552ca098c92db\"\u003e二者分别负责两部分的工作：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-269531b02e9c47c88da2441c19e7ccc0\"\u003e\u003cli\u003eDjango Model ⇒  Schema\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-17baeebedf8c4e94a698faf2a0dfebd4\"\u003e\u003cli\u003eQuery  ⇒  Filter Django Model \u003c/li\u003e\u003c/ul\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-8c904f70489a4268a7b5c8f4ca2d51e6\" data-id=\"8c904f70489a4268a7b5c8f4ca2d51e6\"\u003e\u003cspan\u003e\u003cdiv id=\"8c904f70489a4268a7b5c8f4ca2d51e6\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#8c904f70489a4268a7b5c8f4ca2d51e6\" title=\"支持 Relay\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e支持 Relay\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cdiv class=\"notion-text notion-block-e80c823d66984b70aef628752f33c177\"\u003egraphene-django 本身 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://docs.graphene-python.org/projects/django/en/latest/tutorial-relay/\"\u003e默认支持 Relay\u003c/a\u003e，所以你可以很容易地开启\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003efrom graphene \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e relay\nfrom graphene_django \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e DjangoObjectType\nfrom ingredients\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emodels \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e Category\n\n# Graphene will automatically map the Category model's fields onto the CategoryNode\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n# This is configured \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e the CategoryNode's Meta \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e you can see below\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eCategoryNode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eDjangoObjectType\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eMeta\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        model \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e Category\n        filter_fields \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e'name'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e'ingredients'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n        interfaces \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erelay\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eNode\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-eecb673cd4084d57ad0a511380cd6b28\"\u003e不过很多时候考虑到 Relay 的复杂度，有时都不适合引入，更何况 Relay 需要特殊的 Schema 支持：\u003c/div\u003e\u003cdiv class=\"notion-row notion-block-419c60d4a1a84f0ba4d39bb116e55b71\"\u003e\u003cdiv class=\"notion-column notion-block-63a72f800f3946378539183410ea26ba\" style=\"width:calc((100% - (1 * min(32px, 4vw))) * 0.5)\"\u003e\u003cpre class=\"notion-code language-graphql\"\u003e\u003ccode class=\"language-graphql\"\u003equery \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  allIngredients \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    edges \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      node \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        id\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        name\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cfigcaption class=\"notion-asset-caption\"\u003eRelay Schema：edges、node 层级同样会出现在返回值\u003c/figcaption\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003cdiv class=\"notion-column notion-block-5c0491f03bc64f83aea39c6375e5f19d\" style=\"width:calc((100% - (1 * min(32px, 4vw))) * 0.5)\"\u003e\u003cpre class=\"notion-code language-graphql\"\u003e\u003ccode class=\"language-graphql\"\u003equery \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  allIngredients \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    id\n    name\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\n\n\u003c/code\u003e\u003c/pre\u003e\u003cfigcaption class=\"notion-asset-caption\"\u003e原生 Schema： 明显更自然、简洁\u003c/figcaption\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-25b4916ef4774955a012fbc141f700eb\"\u003e这时候 graphene-django 就存在一个问题，当不使用 Relay 时，存在一些功能缺失：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-ded5b120c51d4b1b8132a268a7d6b3f9\"\u003e\u003cli\u003eFragment \\ Directives \u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-c75d9e445c274d5da510af554f9830a5\"\u003e\u003cli\u003e分页、过滤\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-33259eba02144fa9acda4e3e1eaf90ec\"\u003e\u003cli\u003e通过 DRF Serializer 定义 Mutations\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-text notion-block-21b3d48f64384238aad0c4a13b125c0f\"\u003e所以我们需要引入额外的库来解决。\u003c/div\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-3d929743493649a6a43da55924cdfa5e\" data-id=\"3d929743493649a6a43da55924cdfa5e\"\u003e\u003cspan\u003e\u003cdiv id=\"3d929743493649a6a43da55924cdfa5e\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#3d929743493649a6a43da55924cdfa5e\" title=\"引入 graphene-django-extras\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e引入 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/eamigo86/graphene-django-extras\"\u003egraphene-django-extras\u003c/a\u003e\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003efrom graphene \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e ObjectType\nfrom graphene_django_extras \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e DjangoListObjectField\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e DjangoListObjectType\nfrom graphene_django_extras\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epaginations \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e LimitOffsetGraphqlPagination\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eCommentListType\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eDjangoListObjectType\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eMeta\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        model \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e Comment\n        fields \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"__all__\"\u003c/span\u003e\n        pagination \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eLimitOffsetGraphqlPagination\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edefault_limit\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e25\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e ordering\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"-id\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eQuery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eObjectType\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    comments \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eDjangoListObjectField\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eCommentListType\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e description\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Query all comments\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-7b3762d8e2ad445e9c38eac7bedd68e5\"\u003e\u003cb\u003e支持复杂过滤查询\u003c/b\u003e\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-6ebe03413a0040f4b7b5295e3b67a824\"\u003e可以在列表对象中增加 \u003ccode class=\"notion-inline-code\"\u003efilter_fields\u003c/code\u003e ，针对不同的字段支持不同的 Django 复杂查询方法。\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eCommentListType\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eDjangoListObjectType\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eMeta\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        model \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e Comment\n        filter_fields \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token string-property property\"\u003e\"id\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"exact\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"in\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token string-property property\"\u003e\"content\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"exact\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"icontains\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"istartswith\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        pagination \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eLimitOffsetGraphqlPagination\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edefault_limit\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e25\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e ordering\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"-username\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-c71e31a767824aff9b82ee53004c179c\"\u003e这样就可以将一些 Django 的查询能力释放到前端\u003c/div\u003e\u003cpre class=\"notion-code language-graphql\"\u003e\u003ccode class=\"language-graphql\"\u003equery \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token function\"\u003ecomments\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eid__In\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e content_Icontains\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Amazing\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    totalCount\n    \u003cspan class=\"token function\"\u003eresults\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e\u003cspan class=\"token literal-property property\"\u003elimit\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e10\u003c/span\u003e \u003cspan class=\"token literal-property property\"\u003eoffset\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      id\n      email\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-208020ce25114ee2a60d8b07df687d43\"\u003e\u003cb\u003e自定义查询字段\u003c/b\u003e\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-fa290cc6855049289a6df8b9537c6cf3\"\u003eDjango 默认的查询能力，对于一些特殊字段并不能完全覆盖需求，这时我们就需要针对这些内容手写一些处理逻辑。\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eQuery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eObjectType\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    user \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eField\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eUserType\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e description\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Retrieve certain user\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e id\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token function\"\u003eInt\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e username\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token function\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\t\tdef \u003cspan class=\"token function\"\u003eresolve_user\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n        self\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token literal-property property\"\u003econtext\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"GraphQLResolveInfo\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token literal-property property\"\u003eid\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e Optional\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eint\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e None\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token literal-property property\"\u003eusername\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e Optional\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003estr\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e None\n    \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e User\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e id is not None\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e User\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eobjects\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epk\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e username is None\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n            raise \u003cspan class=\"token function\"\u003eValueError\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"username or pk at least one is required\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n        # \u003cspan class=\"token keyword\"\u003edo\u003c/span\u003e some custom logic\n        \u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e User\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eobjects\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eusername\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eusername\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-cce7dff50ba44dffa5f85844bfdcf91b\"\u003e需要注意的是，当我们使用 \u003ccode class=\"notion-inline-code\"\u003eresolve_\u003c/code\u003e 函数去处理查询时，GraphQL 和 REST 本质上只是查询 DSL 有所区别，都会遇到类似像 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://stackoverflow.com/questions/97197/what-is-the-n1-selects-problem-in-orm-object-relational-mapping\"\u003eN+1\u003c/a\u003e 这样的慢查询问题，所以需要谨慎地将前端的查询转换成可靠的 Django ORM 查询。\u003c/div\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-0068853173e54e1bacc12aa21d51205d\" data-id=\"0068853173e54e1bacc12aa21d51205d\"\u003e\u003cspan\u003e\u003cdiv id=\"0068853173e54e1bacc12aa21d51205d\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#0068853173e54e1bacc12aa21d51205d\" title=\"鉴权\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e鉴权\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cdiv class=\"notion-text notion-block-41b09c496df54886b6b685e8f38fb9c5\"\u003e由于 API 请求并不再经过传统封装的 ViewSet，原有的鉴权组件不再能使用，你需要引入新的 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/redzej/graphene-permissions\"\u003egraphene-permissions\u003c/a\u003e 来解决针对用户的权限控制。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-486546d75ed744b48491c065b47b6915\"\u003e本文成文时，graphene-permissions 对于最新的 Graphene 3.x 有一些\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/redzej/graphene-permissions/pull/36\"\u003e小的兼容性问题\u003c/a\u003e，由于该库代码量非常小，可以考虑复制到自己的项目手动维护。\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003efrom \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emixins \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e AuthNode\nfrom \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epermissions \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e AllowSuperuser\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUserNode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eAuthNode\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e DjangoObjectType\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    permission_classes \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eAllowAuthenticated\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eMeta\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        model \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e User\n        filter_fields \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'username'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        interfaces \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erelay\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eNode\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-blank notion-block-3a7758ed778747038fbc0b83f8c7ec6e\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-212d68c0638c45c1a66570938e3eb1c7\"\u003e尴尬的是，如果你并不想用 Relay，我们需要针对 graphene-django-extras 做一些自己的定制，而原有的封装没有很好地暴露足够的接口，经过一番探索并无头绪，最终作罢🥴。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-10f53459be3844c7a1355a1ed5bd63b9\" data-id=\"10f53459be3844c7a1355a1ed5bd63b9\"\u003e\u003cspan\u003e\u003cdiv id=\"10f53459be3844c7a1355a1ed5bd63b9\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#10f53459be3844c7a1355a1ed5bd63b9\" title=\"总结\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e总结\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cul class=\"notion-list notion-list-disc notion-block-9d67626a1d9641cd90f5af2e20aa6bc9\"\u003e\u003cli\u003eGraphQL 在前端需求迭代频繁的场景下，比 REST 更符合现代开发节奏\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-9f6415435fd9484fbc2ce5c4d2770bfe\"\u003e\u003cli\u003eGraphQL 的语言设计比自定义扩展的 REST 更自然，更具备通用性\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-2448995dbf5046fb8d4cf720a8a4991a\"\u003e\u003cli\u003eGraphQL 会将比较多的工作放到客户端，适合成熟的客户端开发团队，反之 REST 是更好的选择\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-df526e5ca78840c8a0cf8355e37cf7bf\"\u003e\u003cli\u003eDjango 相关的生态建设并不完善，没有一个足够强大、开箱即用的整合方案\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-f819d57fbe4b469683400d4b084480c1\"\u003e\u003cli\u003e由于查询并不是基于 Uri 维度，会给周边配套的生态—— 监控、日志等 ——带来一些新的挑战\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-blank notion-block-ddaf5c2480f746f791a762c4707709f5\"\u003e \u003c/div\u003e\u003c/main\u003e]]\u003e\u003c/content\u003e\n    \u003c/entry\u003e\n    \u003centry\u003e\n        \u003ctitle type=\"html\"\u003e\u003c![CDATA[不要往 AMQP 的 Header 乱塞东西]]\u003e\u003c/title\u003e\n        \u003cid\u003ehttps://next.emergencyexit.xyz//amqp-header-has-frame-max-limit\u003c/id\u003e\n        \u003clink href=\"https://next.emergencyexit.xyz//amqp-header-has-frame-max-limit\"/\u003e\n        \u003cupdated\u003e2021-11-17T00:00:00.000Z\u003c/updated\u003e\n        \u003csummary type=\"html\"\u003e\u003c![CDATA[内容过度封装，标题过于直白]]\u003e\u003c/summary\u003e\n        \u003ccontent type=\"html\"\u003e\u003c![CDATA[\u003cmain class=\"notion light-mode notion-page notion-full-width notion-small-text notion-block-da9db88226ea4516815c75f2f9ddab59\"\u003e\u003cdiv class=\"notion-viewport\"\u003e\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-2fd1bb98202342939e35ee2f8efff7ae\" data-id=\"2fd1bb98202342939e35ee2f8efff7ae\"\u003e\u003cspan\u003e\u003cdiv id=\"2fd1bb98202342939e35ee2f8efff7ae\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#2fd1bb98202342939e35ee2f8efff7ae\" title=\"前情提要\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e前情提要\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-528ec1ed01944bb0817d5ce684823362\"\u003e一直以来，我们在 Python 项目中的后台任务都是使用 celery 搭配 Redis(作为 broker)来完成，同时针对短任务轮询场景我们也\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/TencentBlueKing/bkpaas-python-sdk/tree/master/sdks/blue-krill/blue_krill/async_utils\"\u003e做了一些封装\u003c/a\u003e。在项目运行的三~四年间，这套方案完美地承载了我们核心功能。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-20bb6ad0221948d08881077d55bbbc63\"\u003e然而，就在不久前的一周，出现一些比较诡异的问题，总是有些后台任务发生阻塞，我们使用的多种异常观测手段（\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://sentry.io/\"\u003eSentry\u003c/a\u003e、日志等）都无法准确定位到具体问题（这或许是另一个故事），于是死马当活马医，我们决定将 Redis 更换为 RabbitMQ，这样能够更为准确地观测到任务具体执行的消息情况（例如是否及时Ack）。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-b75e1c76f97445b8a2dd0c4314fd5fb7\" data-id=\"b75e1c76f97445b8a2dd0c4314fd5fb7\"\u003e\u003cspan\u003e\u003cdiv id=\"b75e1c76f97445b8a2dd0c4314fd5fb7\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#b75e1c76f97445b8a2dd0c4314fd5fb7\" title=\"案发现场\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e案发现场\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-075fe4f158b142519af19e46a7772d99\"\u003e更换完 broker 之后，却发现了另一个奇怪的问题（没错，这才是本文的主角）。我们在某一些特殊资源的场景下，celery 任务会直接报错：\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token literal-property property\"\u003eConnectionResetError\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eErrno \u003cspan class=\"token number\"\u003e104\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e Connection reset by peer\n  File \u003cspan class=\"token string\"\u003e\"kombu/connection.py\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e line \u003cspan class=\"token number\"\u003e414\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e _reraise_as_library_errors\n    \u003cspan class=\"token keyword\"\u003eyield\u003c/span\u003e\n  File \u003cspan class=\"token string\"\u003e\"kombu/connection.py\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e line \u003cspan class=\"token number\"\u003e494\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e _ensured\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003efun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003eargs\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e**\u003c/span\u003ekwargs\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  File \u003cspan class=\"token string\"\u003e\"kombu/messaging.py\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e line \u003cspan class=\"token number\"\u003e203\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e _publish\n    mandatory\u003cspan class=\"token operator\"\u003e=\u003c/span\u003emandatory\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e immediate\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eimmediate\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  File \u003cspan class=\"token string\"\u003e\"amqp/channel.py\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e line \u003cspan class=\"token number\"\u003e1766\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"token function\"\u003e_basic_publish\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e exchange\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e routing_key\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e mandatory\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e immediate\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e msg\n  File \u003cspan class=\"token string\"\u003e\"amqp/abstract_channel.py\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e line \u003cspan class=\"token number\"\u003e59\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e send_method\n    conn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eframe_writer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e self\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echannel_id\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e sig\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e args\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e content\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  File \u003cspan class=\"token string\"\u003e\"amqp/method_framing.py\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e line \u003cspan class=\"token number\"\u003e154\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e write_frame\n    \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e channel\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e framelen\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e frame\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0xce\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  File \u003cspan class=\"token string\"\u003e\"amqp/transport.py\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e line \u003cspan class=\"token number\"\u003e305\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e write\n    self\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003e_write\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003es\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-c68ba31ee3a2430db79b993e87e7dd29\"\u003e由于我们使用了一层 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://cloud.tencent.com/product/clb\"\u003eCLB\u003c/a\u003e 作为高可用代理，而之前的使用经验中，CLB 可能会有一些长时间无数据断连的情况，所以我们暂时认为可能是某些长时间的阻塞任务会导致 CLB 主动断开，为了排除干扰，我们甩开了 CLB，直接采用 MQ 的多个节点作为地址直连。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-c29cd374f8244d86bbf238b6f7ab9f20\"\u003e然而，问题依旧，一时间又没了头绪，我开始漫无目的重新浏览 Sentry 中的错误堆栈以及相关变量。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-2c0cbf6be3564463a1d3f5c7c359cf03\" data-id=\"2c0cbf6be3564463a1d3f5c7c359cf03\"\u003e\u003cspan\u003e\u003cdiv id=\"2c0cbf6be3564463a1d3f5c7c359cf03\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#2c0cbf6be3564463a1d3f5c7c359cf03\" title=\"蛛丝马迹\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e蛛丝马迹\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-edebeefb4a5a4e5fbd8cc7b18d985e42\"\u003e无意间，发现在代码中，我们尝试向队列中存储一大段 pickle 过的对象数据，而这些变量在 Sentry 中已经长到无法完整显示而被省略了。\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\nany_task\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eapply_async\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eheaders\u003cspan class=\"token operator\"\u003e=\u003c/span\u003esomething_big\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-fe84bd6e13c6414b8ac71a4179eb4bb2\"\u003e这个问题立马引起了我们的注意🤔，很有可能是这个数据过大而引起写入异常。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-7a1416bab27641539543f1403efffbe1\" data-id=\"7a1416bab27641539543f1403efffbe1\"\u003e\u003cspan\u003e\u003cdiv id=\"7a1416bab27641539543f1403efffbe1\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#7a1416bab27641539543f1403efffbe1\" title=\"破案\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e破案\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-603942a46c0e440c90c00e051afc6b61\"\u003e照此思路，经过一番网络冲浪，发现了类似的问题：\u003c/div\u003e\u003cdiv class=\"notion-row\"\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-bookmark notion-block-836f467d848d4649920834343af991d9\" href=\"https://stackoverflow.com/questions/30716002/is-there-a-size-limit-on-a-rabbitmq-message-header\"\u003e\u003cdiv\u003e\u003cdiv class=\"notion-bookmark-title\"\u003estackoverflow.com\u003c/div\u003e\u003cdiv class=\"notion-bookmark-link\"\u003e\u003cdiv\u003ehttps://stackoverflow.com/questions/30716002/is-there-a-size-limit-on-a-rabbitmq-message-header\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/a\u003e\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-f4e372a376ca4c9aa097e6d90f2e0571\"\u003e这时候，再去反查 RabbitMQ 的日志，果然有对应内容：\u003c/div\u003e\u003cpre class=\"notion-code language-plain text\"\u003e\u003ccode class=\"language-plain text\"\u003e\u003cspan class=\"token number\"\u003e2021\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token number\"\u003e11\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token number\"\u003e16\u003c/span\u003e \u003cspan class=\"token number\"\u003e19\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e49\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e32.098\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eerror\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"token number\"\u003e0.3894\u003c/span\u003e\u003cspan class=\"token number\"\u003e.1636\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e Error on \u003cspan class=\"token constant\"\u003eAMQP\u003c/span\u003e connection \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"token number\"\u003e0.3894\u003c/span\u003e\u003cspan class=\"token number\"\u003e.1636\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ex\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ex\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ex\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ex\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e59823\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e x\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ex\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ex\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ex\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e5672\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token literal-property property\"\u003evhost\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'foo'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token literal-property property\"\u003euser\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'foo'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token literal-property property\"\u003estate\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e running\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e channel \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n operation none caused a connection exception frame_error\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"type 2, all octets = \u0026lt;\u0026lt;\u003e\u003e: {frame_too_large,245629,131064}\"\u003c/span\u003e\n\n\u003cspan class=\"token number\"\u003e2021\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token number\"\u003e11\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token number\"\u003e16\u003c/span\u003e \u003cspan class=\"token number\"\u003e19\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e49\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e35.099\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eerror\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"token number\"\u003e0.3894\u003c/span\u003e\u003cspan class=\"token number\"\u003e.1636\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e closing \u003cspan class=\"token constant\"\u003eAMQP\u003c/span\u003e connection \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"token number\"\u003e0.3894\u003c/span\u003e\u003cspan class=\"token number\"\u003e.1636\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ex\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ex\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ex\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ex\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e59823\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e x\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ex\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ex\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ex\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e5672\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\nfatal_frame_error\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-6bf413a4480d4f3a8d9c025ef425f80f\"\u003e这里非常明确地指出了，由于我们传递的 frame 大小(\u003cspan class=\"notion-pink\"\u003e245629 bytes\u003c/span\u003e) 大于默认的 \u003cspan class=\"notion-teal\"\u003e131064 + 8(frame header) bytes (128KB)\u003c/span\u003e，所以 RabbitMQ 关闭了连接。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-e2a33f338c1445b79c42d0afc87e057d\"\u003e于是我们立即着手，精简了向 \u003ccode class=\"notion-inline-code\"\u003eheaders\u003c/code\u003e 传送的数据，重新发布后，终于一切归于正常。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-dc2f5dc2fec34667b5c0ed688a5ad257\" data-id=\"dc2f5dc2fec34667b5c0ed688a5ad257\"\u003e\u003cspan\u003e\u003cdiv id=\"dc2f5dc2fec34667b5c0ed688a5ad257\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#dc2f5dc2fec34667b5c0ed688a5ad257\" title=\"梳理\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e梳理\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-e3c48e89946647c1831ebefdda992ae3\"\u003e虽然问题已经得到了解决，但是仍旧需要补齐一下相关知识的短板。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-61e5471f5bcb4261be4d867e4f2e9aa7\"\u003e首先，让我们再来简单看看\u003cb\u003e AMQP \u003c/b\u003e \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://www.rabbitmq.com/resources/specs/amqp0-9-1.pdf\"\u003e0.9.1 版本\u003c/a\u003e \u003cb\u003e协议有关这部分的内容\u003c/b\u003e。\u003c/div\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-9723aa5f81bb41e391e1f1151f551a9f\" data-id=\"9723aa5f81bb41e391e1f1151f551a9f\"\u003e\u003cspan\u003e\u003cdiv id=\"9723aa5f81bb41e391e1f1151f551a9f\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#9723aa5f81bb41e391e1f1151f551a9f\" title=\"AMQP 协议\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eAMQP 协议\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cdiv class=\"notion-text notion-block-01c08f9939e245b592f65d2bcb7ad82c\"\u003e这是协议中所有 TCP/IP 帧组成\u003c/div\u003e\u003cpre class=\"notion-code language-plain text\"\u003e\u003ccode class=\"language-plain text\"\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e      \u003cspan class=\"token number\"\u003e1\u003c/span\u003e         \u003cspan class=\"token number\"\u003e3\u003c/span\u003e         \u003cspan class=\"token number\"\u003e7\u003c/span\u003e                 size\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token number\"\u003e7\u003c/span\u003e size\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token number\"\u003e8\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e|\u003c/span\u003e type \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e channel \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e   size  \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e   payload   \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e frame\u003cspan class=\"token operator\"\u003e-\u003c/span\u003eend \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n octet    short      long      \u003cspan class=\"token string\"\u003e'size'\u003c/span\u003e octets     octet\u003c/code\u003e\u003c/pre\u003e\u003cfigcaption class=\"notion-asset-caption\"\u003eGeneral Frame Format\u003c/figcaption\u003e\u003cdiv class=\"notion-text notion-block-5827cff6f99e46808af91cff5775984a\"\u003e其中有这么几个关键信息：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-9af4994f707f4d3198e771aeccdac8fd\"\u003e\u003cli\u003e0-7 bytes 确定了帧的类型和具体的 channel，确定了类型后将会处理 payload\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-acb5e1e906eb49b489d81b429513a796\"\u003e\u003cli\u003epayload 的大小在协议中并没有规定，而是说的是可以通过客户端和服务端的”协商“确定(page 22)\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-390c2b197597418ebdcf846a85bda9fb\"\u003e\u003cli\u003e不同类型帧有着不同的 payload 构成\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-text notion-block-a081e54c2a7c4d89bc208e8629086ecc\"\u003e当前问题主要是传递应用数据的场景下，所以我们来看具体承载的 Content 帧\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-07bf41aad49f47fc80c8a12325e83a9f\"\u003e简单点来说，Content 帧就是一系列的 properties 加上二进制的数据部分。这些 properties 将会组成 \u0026quot;content header frame\u0026quot;，它大概是这样的组成：\u003c/div\u003e\u003cpre class=\"notion-code language-plain text\"\u003e\u003ccode class=\"language-plain text\"\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e          \u003cspan class=\"token number\"\u003e2\u003c/span\u003e        \u003cspan class=\"token number\"\u003e4\u003c/span\u003e           \u003cspan class=\"token number\"\u003e12\u003c/span\u003e               \u003cspan class=\"token number\"\u003e14\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003eid \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e weight \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e body size \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e property flags \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e property list\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\n    short    short    long long        short        remainder\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-0dca7c859bee420589ced554d4f85e43\"\u003e也就是在我们的 celery 代码中， \u003ccode class=\"notion-inline-code\"\u003eheaders=(...)\u003c/code\u003e 传递的内容将会被塞入 property list 中，在协议中并没有明确具体的大小限制，同时没有表明会做的分块(content body 部分是会的)，所以当前产生的问题限制，主要受制于 RabbitMQ 的具体实现。\u003c/div\u003e\u003ca style=\"width:100%\" href=\"https://blog.rabbitmq.com/posts/2012/11/breaking-things-with-rabbitmq-3-0/\" target=\"blank_\"\u003e\u003cfigure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-18bd8584c6e04a5b874d660b84a9aa41\"\u003e\u003cdiv style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"\u003e\u003cimg style=\"object-fit:contain\" src=\"https://www.notion.so/image/https%3A%2F%2Fs3.us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F13faba46-c644-41e9-80b1-cdb3fb4659ad%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45EIPT3X45%252F20221018%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20221018T100704Z%26X-Amz-Expires%3D86400%26X-Amz-Signature%3D4410aeee25110119b86407f6b2a98d3ee57eb61d7d1b267f8977c863cc8d624f%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject?table=block\u0026amp;id=18bd8584-c6e0-4a5b-874d-660b84a9aa41\u0026amp;cache=v2\" loading=\"lazy\" alt=\"https://blog.rabbitmq.com/posts/2012/11/breaking-things-with-rabbitmq-3-0/\" decoding=\"async\"/\u003e\u003c/div\u003e\u003c/figure\u003e\u003c/a\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-59829334ff524b7088f05a5edaa97b62\" data-id=\"59829334ff524b7088f05a5edaa97b62\"\u003e\u003cspan\u003e\u003cdiv id=\"59829334ff524b7088f05a5edaa97b62\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#59829334ff524b7088f05a5edaa97b62\" title=\"三点感悟\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e三点感悟\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cul class=\"notion-list notion-list-disc notion-block-0692431de3bf494bbcfaf7eb798dcdde\"\u003e\u003cli\u003e\u003cb\u003e错误监测非常重要\u003c/b\u003e。如果没有 Sentry，问题的定位可能会更加困难，多耗几天精力也未可知。\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-ebefa435969a4d8aac3bd6a6730d457b\"\u003e\u003cli\u003e\u003cb\u003e要善于利用不同组件的优势\u003c/b\u003e。之所以一开始使用 Redis 而不是 RabbitMQ，更多是从运营维护的角度出发，在公司内部 Redis 有更完善的基建基础，而 RabbitMQ 的运维更加复杂。但是遇到像这样幽灵般的问题时，RabbitMQ 反而更有优势，完善的流程更容易暴露问题。\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-b4f62d66ce704d938ac544e6dce65dcf\"\u003e\u003cli\u003e\u003cb\u003e要适当地了解重点依赖的技术细节\u003c/b\u003e。大多数场景下，简单地使用协议就足够了，而在一些边缘场景中，则更看重技术人员对细节的把控。这类属于重要不紧急的事情，应该定时拿出来有意识去做，虽无近用，却有远益。\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-blank notion-block-e3b1fcaa802046a1ab9e5f2c4f518a22\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-ef7b0aac6baf4b63a07c50093c208254\"\u003e参考：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-7dcaa094a6db4402a8894c00ccb96770\"\u003e\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://www.rabbitmq.com/resources/specs/amqp0-9-1.pdf\"\u003ehttps://www.rabbitmq.com/resources/specs/amqp0-9-1.pdf\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-1e5cb10672c046219ff3b369a125183b\"\u003e\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://john.eckersberg.com/debugging-rabbitmq-frame_too_large-error.html\"\u003ehttps://john.eckersberg.com/debugging-rabbitmq-frame_too_large-error.html\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-bfb28b545f674bcea5b3bdf1c9959814\"\u003e\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://stackoverflow.com/questions/30716002/is-there-a-size-limit-on-a-rabbitmq-message-header\"\u003ehttps://stackoverflow.com/questions/30716002/is-there-a-size-limit-on-a-rabbitmq-message-header\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-416d48d7c02546b097551ec6ca3e5552\"\u003e\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://www.rabbitmq.com/amqp-0-9-1-errata.html#section_11\"\u003ehttps://www.rabbitmq.com/amqp-0-9-1-errata.html#section_11\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-blank notion-block-4d750428c0ef4db09420bab4eabfcffe\"\u003e \u003c/div\u003e\u003c/main\u003e]]\u003e\u003c/content\u003e\n    \u003c/entry\u003e\n    \u003centry\u003e\n        \u003ctitle type=\"html\"\u003e\u003c![CDATA[一些 Helm 最(tòng)佳(kǔ)实践]]\u003e\u003c/title\u003e\n        \u003cid\u003ehttps://next.emergencyexit.xyz//helm-pratices\u003c/id\u003e\n        \u003clink href=\"https://next.emergencyexit.xyz//helm-pratices\"/\u003e\n        \u003cupdated\u003e2021-09-01T00:00:00.000Z\u003c/updated\u003e\n        \u003csummary type=\"html\"\u003e\u003c![CDATA[标题的 emoji 就是我对 Helm 的评价]]\u003e\u003c/summary\u003e\n        \u003ccontent type=\"html\"\u003e\u003c![CDATA[\u003cmain class=\"notion light-mode notion-page notion-block-692194e608d34e36a94fdc403d6226e6\"\u003e\u003cdiv class=\"notion-viewport\"\u003e\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-b9fcb6ecf13e45ec9ccc108cfa563a9c\"\u003e \u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-2f89a200d0aa4f0da16f6b08342f5197\" data-id=\"2f89a200d0aa4f0da16f6b08342f5197\"\u003e\u003cspan\u003e\u003cdiv id=\"2f89a200d0aa4f0da16f6b08342f5197\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#2f89a200d0aa4f0da16f6b08342f5197\" title=\"yaml工程师的血泪 shi\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e\u003ccode class=\"notion-inline-code\"\u003eyaml\u003c/code\u003e工程师的血泪 shi\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-be1a0c200df8465293f7023588c8c7dc\" data-id=\"be1a0c200df8465293f7023588c8c7dc\"\u003e\u003cspan\u003e\u003cdiv id=\"be1a0c200df8465293f7023588c8c7dc\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#be1a0c200df8465293f7023588c8c7dc\" title=\"子 Chart 使用中划线时无法作为参数路径选取\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e子 Chart 使用中划线时无法作为参数路径选取\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cpre class=\"notion-code language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e# values\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eyaml\nsub\u003cspan class=\"token operator\"\u003e-\u003c/span\u003efoo\u003cspan class=\"token operator\"\u003e-\u003c/span\u003echart\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003epreferName\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Happy\"\u003c/span\u003e\n\n# _helper\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etpl\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eValues\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esub\u003cspan class=\"token operator\"\u003e-\u003c/span\u003efoo\u003cspan class=\"token operator\"\u003e-\u003c/span\u003echart\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epreferName \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e ❌ 错误写法\n\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e index \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eValues \u003cspan class=\"token string\"\u003e\"sub-foo-chart\"\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"preferName\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e 💩 正确但丑陋的写法\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-row\"\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-bookmark notion-block-753e263d13114c8baeb1ea5f172224cb\" href=\"https://github.com/helm/helm/issues/2192\"\u003e\u003cdiv\u003e\u003cdiv class=\"notion-bookmark-title\"\u003eAccessing values of the subchart with dash in the name · Issue #2192 · helm/helm\u003c/div\u003e\u003cdiv class=\"notion-bookmark-description\"\u003eBased on the docs, there is a convention to name charts with dashes. But at the same time based on this doc, you should never have values with dashes. So, let\u0026#x27;s say I have 2 dependent charts: gitlab and gitlab-runner. How can I configure...\u003c/div\u003e\u003cdiv class=\"notion-bookmark-link\"\u003e\u003cimg src=\"https://github.com/favicon.ico\" alt=\"Accessing values of the subchart with dash in the name · Issue #2192 · helm/helm\" loading=\"lazy\"/\u003e\u003cdiv\u003ehttps://github.com/helm/helm/issues/2192\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-bookmark-image\"\u003e\u003cimg src=\"https://opengraph.githubassets.com/bfc0bd61b92c77a24e09f20dd5af7c1b948be1bdd5f1e6bef8a643e4f1be3a67/helm/helm/issues/2192\" alt=\"Accessing values of the subchart with dash in the name · Issue #2192 · helm/helm\" loading=\"lazy\"/\u003e\u003c/div\u003e\u003c/a\u003e\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-8294e02306dc494d965321332084ebf2\"\u003e \u003c/div\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-f5210e6ca3ce4672baef5771b60122e4\" data-id=\"f5210e6ca3ce4672baef5771b60122e4\"\u003e\u003cspan\u003e\u003cdiv id=\"f5210e6ca3ce4672baef5771b60122e4\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#f5210e6ca3ce4672baef5771b60122e4\" title=\"Chart 之间的继承关系只能有一级\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eChart 之间的继承关系只能有一级\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cdiv class=\"notion-text notion-block-7ccedd92cd344cc28792052af901bc27\"\u003e所有的依赖关系必须简化成两层\u003c/div\u003e\u003cpre class=\"notion-code language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e# parentchart\u003cspan class=\"token operator\"\u003e/\u003c/span\u003erequirements\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eyaml\n\u003cspan class=\"token literal-property property\"\u003edependencies\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e name\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e childchart\n    \u003cspan class=\"token literal-property property\"\u003erepository\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e http\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003elocalhost\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e10191\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003eversion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0.1\u003c/span\u003e\u003cspan class=\"token number\"\u003e.0\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003econdition\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e childchart\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eenabled\n\n# childchart\u003cspan class=\"token operator\"\u003e/\u003c/span\u003erequirements\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eyaml\n\u003cspan class=\"token literal-property property\"\u003edependencies\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e name\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e grandchildchart\n    \u003cspan class=\"token literal-property property\"\u003erepository\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e http\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003elocalhost\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e10191\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003eversion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0.1\u003c/span\u003e\u003cspan class=\"token number\"\u003e.0\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003econdition\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e grandchildchart1\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eenabled\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003echildchart\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003egrandchildchart\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eenabled\n\n# parentchart\u003cspan class=\"token operator\"\u003e/\u003c/span\u003evalues\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eyaml\n\u003cspan class=\"token literal-property property\"\u003echildchart\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003egrandchildchart\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003eenabled\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e  ❌ 并不能够生效\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-row\"\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-bookmark notion-block-d09a4715e5b64c9591f6ed61f316712f\" href=\"https://github.com/helm/helm/issues/5135\"\u003e\u003cdiv\u003e\u003cdiv class=\"notion-bookmark-title\"\u003eNested sub charts values · Issue #5135 · helm/helm\u003c/div\u003e\u003cdiv class=\"notion-bookmark-description\"\u003eYou can\u0026#x27;t perform that action at this time. You signed in with another tab or window. You signed out in another tab or window. Reload to refresh your session. Reload to refresh your session.\u003c/div\u003e\u003cdiv class=\"notion-bookmark-link\"\u003e\u003cimg src=\"https://github.com/favicon.ico\" alt=\"Nested sub charts values · Issue #5135 · helm/helm\" loading=\"lazy\"/\u003e\u003cdiv\u003ehttps://github.com/helm/helm/issues/5135\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-bookmark-image\"\u003e\u003cimg src=\"https://opengraph.githubassets.com/2acc1c0f82187220a5dec781e9bc6a86e7417d3b96ab5ce3dd32241264277fa3/helm/helm/issues/5135\" alt=\"Nested sub charts values · Issue #5135 · helm/helm\" loading=\"lazy\"/\u003e\u003c/div\u003e\u003c/a\u003e\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-b0bea53b8ff94841b76d8ef0a34be617\"\u003e \u003c/div\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-77ed95e367b14e8b90ea4c0161fe21fa\" data-id=\"77ed95e367b14e8b90ea4c0161fe21fa\"\u003e\u003cspan\u003e\u003cdiv id=\"77ed95e367b14e8b90ea4c0161fe21fa\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#77ed95e367b14e8b90ea4c0161fe21fa\" title=\"Hook 创建的资源不能被 uninstall\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eHook 创建的资源不能被 uninstall\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cpre class=\"notion-code language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token literal-property property\"\u003eannotations\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n\t\u003cspan class=\"token string-property property\"\u003e\"helm.sh/hook\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"pre-install\"\u003c/span\u003e\n  \u003cspan class=\"token string-property property\"\u003e\"helm.sh/hook-weight\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"-1\"\u003c/span\u003e\n  \u003cspan class=\"token string-property property\"\u003e\"helm.sh/hook-delete-policy\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e hook\u003cspan class=\"token operator\"\u003e-\u003c/span\u003efailed\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003ebefore\u003cspan class=\"token operator\"\u003e-\u003c/span\u003ehook\u003cspan class=\"token operator\"\u003e-\u003c/span\u003ecreation\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-d98735ecd5d4450481862ed7027ee902\"\u003e类似这样通过 helm hook 创建出来的资源，是不能够被 \u003ccode class=\"notion-inline-code\"\u003ehelm uninstall\u003c/code\u003e 删除的。如果只是用来做一些临时任务当然问题不大，但是我们利用了 hook 创建了一些内建存储，所以无法删除的特性会带来大量的无用存储资源占用，非常头疼。\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-53c2a890dd814d378430b75dfba62485\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-0f9f00ceda3c4ed78774e1eb76bf155c\"\u003e可以通过 label 统一删除，一个临时的 workaround 💩：\u003c/div\u003e\u003cpre class=\"notion-code language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ekubectl \u003cspan class=\"token keyword\"\u003edelete\u003c/span\u003e deploy\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003ests\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003ecronjob\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003epod\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003esvc\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003eingress\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003esecret\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003ecm\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003esa\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003epvc \u003cspan class=\"token operator\"\u003e-\u003c/span\u003en $\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token constant\"\u003eNAMESPACE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003el app\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ekubernetes\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eio\u003cspan class=\"token operator\"\u003e/\u003c/span\u003einstance\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e$\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token constant\"\u003eRELEASE_NAME\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-row\"\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-bookmark notion-block-5054a00d00ee4960b160a65906fcb1a2\" href=\"https://github.com/helm/helm/issues/9206\"\u003e\u003cdiv\u003e\u003cdiv class=\"notion-bookmark-title\"\u003eManifests with hooks not getting deleted during helm uninstall · Issue #9206 · helm/helm\u003c/div\u003e\u003cdiv class=\"notion-bookmark-description\"\u003etomcruise81 changed the title PodDisruptionBudget with hooks not getting deleted during helm uninstall Hooks not getting deleted during helm uninstall Jan 8, 2021 tomcruise81 changed the title Hooks not getting deleted during helm uninstall Manifests with hooks not getting deleted during helm uninstall Jan 8, 2021 You can\u0026#x27;t perform that action at this time.\u003c/div\u003e\u003cdiv class=\"notion-bookmark-link\"\u003e\u003cimg src=\"https://github.com/favicon.ico\" alt=\"Manifests with hooks not getting deleted during helm uninstall · Issue #9206 · helm/helm\" loading=\"lazy\"/\u003e\u003cdiv\u003ehttps://github.com/helm/helm/issues/9206\u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-bookmark-image\"\u003e\u003cimg src=\"https://opengraph.githubassets.com/d56b0963c9d3fd8e0e9035dff30b12ddcc65b9ea136bb3e600ef428bb7aa7f31/helm/helm/issues/9206\" alt=\"Manifests with hooks not getting deleted during helm uninstall · Issue #9206 · helm/helm\" loading=\"lazy\"/\u003e\u003c/div\u003e\u003c/a\u003e\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-0ec7e3aa50f94be6ba7bc47b62f7cd79\"\u003e \u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-55acbb4404c7441a843cc3bf8d644594\" data-id=\"55acbb4404c7441a843cc3bf8d644594\"\u003e\u003cspan\u003e\u003cdiv id=\"55acbb4404c7441a843cc3bf8d644594\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#55acbb4404c7441a843cc3bf8d644594\" title=\"一些苦中作乐的解决方案\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e一些苦中作乐的解决方案\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-blank notion-block-10728219884d423aa0712f69282089e7\"\u003e \u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-71917a09e0634f8dbf4e92909aa32e16\" data-id=\"71917a09e0634f8dbf4e92909aa32e16\"\u003e\u003cspan\u003e\u003cdiv id=\"71917a09e0634f8dbf4e92909aa32e16\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#71917a09e0634f8dbf4e92909aa32e16\" title=\"为多个项目模块创建统一的库\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e为多个项目模块创建统一的库\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-3f59efe5595a4a8fb688c2215c160c73\"\u003e如果项目中存在多个模块，那么可以通过 subChart 方式统一整合\u003c/div\u003e\u003cpre class=\"notion-code language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token literal-property property\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e v2\n\u003cspan class=\"token literal-property property\"\u003ename\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e bk\u003cspan class=\"token operator\"\u003e-\u003c/span\u003euser\u003cspan class=\"token operator\"\u003e-\u003c/span\u003estack\n\u003cspan class=\"token literal-property property\"\u003edescription\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token constant\"\u003eA\u003c/span\u003e Helm chart \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e bk\u003cspan class=\"token operator\"\u003e-\u003c/span\u003euser\n\u003cspan class=\"token literal-property property\"\u003etype\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e application\n\u003cspan class=\"token literal-property property\"\u003eversion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0.5\u003c/span\u003e\u003cspan class=\"token number\"\u003e.1\u003c/span\u003e\n\u003cspan class=\"token literal-property property\"\u003eappVersion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e v2\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token number\"\u003e3.0\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003ea2\n\n\u003cspan class=\"token literal-property property\"\u003edependencies\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e name\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e bkuserapi\n  \u003cspan class=\"token literal-property property\"\u003eversion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"1.0.0\"\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003erepository\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"file://../api\"\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003econdition\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e bkuserapi\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eenabled\n\n\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e name\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e bkusersaas\n  \u003cspan class=\"token literal-property property\"\u003eversion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"1.0.0\"\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003erepository\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"file://../saas\"\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003econdition\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e bkusersaas\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eenabled\n\n\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e name\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e mariadb\n  \u003cspan class=\"token literal-property property\"\u003eversion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"9.x.x\"\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003erepository\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"https://charts.bitnami.com/bitnami\"\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003econdition\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e mariadb\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eenabled\n\n\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e name\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e redis\n  \u003cspan class=\"token literal-property property\"\u003eversion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"14.x.x\"\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003erepository\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"https://charts.bitnami.com/bitnami\"\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003econdition\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e redis\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eenabled\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-48903da852ff4654bebcb266ac18a56d\"\u003e由于 \u003ccode class=\"notion-inline-code\"\u003ebkuserapi\u003c/code\u003e 和 \u003ccode class=\"notion-inline-code\"\u003ebkusersaas\u003c/code\u003e 都有类似的架构，所以重复为二者创建 Helm Chart 一定不是明智的选择。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-389b779cb9d24de79409e2838cde401a\"\u003e我们针对这种 \u003ccode class=\"notion-inline-code\"\u003eweb\u003c/code\u003e 类型的应用\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/TencentBlueKing/bk-user/tree/master/deploy/helm/chartty\"\u003e多封装了一层\u003c/a\u003e，能够一定程度上减少重复劳动。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-5deb5080863d43b8adb1bbcdc9adf9f1\"\u003e可以通过自定义的 \u003ccode class=\"notion-inline-code\"\u003eprocesses\u003c/code\u003e 变量完成对于 workload 的定义和封装：\u003c/div\u003e\u003cpre class=\"notion-code language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e# 定义应用内的多个进程\n\u003cspan class=\"token literal-property property\"\u003eprocesses\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003eweb\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003eingress\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003eenabled\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003ehost\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"bkuser-api.{{ .Values.global.sharedDomain }}\"\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003epaths\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"/\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003ereplicas\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003eresources\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003elimits\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003ecpu\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e 1024m\n        \u003cspan class=\"token literal-property property\"\u003ememory\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e 1024Mi\n      \u003cspan class=\"token literal-property property\"\u003erequests\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003ecpu\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e 200m\n        \u003cspan class=\"token literal-property property\"\u003ememory\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e 128Mi\n    \u003cspan class=\"token literal-property property\"\u003ereadinessProbe\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003etcpSocket\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003eport\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e8000\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003einitialDelaySeconds\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e5\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003eperiodSeconds\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e30\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003elivenessProbe\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003ehttpGet\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003epath\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token operator\"\u003e/\u003c/span\u003eping\n        \u003cspan class=\"token literal-property property\"\u003eport\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e http\n      \u003cspan class=\"token literal-property property\"\u003einitialDelaySeconds\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e5\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003eperiodSeconds\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e30\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003ecelery\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003ereplicas\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003ecommand\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e bash\n    \u003cspan class=\"token literal-property property\"\u003eargs\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token operator\"\u003e/\u003c/span\u003eapp\u003cspan class=\"token operator\"\u003e/\u003c/span\u003estart_celery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esh\n  \u003cspan class=\"token literal-property property\"\u003ebeat\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003ereplicas\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003ecommand\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e bash\n    \u003cspan class=\"token literal-property property\"\u003eargs\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token operator\"\u003e/\u003c/span\u003eapp\u003cspan class=\"token operator\"\u003e/\u003c/span\u003estart_beat\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esh\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-bd9828d26e8646299268870c66857d6f\"\u003e具体内容可以参考 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/TencentBlueKing/bk-user\"\u003eTencentBlueking/bk-user\u003c/a\u003e 的\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/TencentBlueKing/bk-user/tree/master/deploy\"\u003e部署配置\u003c/a\u003e，结合 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/TencentBlueKing/bk-user/blob/master/Makefile\"\u003e\u003ccode class=\"notion-inline-code\"\u003eMakefile\u003c/code\u003e\u003c/a\u003e 可以实现一件部署\\卸载，一定程度上缓解了 Helm 设计弊病带来的不便。\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-f17074b08ac04df2b7195042e95bfde2\"\u003e \u003c/div\u003e\u003c/main\u003e]]\u003e\u003c/content\u003e\n    \u003c/entry\u003e\n    \u003centry\u003e\n        \u003ctitle type=\"html\"\u003e\u003c![CDATA[再见 Helm，你好 CUE]]\u003e\u003c/title\u003e\n        \u003cid\u003ehttps://next.emergencyexit.xyz//cue-vs-helm\u003c/id\u003e\n        \u003clink href=\"https://next.emergencyexit.xyz//cue-vs-helm\"/\u003e\n        \u003cupdated\u003e2021-06-22T00:00:00.000Z\u003c/updated\u003e\n        \u003csummary type=\"html\"\u003e\u003c![CDATA[长江后浪推前浪]]\u003e\u003c/summary\u003e\n        \u003ccontent type=\"html\"\u003e\u003c![CDATA[\u003cmain class=\"notion light-mode notion-page notion-block-29fc49e0b5974f2e9d53b7dd247adf4b\"\u003e\u003cdiv class=\"notion-viewport\"\u003e\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-cee3d36736784353b735b94e70aae135\" data-id=\"cee3d36736784353b735b94e70aae135\"\u003e\u003cspan\u003e\u003cdiv id=\"cee3d36736784353b735b94e70aae135\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#cee3d36736784353b735b94e70aae135\" title=\"什么是 CUE \"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e什么是 CUE \u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cblockquote class=\"notion-quote notion-block-93713b54067e4d4d8fd5545ceafef31d\"\u003eCUE 是一种开源数据验证语言和推理引擎，其根源在于逻辑编程\u003c/blockquote\u003e\u003cdiv class=\"notion-text notion-block-23670d28c3264f668879dc43957ecc39\"\u003e说实话，我一开始也没看懂这句描述。我们先来看个小例子：\u003c/div\u003e\u003cdiv class=\"notion-row notion-block-cae7abf2157a4a958f807af5d39f5d74\"\u003e\u003cdiv class=\"notion-column notion-block-bdc687866d83412db46e4f4e1e2bf19d\" style=\"width:calc((100% - (2 * min(32px, 4vw))) * 0.33333333333333337)\"\u003e\u003cdiv class=\"notion-text notion-block-5d0d8b148df94f75afc8a87c406f1fd1\"\u003eData\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003cdiv class=\"notion-column notion-block-9590d8c1563e4e47b47a3f5c28213eac\" style=\"width:calc((100% - (2 * min(32px, 4vw))) * 0.33333333333333337)\"\u003e\u003cdiv class=\"notion-text notion-block-5aa9bb2472764b88b56fe7e5e6dc669a\"\u003eSchema\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003cdiv class=\"notion-column notion-block-9cd9597644984f859723306e3c59a763\" style=\"width:calc((100% - (2 * min(32px, 4vw))) * 0.3333333333333333)\"\u003e\u003cdiv class=\"notion-text notion-block-03ee002f73a548968ed4c1145a85dda7\"\u003eCUE\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-row notion-block-8c6214435c474c919da623ccf2f0ad43\"\u003e\u003cdiv class=\"notion-column notion-block-36219f7a636c46db92ad53105e6e7e82\" style=\"width:calc((100% - (2 * min(32px, 4vw))) * 0.33333333333333337)\"\u003e\u003cpre class=\"notion-code language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token literal-property property\"\u003emoscow\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003ename\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e    \u003cspan class=\"token string\"\u003e\"Moscow\"\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003epop\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e     \u003cspan class=\"token number\"\u003e11\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e92M\n  \u003cspan class=\"token literal-property property\"\u003ecapital\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003cdiv class=\"notion-column notion-block-a107bd2b6297400194e47487a70a43cd\" style=\"width:calc((100% - (2 * min(32px, 4vw))) * 0.33333333333333337)\"\u003e\u003cpre class=\"notion-code language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token literal-property property\"\u003emunicipality\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003ename\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e    string\n  \u003cspan class=\"token literal-property property\"\u003epop\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e     int\n  \u003cspan class=\"token literal-property property\"\u003ecapital\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e bool\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003cdiv class=\"notion-column notion-block-1cc796762de7497a964b3a198fc0e0c8\" style=\"width:calc((100% - (2 * min(32px, 4vw))) * 0.3333333333333333)\"\u003e\u003cpre class=\"notion-code language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token literal-property property\"\u003elargeCapital\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003ename\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e    string\n  \u003cspan class=\"token literal-property property\"\u003epop\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e     \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e5M\n  \u003cspan class=\"token literal-property property\"\u003ecapital\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-b27f8ba6b225468d86d2df217ce99943\"\u003e在定义 JSON 数据时，我们通常会将 Data 和 Schema 分开处理。而 CUE 则将二者结合在一起，既可以指定数据字段类型，也可以直接填写具体值，也就是 CUE 并不会特意地区分 “类型” 和 “值”， \u003ccode class=\"notion-inline-code\"\u003estring\u003c/code\u003e 和 \u003ccode class=\"notion-inline-code\"\u003e\u0026quot;Moscow\u0026quot;\u003c/code\u003e 都会被当作值 ，但是二者之间有包含的先后顺序，在这里 \u003ccode class=\"notion-inline-code\"\u003e\u0026quot;Moscow\u0026quot;\u003c/code\u003e 可以背归纳于 \u003ccode class=\"notion-inline-code\"\u003estring\u003c/code\u003e 的一种，那么 \u003ccode class=\"notion-inline-code\"\u003estring\u003c/code\u003e 在格(lattice)中会优先于 \u003ccode class=\"notion-inline-code\"\u003e\u0026quot;Moscow\u0026quot;\u003c/code\u003e 。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-ce8295f9201c4044901fde22c24da2e4\"\u003e更多关于 CUE 的介绍，可以通过 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://cuelang.org/docs/\"\u003e官方文档\u003c/a\u003e 和 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/cuelang/cue/blob/master/doc/ref/spec.md\"\u003e定义\u003c/a\u003e 了解过多，这里就不展开了。\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-23c5e5877a1b40cfbb5565ceec5d59fd\" data-id=\"23c5e5877a1b40cfbb5565ceec5d59fd\"\u003e\u003cspan\u003e\u003cdiv id=\"23c5e5877a1b40cfbb5565ceec5d59fd\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#23c5e5877a1b40cfbb5565ceec5d59fd\" title=\"使用 CUE 做模版渲染\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e使用 CUE 做模版渲染\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-5701749373fe49fc90bd4bbddfdad9b9\"\u003eCUE 有\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://cuelang.org/docs/usecases/\"\u003e很多很酷的使用场景\u003c/a\u003e，而先让我们关注其中的配置文件渲染能力。\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-813bf42ff6b14b3fa56e2cbd0132e95c\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-99d6d1fd68744bb2a4d815f7faab754c\"\u003e我们在这里借用 \u003ccode class=\"notion-inline-code\"\u003eKubeVela\u003c/code\u003e \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://kubevela.io/docs/platform-engineers/cue/trait#using-cue-as-trait-schematic\"\u003e文档中的例子\u003c/a\u003e\u003c/div\u003e\u003cpre class=\"notion-code language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token literal-property property\"\u003etemplate\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003eparameter\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003edomain\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string\n      \u003cspan class=\"token literal-property property\"\u003ehttp\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003estring\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e int\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e// trait template can have multiple outputs in one trait\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003eoutputs\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e service\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"v1\"\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003ekind\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e       \u003cspan class=\"token string\"\u003e\"Service\"\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003espec\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"token literal-property property\"\u003eselector\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n              \u003cspan class=\"token literal-property property\"\u003eapp\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e context\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename\n          \u003cspan class=\"token literal-property property\"\u003eports\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n              \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e k\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e v \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e parameter\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehttp \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                  \u003cspan class=\"token literal-property property\"\u003eport\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e       v\n                  \u003cspan class=\"token literal-property property\"\u003etargetPort\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e v\n              \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token literal-property property\"\u003eoutputs\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e ingress\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"networking.k8s.io/v1beta1\"\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003ekind\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e       \u003cspan class=\"token string\"\u003e\"Ingress\"\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003emetadata\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"token literal-property property\"\u003ename\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e context\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename\n      \u003cspan class=\"token literal-property property\"\u003espec\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"token literal-property property\"\u003erules\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n              \u003cspan class=\"token literal-property property\"\u003ehost\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e parameter\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edomain\n              \u003cspan class=\"token literal-property property\"\u003ehttp\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                  \u003cspan class=\"token literal-property property\"\u003epaths\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n                      \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e k\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e v \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e parameter\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehttp \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                          \u003cspan class=\"token literal-property property\"\u003epath\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e k\n                          \u003cspan class=\"token literal-property property\"\u003ebackend\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                              \u003cspan class=\"token literal-property property\"\u003eserviceName\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e context\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename\n                              \u003cspan class=\"token literal-property property\"\u003eservicePort\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e v\n                          \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n                      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                  \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n              \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n          \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-f8746dd32b484b7bb77bcd730761af68\"\u003e可以看到，只需要传入 \u003ccode class=\"notion-inline-code\"\u003eparameter\u003c/code\u003e ，就可以得到包含 \u003ccode class=\"notion-inline-code\"\u003eService\u003c/code\u003e 和 \u003ccode class=\"notion-inline-code\"\u003eIngress\u003c/code\u003e 的 \u003ccode class=\"notion-inline-code\"\u003eoutput\u003c/code\u003e 。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-71a44bc81b3b4c4ebf936a1e1c58159d\"\u003e这样的写法立刻让我们想到了一个类似的工具—— \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/helm/helm\"\u003eHelm\u003c/a\u003e，作为较早的 CNCF 毕业项目，Helm 已经慢慢演进成在 k8s 配置定义领域的事实意义上的工业标准。那么相较于 Helm，用 CUE 来写配置文件渲染，又有什么异同呢？\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-5d00daa945db42608448bda03b815c2b\" data-id=\"5d00daa945db42608448bda03b815c2b\"\u003e\u003cspan\u003e\u003cdiv id=\"5d00daa945db42608448bda03b815c2b\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#5d00daa945db42608448bda03b815c2b\" title=\"CUE vs Helm\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eCUE vs Helm\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-989008d01b664635b96d2dc42f9e7a9a\"\u003e最直观的感受就是，在模版编写上 CUE 比 Helm 流畅太多了。主要的原因二者在最初的设计思路差异，Helm \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://helm.sh/docs/chart_template_guide/functions_and_pipelines/\"\u003e借助的是 Go 和 Spring 的\u003c/a\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://helm.sh/docs/chart_template_guide/functions_and_pipelines/\"\u003e\u003cb\u003e纯文本渲染能力\u003c/b\u003e\u003c/a\u003e，而对于 CUE，JSON 才是一等公民。所以在 K8S 这类 yaml（JSON 超集） 文件渲染上，CUE（也是 JSON 超集） 拥有天然的优势。\u003c/div\u003e\u003cblockquote class=\"notion-quote notion-block-e9405b964f2c42f286fe9f7a0d6b8e2c\"\u003eTalk is cheap， show me the code.\u003c/blockquote\u003e\u003cdiv class=\"notion-text notion-block-88029b498f7c4e97bbe5214631cfeafc\"\u003e我们一起来看几个常用的场景。\u003c/div\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-031ba65fcac24aa2b36de15636aa056f\" data-id=\"031ba65fcac24aa2b36de15636aa056f\"\u003e\u003cspan\u003e\u003cdiv id=\"031ba65fcac24aa2b36de15636aa056f\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#031ba65fcac24aa2b36de15636aa056f\" title=\"Named Templates\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003eNamed Templates\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cdiv class=\"notion-row notion-block-9cf427e0baa84f1c8dddb87577625c37\"\u003e\u003cdiv class=\"notion-column notion-block-b241cd7038c34a49875649595afad489\" style=\"width:calc((100% - (1 * min(32px, 4vw))) * 0.5)\"\u003e\u003cdiv class=\"notion-text notion-block-21b01c95bc74473a874a93c14502279c\"\u003e\u003cb\u003eHelm\u003c/b\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003cdiv class=\"notion-column notion-block-491c44b34b474bfcb09fc70afdfa8cea\" style=\"width:calc((100% - (1 * min(32px, 4vw))) * 0.5)\"\u003e\u003cdiv class=\"notion-text notion-block-ce820d37b02e46079668dece7d0c3be6\"\u003e\u003cb\u003eCUE\u003c/b\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"notion-row notion-block-f3a383cdf740401b9bea7ff394a41113\"\u003e\u003cdiv class=\"notion-column notion-block-d2f540afac254402a8ce7ad3444e4d6f\" style=\"width:calc((100% - (1 * min(32px, 4vw))) * 0.5)\"\u003e\u003cpre class=\"notion-code language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e# values\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eyaml\n\u003cspan class=\"token literal-property property\"\u003eapp_name\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"example_code\"\u003c/span\u003e\n\u003cspan class=\"token literal-property property\"\u003eother_attr1\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"foo\"\u003c/span\u003e\n\u003cspan class=\"token literal-property property\"\u003eother_attr2\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"bar\"\u003c/span\u003e\n\n# labels\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etpl\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e define \u003cspan class=\"token string\"\u003e\"foo.labels\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token literal-property property\"\u003elabel1\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eValues\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eapp_name \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e required \u003cspan class=\"token string\"\u003e\"app_name is required\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \n\u003cspan class=\"token literal-property property\"\u003elabel2\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eValues\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eother_attr2 \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e include \u003cspan class=\"token string\"\u003e\"foo.selectorLabels\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e end \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e define \u003cspan class=\"token string\"\u003e\"foo.selectorLabels\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token literal-property property\"\u003elabel3\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e printf \u003cspan class=\"token string\"\u003e\"%s-%s\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eValues\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eapp_name \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eValues\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eother_attr1 \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e end \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003cdiv class=\"notion-column notion-block-c64eb6ff84e147e0bf6a8631cff370e4\" style=\"width:calc((100% - (1 * min(32px, 4vw))) * 0.49999999999999994)\"\u003e\u003cpre class=\"notion-code language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e# labels\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecue\n\u003cspan class=\"token literal-property property\"\u003eapp_name\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"example_code\"\u003c/span\u003e ｜ string\n\u003cspan class=\"token literal-property property\"\u003eother_attr1\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"foo\"\u003c/span\u003e\n\u003cspan class=\"token literal-property property\"\u003eother_attr2\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"bar\"\u003c/span\u003e\n\n\u003cspan class=\"token literal-property property\"\u003eselector_labels\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token literal-property property\"\u003elabel3\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\\( app_name )-\\( other_attr2 )\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token literal-property property\"\u003elabels\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token literal-property property\"\u003elabel1\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e app_name\n  \u003cspan class=\"token literal-property property\"\u003elabel2\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e other_attr2\n\tselector_labels\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"notion-spacer\"\u003e\u003c/div\u003e\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-8ffe96551d2348138a1fe110c1eef1ed\"\u003e\u003cli\u003eHelm 可以在 \u003ccode class=\"notion-inline-code\"\u003e.tpl\u003c/code\u003e 文件中定义可复用的模版，并支持其他模版引用它，同时，也只有定义了的模版才能被复用，在复杂的 Chart 项目里你\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/bitnami/charts/tree/master/bitnami/common/templates\"\u003e需要额外定义非常多的基础模版\u003c/a\u003e。\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-9b9466c6f7da4fc8a16106adb6406054\"\u003e\u003cli\u003e相对于 Helm 繁琐的写法， 在 CUE 中所有内容均为 JSON 对象，不需要额外的语法去指定模版，任意 JSON 对象都可以互相引用。\u003c/li\u003e\u003c/ul\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-9040cb44603649f1ae931d70b56f2db7\" data-id=\"9040cb44603649f1ae931d70b56f2db7\"\u003e\u003cspan\u003e\u003cdiv id=\"9040cb44603649f1ae931d70b56f2db7\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#9040cb44603649f1ae931d70b56f2db7\" title=\"空行和缩进\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e空行和缩进\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cdiv class=\"notion-text notion-block-c5a1284edb90411baed1881cd6a1be60\"\u003e\u003cb\u003eHelm\u003c/b\u003e\u003c/div\u003e\u003cpre class=\"notion-code language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token literal-property property\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e apps\u003cspan class=\"token operator\"\u003e/\u003c/span\u003ev1\n\u003cspan class=\"token literal-property property\"\u003ekind\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e Deployment\n\u003cspan class=\"token literal-property property\"\u003emetadata\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003ename\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e include \u003cspan class=\"token string\"\u003e\"foo.deploymentName\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003elabels\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e include \u003cspan class=\"token string\"\u003e\"foo.labels\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e nindent \u003cspan class=\"token number\"\u003e4\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token literal-property property\"\u003espec\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003ereplicas\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eValues\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ereplicaCount \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003eselector\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003ematchLabels\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e include \u003cspan class=\"token string\"\u003e\"foo.selectorLabels\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e nindent \u003cspan class=\"token number\"\u003e6\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003estrategy\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e include \u003cspan class=\"token string\"\u003e\"foo.updateStrategy\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e nindent \u003cspan class=\"token number\"\u003e4\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003erevisionHistoryLimit\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eValues\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003erevisionHistoryLimit \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003etemplate\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token literal-property property\"\u003emetadata\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ewith\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eValues\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epodAnnotations \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003eannotations\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e toYaml \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e nindent \u003cspan class=\"token number\"\u003e8\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e end \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"token literal-property property\"\u003elabels\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e include \u003cspan class=\"token string\"\u003e\"foo.labels\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e nindent \u003cspan class=\"token number\"\u003e8\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-2c08e8f37d03498694d0e06547f46453\"\u003e\u003cb\u003eCUE\u003c/b\u003e\u003c/div\u003e\u003cpre class=\"notion-code language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token literal-property property\"\u003edeployment\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token literal-property property\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"apps/v1\"\u003c/span\u003e\n\t\u003cspan class=\"token literal-property property\"\u003ekind\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e       \u003cspan class=\"token string\"\u003e\"Deployment\"\u003c/span\u003e\n\t\u003cspan class=\"token literal-property property\"\u003emetadata\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token literal-property property\"\u003ename\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e   deployment_name\n\t\t\u003cspan class=\"token literal-property property\"\u003elabels\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e labels\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token literal-property property\"\u003espec\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token literal-property property\"\u003ereplicas\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e runtime\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ereplicas\n\t\t\u003cspan class=\"token literal-property property\"\u003eselector\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e matchLabels\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e selector_labels\n\t\t\u003cspan class=\"token literal-property property\"\u003estrategy\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e             update_strategy\n\t\t\u003cspan class=\"token literal-property property\"\u003erevisionHistoryLimit\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e revision_history_limit\u003c/code\u003e\u003c/pre\u003e\u003cul class=\"notion-list notion-list-disc notion-block-b5fcb07810f8485e99a38e65c1b42d39\"\u003e\u003cli\u003e Helm 中有大量的 \u003ccode class=\"notion-inline-code\"\u003e{{- include }}\u003c/code\u003e 和 \u003ccode class=\"notion-inline-code\"\u003enindent\u003c/code\u003e 等和实际逻辑无关的标记字符，需要在每一次引用的地方计算空格和缩进。\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-38b9565048334fb692f4fb38e1eccd09\"\u003e\u003cli\u003e而在 CUE 中无用编码更少，不需要过多的 \u003ccode class=\"notion-inline-code\"\u003e{{ * }}\u003c/code\u003e 来标记代码块，信息密度更高，而且在缩进和空格方面得到了完全的解放。\u003c/li\u003e\u003c/ul\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-23d0196aa8e4404abb2cfa6af7e01572\" data-id=\"23d0196aa8e4404abb2cfa6af7e01572\"\u003e\u003cspan\u003e\u003cdiv id=\"23d0196aa8e4404abb2cfa6af7e01572\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#23d0196aa8e4404abb2cfa6af7e01572\" title=\"values.yaml 自引用\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003evalues.yaml 自引用\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cdiv class=\"notion-text notion-block-e0ebfa7c177e450c92f3fc6c9a54835c\"\u003e在 Helm 中，一个长久以来的头疼问题就是，无法优雅地实现 \u003ccode class=\"notion-inline-code\"\u003evalues.yaml\u003c/code\u003e 引用问题。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-7984173a56cb4bddbbd8efb7f62c2e0f\"\u003e我们看下面的例子：\u003c/div\u003e\u003cpre class=\"notion-code language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token literal-property property\"\u003erootDomain\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\n\n# 我们期待的是通过引用 rootDomain 拼接，例如：\u003cspan class=\"token string\"\u003e\"foo.{{ .Values.rootDomain }}\"\u003c/span\u003e\n\u003cspan class=\"token literal-property property\"\u003eproductDomain\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-f5e89f66c62b4209b64afdb7a67e7970\"\u003e通常的情况下，Chart 的使用者需要针对这两个变量分别填写内容，增加了出错的可能。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-81310d6b8e99401bacf09b9c7fe2da52\"\u003e虽然我们可以通过定义模版来实现：\u003c/div\u003e\u003cpre class=\"notion-code language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e# values\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eyaml\n\u003cspan class=\"token literal-property property\"\u003erootDomain\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\n\u003cspan class=\"token literal-property property\"\u003eproductDomain\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"foo.{{ .Values.rootDomain }}\"\u003c/span\u003e\n\n# helpers\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etpl\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e define \u003cspan class=\"token string\"\u003e\"foo.productDomain\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e tpl \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eValues\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eproductDomain $ \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e end \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n# ingress\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eyaml\n\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n\u003cspan class=\"token literal-property property\"\u003espec\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token literal-property property\"\u003erules\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e host\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e include \u003cspan class=\"token string\"\u003e\"foo.productDomain\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e quote \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-c207daf5e6d04e42aa28ca6867a86049\"\u003e但在实际使用中，所有引用的地方都需要额外 \u003ccode class=\"notion-inline-code\"\u003einclude\u003c/code\u003e ，同时定义的维护也非常耗费心力（要时刻保证空行、缩进不出错）。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-dba38137957a4468a22a83273ff5a207\"\u003e而在 CUE 中，相互引用显得自然而舒服。\u003c/div\u003e\u003cpre class=\"notion-code language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token literal-property property\"\u003erootDomain\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e string\n\u003cspan class=\"token literal-property property\"\u003eproductDomain\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"foo.\\( rootDomain )\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e string\u003c/code\u003e\u003c/pre\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-2d212d1d74ca4f558165434d9a67aa5d\" data-id=\"2d212d1d74ca4f558165434d9a67aa5d\"\u003e\u003cspan\u003e\u003cdiv id=\"2d212d1d74ca4f558165434d9a67aa5d\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#2d212d1d74ca4f558165434d9a67aa5d\" title=\"导入 Kubernetes 包\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e导入 Kubernetes 包\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cdiv class=\"notion-text notion-block-f56cc7da728d41d1a2a8b1d24e94e30a\"\u003eCUE 的另一大杀器，可以针对原生 Kubernetes 源码生成描述 cue 文件，所有 k8s 资源相关的配置文件，都可以天然地拥有 schema 校验。具体教程可以查看 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://cue.googlesource.com/cue/+/HEAD/doc/tutorial/kubernetes/README.md\"\u003eKubernetes tutorial\u003c/a\u003e。\u003c/div\u003e\u003cpre class=\"notion-code language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token keyword\"\u003epackage\u003c/span\u003e templates\n\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n\tapps \u003cspan class=\"token string\"\u003e\"k8s.io/api/apps/v1\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token literal-property property\"\u003edeployment\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e apps\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e#Deployment\n\n\u003cspan class=\"token literal-property property\"\u003edeployment\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token literal-property property\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"apps/v1\"\u003c/span\u003e\n\t\u003cspan class=\"token literal-property property\"\u003ekind\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e       \u003cspan class=\"token string\"\u003e\"Deployment\"\u003c/span\u003e\n\t\u003cspan class=\"token literal-property property\"\u003emetadata\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token literal-property property\"\u003ename\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e   deployment_name\n\t\t\u003cspan class=\"token literal-property property\"\u003elabels\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e _labels\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-1011b4ce77c143f7972cc817a33b4dc5\"\u003e类似这个例子中，我们定义的 \u003ccode class=\"notion-inline-code\"\u003edeployment\u003c/code\u003e 将会通过 \u003ccode class=\"notion-inline-code\"\u003eapps.#Deployment\u003c/code\u003e 校验，轻松检测出不合法的字段。理论上，你可以针对多个不同版本的 k8s 资源都生成 cue 文件，并且都作为 \u003ccode class=\"notion-inline-code\"\u003edeployment\u003c/code\u003e 的模型定义，这样可以实现资源定义的多版本兼容能力。\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-858fcc7fe3e04cc588a79ab7fefd25fc\"\u003e \u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-c355ab655f264eb08bbb13cd6597b2d3\" data-id=\"c355ab655f264eb08bbb13cd6597b2d3\"\u003e\u003cspan\u003e\u003cdiv id=\"c355ab655f264eb08bbb13cd6597b2d3\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#c355ab655f264eb08bbb13cd6597b2d3\" title=\"说了这么多好处，现在就把所有 Helm Chart 都替换成 CUE？\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e说了这么多好处，现在就把所有 Helm Chart 都替换成 CUE？\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-76ee41cf0b014ab58342d9dadfa0dc96\"\u003e且慢，还没到时候。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-66385d718ce5497e80a494732f243c56\"\u003e因为 Helm 作为 \u003ccode class=\"notion-inline-code\"\u003ePackage Manager\u003c/code\u003e ，除了 Chart 渲染，本身还具备一定的应用管理功能，例如 \u003ccode class=\"notion-inline-code\"\u003eHelm install\u003c/code\u003e 、 \u003ccode class=\"notion-inline-code\"\u003eHelm rollback\u003c/code\u003e 等，而 CUE 仅仅是模版。所以在某些我们只使用了 Helm 的模版功能的情况下，可以考虑迁移到 CUE，其他情况，还是用 Helm 吧。\u003c/div\u003e\u003ch4 class=\"notion-h notion-h3 notion-h-indent-1 notion-block-212420499e7c482a85115d93d0ea1e20\" data-id=\"212420499e7c482a85115d93d0ea1e20\"\u003e\u003cspan\u003e\u003cdiv id=\"212420499e7c482a85115d93d0ea1e20\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#212420499e7c482a85115d93d0ea1e20\" title=\"脑洞\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e脑洞\u003c/span\u003e\u003c/span\u003e\u003c/h4\u003e\u003cdiv class=\"notion-text notion-block-5b0d52293b8a424fab06cdfdd4e39da1\"\u003e做一个开源的 CLI，支持将多个文件聚合为一个应用统一管理：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-56634d78612a4897aee018a9de4fd74a\"\u003e\u003cli\u003e类似 Helm 的能力，支持安装、更新、回滚\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-f8a5efbf33194fe1a7b8fbb887ab358e\"\u003e\u003cli\u003e针对配置，支持裸配置和 CUE 文件\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-text notion-block-b29766be75ec4f8b92d692f6e90ff696\"\u003e好了，先说这么多，我去尝试写一写，下篇文章见 👋 ～\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-5731d426beec4b59aae40ca01dd3b6e5\"\u003e \u003c/div\u003e\u003c/main\u003e]]\u003e\u003c/content\u003e\n    \u003c/entry\u003e\n\u003c/feed\u003e"},"__N_SSG":true},"page":"/feed","query":{},"buildId":"qyqiiXSdt0MRRn7fi4Dl1","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>