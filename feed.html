<!DOCTYPE html><html lang="en-US"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/fonts/IBMPlexSansVar-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/IBMPlexSansVar-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="icon" href="/favicon.svg" type="image/svg+xml"/><link rel="icon" href="/favicon.ico"/><link rel="apple-touch-icon" sizes="192x192" href="/apple-touch-icon.png"/><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/feed"/><meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)"/><meta name="theme-color" content="#18181B" media="(prefers-color-scheme: dark)"/><link rel="preload" href="/_next/static/css/0f078069fc629eef.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0f078069fc629eef.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-bcaef6b4d0f9cd74.js" defer=""></script><script src="/_next/static/chunks/framework-97d5d6e713538c3d.js" defer=""></script><script src="/_next/static/chunks/main-6bdeb741743c3d35.js" defer=""></script><script src="/_next/static/chunks/pages/_app-027dce89a6688fda.js" defer=""></script><script src="/_next/static/chunks/pages/feed-188a982286ca851f.js" defer=""></script><script src="/_next/static/ZeWQIFPQD6AiJb2I-3PXg/_buildManifest.js" defer=""></script><script src="/_next/static/ZeWQIFPQD6AiJb2I-3PXg/_ssgManifest.js" defer=""></script></head><body class="bg-day dark:bg-night"><div id="__next" data-reactroot="">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;feed xmlns=&quot;http://www.w3.org/2005/Atom&quot;&gt;
    &lt;id&gt;https://emergencyexit.xyz//&lt;/id&gt;
    &lt;title&gt;布鲁斯鱼的妙想天开&lt;/title&gt;
    &lt;updated&gt;2022-10-17T12:44:39.279Z&lt;/updated&gt;
    &lt;generator&gt;https://github.com/jpmonette/feed&lt;/generator&gt;
    &lt;author&gt;
        &lt;name&gt;amazing-blues&lt;/name&gt;
        &lt;email&gt;bluesedenyu@gmail.com&lt;/email&gt;
        &lt;uri&gt;https://emergencyexit.xyz/&lt;/uri&gt;
    &lt;/author&gt;
    &lt;link rel=&quot;alternate&quot; href=&quot;https://emergencyexit.xyz//&quot;/&gt;
    &lt;subtitle&gt;此间的博文大抵有两类，一种是水的，另一种仍是水的罢。 —— 鲁迅&lt;/subtitle&gt;
    &lt;icon&gt;https://emergencyexit.xyz//favicon.svg&lt;/icon&gt;
    &lt;rights&gt;All rights reserved 2022, amazing-blues&lt;/rights&gt;
    &lt;entry&gt;
        &lt;title type=&quot;html&quot;&gt;&lt;![CDATA[WTF Go: Constants]]&gt;&lt;/title&gt;
        &lt;id&gt;https://emergencyexit.xyz//qffqfq&lt;/id&gt;
        &lt;link href=&quot;https://emergencyexit.xyz//qffqfq&quot;/&gt;
        &lt;updated&gt;2022-10-11T00:00:00.000Z&lt;/updated&gt;
        &lt;summary type=&quot;html&quot;&gt;&lt;![CDATA[eeeee]]&gt;&lt;/summary&gt;
        &lt;content type=&quot;html&quot;&gt;&lt;![CDATA[&lt;main class=&quot;notion light-mode notion-page notion-block-7545e035a53c4c9c97cee21bfc1b45e3&quot;&gt;&lt;div class=&quot;notion-viewport&quot;&gt;&lt;/div&gt;&lt;pre class=&quot;notion-code language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;token string&quot;&gt;&quot;time&quot;&lt;/span&gt;
	&lt;span class=&quot;token string&quot;&gt;&quot;math/rand&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// invalid operation: rand.Intn(10) * 1000 * time.Millisecond (mismatched types int and time.Duration)&lt;/span&gt;
time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Sleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;rand&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Intn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Millisecond&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ❌

&lt;span class=&quot;token comment&quot;&gt;// 🤔 make sense.&lt;/span&gt;
time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Sleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Duration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;rand&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Intn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Millisecond&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ✅

&lt;span class=&quot;token comment&quot;&gt;// wtf ?!&lt;/span&gt;
time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Sleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Millisecond&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ✅ 
&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-aeddbd06e2fc4552b84e372fcc5bde9b&quot;&gt;看看上面这个简单的例子：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-0022383a48734276b49c57d4b62fdeaa&quot;&gt;&lt;li&gt;第一个错误很容易理解： 整型不能和 &lt;code class=&quot;notion-inline-code&quot;&gt;time.Duration&lt;/code&gt; 相乘&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-3aefed93bfe6445d9097822c56293d44&quot;&gt;&lt;li&gt;第二个例子修正了这一问题，符合预期&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-6f15ca3587d54d10a5a4f259a01fcf58&quot;&gt;&lt;li&gt;第三个例子带来了疑问，为什么 &lt;code class=&quot;notion-inline-code&quot;&gt;1000 * time.Millisecond&lt;/code&gt; 却没有问题？明明 &lt;code class=&quot;notion-inline-code&quot;&gt;1000&lt;/code&gt; 也是个整型？编译器戴了有色眼镜？&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-text notion-block-3fe776d69ce041f1b3e64c181051b657&quot;&gt;别慌，仔细看看 &lt;code class=&quot;notion-inline-code&quot;&gt;rand.Intn(10) * 1000&lt;/code&gt; 和 &lt;code class=&quot;notion-inline-code&quot;&gt;1000&lt;/code&gt; 的区别在于：前者是变量，类型已经确定了，通不过编译是情理之中；而后者是常量，类型并不是 &lt;code class=&quot;notion-inline-code&quot;&gt;int&lt;/code&gt; ，属于 &lt;code class=&quot;notion-inline-code&quot;&gt;untyped constants&lt;/code&gt; ，编译器会尝试将它转换成 &lt;code class=&quot;notion-inline-code&quot;&gt;time.Duration&lt;/code&gt; 。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-0e72d18a238e46329e5845a8599ceb30&quot;&gt;这就勾起了我的好奇心，那如果我写个一个 &lt;code class=&quot;notion-inline-code&quot;&gt;float&lt;/code&gt; 常量会怎样呢？&lt;/div&gt;&lt;pre class=&quot;notion-code language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;
&lt;span class=&quot;token comment&quot;&gt;// (untyped float constant) truncated to int64&lt;/span&gt;
time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Sleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1000.1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Millisecond&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ❌&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-9bceb4f93af04ff3808708f9f0673a59&quot;&gt;果然是不行的。那么究竟这个无类型常量的类型转换是依照什么规则进行的呢？&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-cd1dc4daa31a431083bb670ef06adf8b&quot;&gt;首先每一种常量的&lt;b&gt;写法&lt;/b&gt;都会对应着一种默认类型：&lt;/div&gt;&lt;figure class=&quot;notion-asset-wrapper notion-asset-wrapper-image notion-block-2fdbb3a5741244af8b2f83856461e36c&quot;&gt;&lt;div style=&quot;position:relative;display:flex;justify-content:center;align-self:center;width:540px;max-width:100%;flex-direction:column&quot;&gt;&lt;img style=&quot;object-fit:cover&quot; src=&quot;https://www.notion.so/image/https%3A%2F%2Fs3.us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F4841bfb7-5a0d-42ae-ba4c-55881d39feec%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45EIPT3X45%252F20221017%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20221017T124439Z%26X-Amz-Expires%3D86400%26X-Amz-Signature%3D676f750597f7301e6653d9e164e86585ce9e35ec4cc142c03f83e12fc5407910%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject?table=block&amp;amp;id=2fdbb3a5-7412-44af-8b2f-83856461e36c&amp;amp;cache=v2&quot; alt=&quot;notion image&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot;/&gt;&lt;/div&gt;&lt;/figure&gt;&lt;div class=&quot;notion-blank notion-block-8a966ee950464948b2087f66db1b3f62&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-5d52420866574289af6a0e1fd2054dd5&quot;&gt;然后，看看 &lt;code class=&quot;notion-inline-code&quot;&gt;time.Duration&lt;/code&gt; 的定义：&lt;/div&gt;&lt;pre class=&quot;notion-code language-go&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;type Duration int64

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    Nanosecond  Duration &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
    Microsecond          &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; Nanosecond
    Millisecond          &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; Microsecond
    Second               &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; Millisecond
    Minute               &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;60&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; Second
    Hour                 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;60&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; Minute
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-f927db596dd8470481b6d98a3de2ca57&quot;&gt;也就是说 &lt;code class=&quot;notion-inline-code&quot;&gt;1000&lt;/code&gt; 的写法默认类型为 &lt;code class=&quot;notion-inline-code&quot;&gt;int&lt;/code&gt; ，编译器会尝试做一次类型转换 &lt;code class=&quot;notion-inline-code&quot;&gt;int&lt;/code&gt; → &lt;code class=&quot;notion-inline-code&quot;&gt;time.Duration&lt;/code&gt; ，而 &lt;code class=&quot;notion-inline-code&quot;&gt;int64&lt;/code&gt; 和 &lt;code class=&quot;notion-inline-code&quot;&gt;int&lt;/code&gt; 又能做到完全兼容，所以编译通过。&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-e2e94e0784cb4348bbec69b2bdc09138&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-3e6464aaa02340628ea464abeb427f08&quot;&gt;WTF，Go…&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-4bb96aba79554c59a66add95e6674c10&quot; data-id=&quot;4bb96aba79554c59a66add95e6674c10&quot;&gt;&lt;span&gt;&lt;div id=&quot;4bb96aba79554c59a66add95e6674c10&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#4bb96aba79554c59a66add95e6674c10&quot; title=&quot;参考：&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;参考：&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-1fbc6a2020f441909fcf391c04892766&quot;&gt;&lt;li&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://go.dev/blog/constants&quot;&gt;https://go.dev/blog/constants&lt;/a&gt; （本文主要搬运来源）&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-d4ec28d9527d4135a64d0baaf5c2ec6b&quot;&gt;&lt;li&gt;&lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://blog.learngoprogramming.com/learn-golang-typed-untyped-constants-70b4df443b61&quot;&gt;https://blog.learngoprogramming.com/learn-golang-typed-untyped-constants-70b4df443b61&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-blank notion-block-4066b90cd3a2489183e2b264d1d11ab8&quot;&gt; &lt;/div&gt;&lt;/main&gt;]]&gt;&lt;/content&gt;
    &lt;/entry&gt;
    &lt;entry&gt;
        &lt;title type=&quot;html&quot;&gt;&lt;![CDATA[让 DRF Views 支持依赖注入]]&gt;&lt;/title&gt;
        &lt;id&gt;https://emergencyexit.xyz//asdfasdfasdf&lt;/id&gt;
        &lt;link href=&quot;https://emergencyexit.xyz//asdfasdfasdf&quot;/&gt;
        &lt;updated&gt;2021-05-24T00:00:00.000Z&lt;/updated&gt;
        &lt;summary type=&quot;html&quot;&gt;&lt;![CDATA[asdfasdfasd]]&gt;&lt;/summary&gt;
        &lt;content type=&quot;html&quot;&gt;&lt;![CDATA[&lt;main class=&quot;notion light-mode notion-page notion-block-680e8aba94e74721952d011a44a20ebe&quot;&gt;&lt;div class=&quot;notion-viewport&quot;&gt;&lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-32d25641e8064c55bfcf9814a31d11fd&quot; data-id=&quot;32d25641e8064c55bfcf9814a31d11fd&quot;&gt;&lt;span&gt;&lt;div id=&quot;32d25641e8064c55bfcf9814a31d11fd&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#32d25641e8064c55bfcf9814a31d11fd&quot; title=&quot;起因&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;起因&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-91535e58c80c4af0af7afd3bf9256bbb&quot;&gt;Django 和 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://www.django-rest-framework.org/&quot;&gt;Django REST framework&lt;/a&gt; 是 Python 开发者常用的框架组合，通常来说，一个典型的 DRF 式 API 可能长这个样子：&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;from rest_framework&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;generics &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; ListAPIView


&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ProfileViewSet&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ListAPIView&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    def &lt;span class=&quot;token function&quot;&gt;login&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;self&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; request&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        serializer &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;LoginSerializer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;request&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        serializer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;is_valid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;raise_exception&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;True&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        validated_data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; serializer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;validated_data

        &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Response&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ProfileSerializer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;results&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; many&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;True&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-blank notion-block-487e55663484486bae984465b860d412&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-89f7b3196141406fbd0883fe515d95fd&quot;&gt;这样写在逻辑上是简单的，可以让开发者对用户请求处理有一个清晰的脉络，但同时也会带来问题：&lt;code class=&quot;notion-inline-code&quot;&gt;Serializer&lt;/code&gt; 的逻辑和主逻辑混杂，使单元测试构造困难。&lt;/div&gt;&lt;div class=&quot;notion-text notion-block-13bf0cd7f4c74446b5dfc729ea5396f3&quot;&gt;同时，输入输出的代码在多个 API 中是有一定程度重复的， &lt;code class=&quot;notion-inline-code&quot;&gt;D.R.Y&lt;/code&gt; 重度患者无法接受。&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-650523c412c54263b4d3fadc411836ac&quot;&gt; &lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-470f666078b843248e033a9f28c499b2&quot; data-id=&quot;470f666078b843248e033a9f28c499b2&quot;&gt;&lt;span&gt;&lt;div id=&quot;470f666078b843248e033a9f28c499b2&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#470f666078b843248e033a9f28c499b2&quot; title=&quot;启发&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;启发&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-text notion-block-a2a1247b2eb0482da59d9fbdd337a427&quot;&gt;新贵框架 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://fastapi.tiangolo.com/&quot;&gt;FastAPI&lt;/a&gt; 的 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://fastapi.tiangolo.com/tutorial/dependencies/#what-is-dependency-injection&quot;&gt;依赖注入特性&lt;/a&gt; 就能够很好的解决以上两点：&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;from fastapi &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; Depends&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; FastAPI

app &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;FastAPI&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

@app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;/items/&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; def &lt;span class=&quot;token function&quot;&gt;read_items&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;commons&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; dict &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Depends&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;common_parameters&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; commons&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-blank notion-block-d6fed93f685d4f82963110dbf945a4bf&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-b300113037244b91b2af29fcf03a75eb&quot;&gt;然而，现实中的工程中切换框架往往是成本高昂的，仅仅为了依赖注入而切换框架显得有些小题大做。所以，如果能在 Django &amp;amp; DRF 中实现类似依赖注入的功能，会较大程度提高 &lt;code class=&quot;notion-inline-code&quot;&gt;views&lt;/code&gt; 的可读性并降低 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://en.wikipedia.org/wiki/Test-driven_development&quot;&gt;TDD &lt;/a&gt;的门槛，间接提高代码质量。&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-5417c9caad4d4972b620a9f3cb7f4970&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-9854566dd31942bbb20f6f9809b2457f&quot;&gt;同时我们需要满足几个条件：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-06d2468f5457474b8f008732314be6b4&quot;&gt;&lt;li&gt;能够兼容当前的 ViewSet 类&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-018715b306484c6dbc85432e58b83052&quot;&gt;&lt;li&gt;能够复用 Serializer&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-df76653a130e41f2a545222fb87fa0ea&quot;&gt;&lt;li&gt;（可选）能够复用 &lt;code class=&quot;notion-inline-code&quot;&gt;drf-yasg&lt;/code&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-blank notion-block-1635ff6ebfa040028a029b561366bf6a&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-4c336f4e870e4f92a6de773b562b3819&quot;&gt;综上，我写了一个 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://gist.github.com/IMBlues/e36e792159729f429f9abf656ba24d10&quot;&gt;简单的文件&lt;/a&gt; ，你可以将它 Copy 到你的 DRF 项目中就可以改造原来的 &lt;code class=&quot;notion-inline-code&quot;&gt;ViewSet&lt;/code&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-dfb6d917666e4461a530db83fda0262d&quot;&gt;（当前需求是比较简单的，封装成 SDK 然后安装依赖的成本反而高于直接复制粘贴，&lt;s&gt;这样大家可以一起偷懒&lt;/s&gt;）&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-b167cfdccb6c47efb572430771521082&quot;&gt; &lt;/div&gt;&lt;h3 class=&quot;notion-h notion-h2 notion-h-indent-0 notion-block-771671b34a31433f911562dee8577d84&quot; data-id=&quot;771671b34a31433f911562dee8577d84&quot;&gt;&lt;span&gt;&lt;div id=&quot;771671b34a31433f911562dee8577d84&quot; class=&quot;notion-header-anchor&quot;&gt;&lt;/div&gt;&lt;a class=&quot;notion-hash-link&quot; href=&quot;#771671b34a31433f911562dee8577d84&quot; title=&quot;最后的效果：&quot;&gt;&lt;svg viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;span class=&quot;notion-h-title&quot;&gt;最后的效果：&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;notion-blank notion-block-17af11c97cbc4b1d93f5b89fa7d1282b&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-7fe4258f3236411f824763bc34aca3a9&quot;&gt;原来的 &lt;code class=&quot;notion-inline-code&quot;&gt;ViewSet&lt;/code&gt; （包含 &lt;code class=&quot;notion-inline-code&quot;&gt;drf-yasg&lt;/code&gt; 的 schema 生成）&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ProfileViewSet&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ListAPIView&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    @&lt;span class=&quot;token function&quot;&gt;swagger_auto_schema&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        request_body&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;LoginSerializer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        responses&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;status&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;HTTP_200_OK&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ProfileSerializer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    def &lt;span class=&quot;token function&quot;&gt;login&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;self&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; request&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        serializer &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;LoginSerializer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;request&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        serializer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;is_valid&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;raise_exception&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;True&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        validated_data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; serializer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;validated_data

        &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Response&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ProfileSerializer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;results&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; many&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;True&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-blank notion-block-d547ba772b374495a23c34f531714dc2&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-60d9ef93f6764e24bedaa76a6d5b16f0&quot;&gt;改造之后的效果：&lt;/div&gt;&lt;pre class=&quot;notion-code language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;from some_path&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;inject &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; serializer_inject


&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ProfileViewSet&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ListAPIView&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
    @&lt;span class=&quot;token function&quot;&gt;serializer_inject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        in_cls&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;LoginSerializer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        out_cls&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;ProfileSerializer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        # 选择去掉原有的 request 依赖
        config&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token string-property property&quot;&gt;&quot;remain_request&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; False&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        out_params&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token string-property property&quot;&gt;&quot;many&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; True&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    def &lt;span class=&quot;token function&quot;&gt;login&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;self&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;validated_data&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; dict&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        # 原来的逻辑部分
        &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; results&lt;/code&gt;&lt;/pre&gt;&lt;div class=&quot;notion-text notion-block-75e90e26df1e496fae329bc50189185a&quot;&gt;（可以通过 &lt;a target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; class=&quot;notion-link&quot; href=&quot;https://gist.github.com/IMBlues/e36e792159729f429f9abf656ba24d10#gistcomment-3754830&quot;&gt;gist 评论&lt;/a&gt; 获取更多的例子）&lt;/div&gt;&lt;div class=&quot;notion-blank notion-block-178df46b51be40f39833f7e739f6fa69&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-759f22f4cc5b4ec99bc33aaf3f7a1e6a&quot;&gt;这样的改造我们得到了一些好处：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-00853b638ffa4752a1f3c6ff23bae24d&quot;&gt;&lt;li&gt;仅需要简单改造原来的 &lt;code class=&quot;notion-inline-code&quot;&gt;ViewSet&lt;/code&gt; &lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-b2f732fd222743e18b2124bdf07c7ca6&quot;&gt;&lt;li&gt;完全继承原来的 &lt;code class=&quot;notion-inline-code&quot;&gt;Serializer&lt;/code&gt; &lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-b1b80a8daad7457a89e597ef8a162d24&quot;&gt;&lt;li&gt;完整支持 &lt;code class=&quot;notion-inline-code&quot;&gt;drf-yasg&lt;/code&gt; &lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-b0ba56669bfd404188022485e144a991&quot;&gt;&lt;li&gt;在原来主干逻辑没有依赖 &lt;code class=&quot;notion-inline-code&quot;&gt;request&lt;/code&gt; 对象的情况下，单元测试的用例构造被简化成了 &lt;code class=&quot;notion-inline-code&quot;&gt;dict&lt;/code&gt; &lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-blank notion-block-c1b95c8cb2b34115939e834f030e59c8&quot;&gt; &lt;/div&gt;&lt;div class=&quot;notion-text notion-block-3bd340124d074872b83a16c9231d6132&quot;&gt;当然仍旧还有不完美的地方：&lt;/div&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-da6776d758d24314bafcbd32db93339b&quot;&gt;&lt;li&gt;没有使用 &lt;code class=&quot;notion-inline-code&quot;&gt;Type Annotation&lt;/code&gt; ，在声明上较 &lt;code class=&quot;notion-inline-code&quot;&gt;FastAPI&lt;/code&gt; 更为冗余&lt;/li&gt;&lt;/ul&gt;&lt;ul class=&quot;notion-list notion-list-disc notion-block-5d20efd05c664ced8175b0b0ac5ae291&quot;&gt;&lt;li&gt;对于返回值使用了 &lt;code class=&quot;notion-inline-code&quot;&gt;context&lt;/code&gt; 的 &lt;code class=&quot;notion-inline-code&quot;&gt;Serializer&lt;/code&gt; 需要通过 &lt;code class=&quot;notion-inline-code&quot;&gt;inject.ResponseParams&lt;/code&gt; 类来包装一次，显得不那么纯粹，暂时也没有更好的思路，&lt;s&gt;有空再慢慢改（咕咕🐦）。&lt;/s&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div class=&quot;notion-blank notion-block-01e6b58440774af28ddef8d0de6a2ca9&quot;&gt; &lt;/div&gt;&lt;/main&gt;]]&gt;&lt;/content&gt;
    &lt;/entry&gt;
&lt;/feed&gt;</div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"xmlFeed":"\u003c?xml version=\"1.0\" encoding=\"utf-8\"?\u003e\n\u003cfeed xmlns=\"http://www.w3.org/2005/Atom\"\u003e\n    \u003cid\u003ehttps://emergencyexit.xyz//\u003c/id\u003e\n    \u003ctitle\u003e布鲁斯鱼的妙想天开\u003c/title\u003e\n    \u003cupdated\u003e2022-10-17T12:44:39.279Z\u003c/updated\u003e\n    \u003cgenerator\u003ehttps://github.com/jpmonette/feed\u003c/generator\u003e\n    \u003cauthor\u003e\n        \u003cname\u003eamazing-blues\u003c/name\u003e\n        \u003cemail\u003ebluesedenyu@gmail.com\u003c/email\u003e\n        \u003curi\u003ehttps://emergencyexit.xyz/\u003c/uri\u003e\n    \u003c/author\u003e\n    \u003clink rel=\"alternate\" href=\"https://emergencyexit.xyz//\"/\u003e\n    \u003csubtitle\u003e此间的博文大抵有两类，一种是水的，另一种仍是水的罢。 —— 鲁迅\u003c/subtitle\u003e\n    \u003cicon\u003ehttps://emergencyexit.xyz//favicon.svg\u003c/icon\u003e\n    \u003crights\u003eAll rights reserved 2022, amazing-blues\u003c/rights\u003e\n    \u003centry\u003e\n        \u003ctitle type=\"html\"\u003e\u003c![CDATA[WTF Go: Constants]]\u003e\u003c/title\u003e\n        \u003cid\u003ehttps://emergencyexit.xyz//qffqfq\u003c/id\u003e\n        \u003clink href=\"https://emergencyexit.xyz//qffqfq\"/\u003e\n        \u003cupdated\u003e2022-10-11T00:00:00.000Z\u003c/updated\u003e\n        \u003csummary type=\"html\"\u003e\u003c![CDATA[eeeee]]\u003e\u003c/summary\u003e\n        \u003ccontent type=\"html\"\u003e\u003c![CDATA[\u003cmain class=\"notion light-mode notion-page notion-block-7545e035a53c4c9c97cee21bfc1b45e3\"\u003e\u003cdiv class=\"notion-viewport\"\u003e\u003c/div\u003e\u003cpre class=\"notion-code language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n\t\u003cspan class=\"token string\"\u003e\"time\"\u003c/span\u003e\n\t\u003cspan class=\"token string\"\u003e\"math/rand\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// invalid operation: rand.Intn(10) * 1000 * time.Millisecond (mismatched types int and time.Duration)\u003c/span\u003e\ntime\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSleep\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erand\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eIntn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMillisecond\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e ❌\n\n\u003cspan class=\"token comment\"\u003e// 🤔 make sense.\u003c/span\u003e\ntime\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSleep\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etime\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eDuration\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erand\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eIntn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMillisecond\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e ✅\n\n\u003cspan class=\"token comment\"\u003e// wtf ?!\u003c/span\u003e\ntime\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSleep\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1000\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMillisecond\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e ✅ \n\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-aeddbd06e2fc4552b84e372fcc5bde9b\"\u003e看看上面这个简单的例子：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-0022383a48734276b49c57d4b62fdeaa\"\u003e\u003cli\u003e第一个错误很容易理解： 整型不能和 \u003ccode class=\"notion-inline-code\"\u003etime.Duration\u003c/code\u003e 相乘\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-3aefed93bfe6445d9097822c56293d44\"\u003e\u003cli\u003e第二个例子修正了这一问题，符合预期\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-6f15ca3587d54d10a5a4f259a01fcf58\"\u003e\u003cli\u003e第三个例子带来了疑问，为什么 \u003ccode class=\"notion-inline-code\"\u003e1000 * time.Millisecond\u003c/code\u003e 却没有问题？明明 \u003ccode class=\"notion-inline-code\"\u003e1000\u003c/code\u003e 也是个整型？编译器戴了有色眼镜？\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-text notion-block-3fe776d69ce041f1b3e64c181051b657\"\u003e别慌，仔细看看 \u003ccode class=\"notion-inline-code\"\u003erand.Intn(10) * 1000\u003c/code\u003e 和 \u003ccode class=\"notion-inline-code\"\u003e1000\u003c/code\u003e 的区别在于：前者是变量，类型已经确定了，通不过编译是情理之中；而后者是常量，类型并不是 \u003ccode class=\"notion-inline-code\"\u003eint\u003c/code\u003e ，属于 \u003ccode class=\"notion-inline-code\"\u003euntyped constants\u003c/code\u003e ，编译器会尝试将它转换成 \u003ccode class=\"notion-inline-code\"\u003etime.Duration\u003c/code\u003e 。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-0e72d18a238e46329e5845a8599ceb30\"\u003e这就勾起了我的好奇心，那如果我写个一个 \u003ccode class=\"notion-inline-code\"\u003efloat\u003c/code\u003e 常量会怎样呢？\u003c/div\u003e\u003cpre class=\"notion-code language-go\"\u003e\u003ccode class=\"language-go\"\u003e\n\u003cspan class=\"token comment\"\u003e// (untyped float constant) truncated to int64\u003c/span\u003e\ntime\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSleep\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1000.1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMillisecond\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e ❌\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-9bceb4f93af04ff3808708f9f0673a59\"\u003e果然是不行的。那么究竟这个无类型常量的类型转换是依照什么规则进行的呢？\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-cd1dc4daa31a431083bb670ef06adf8b\"\u003e首先每一种常量的\u003cb\u003e写法\u003c/b\u003e都会对应着一种默认类型：\u003c/div\u003e\u003cfigure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-2fdbb3a5741244af8b2f83856461e36c\"\u003e\u003cdiv style=\"position:relative;display:flex;justify-content:center;align-self:center;width:540px;max-width:100%;flex-direction:column\"\u003e\u003cimg style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fs3.us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F4841bfb7-5a0d-42ae-ba4c-55881d39feec%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DAKIAT73L2G45EIPT3X45%252F20221017%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20221017T124439Z%26X-Amz-Expires%3D86400%26X-Amz-Signature%3D676f750597f7301e6653d9e164e86585ce9e35ec4cc142c03f83e12fc5407910%26X-Amz-SignedHeaders%3Dhost%26x-id%3DGetObject?table=block\u0026amp;id=2fdbb3a5-7412-44af-8b2f-83856461e36c\u0026amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/\u003e\u003c/div\u003e\u003c/figure\u003e\u003cdiv class=\"notion-blank notion-block-8a966ee950464948b2087f66db1b3f62\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-5d52420866574289af6a0e1fd2054dd5\"\u003e然后，看看 \u003ccode class=\"notion-inline-code\"\u003etime.Duration\u003c/code\u003e 的定义：\u003c/div\u003e\u003cpre class=\"notion-code language-go\"\u003e\u003ccode class=\"language-go\"\u003etype Duration int64\n\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    Nanosecond  Duration \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n    Microsecond          \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e Nanosecond\n    Millisecond          \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e Microsecond\n    Second               \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e Millisecond\n    Minute               \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e60\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e Second\n    Hour                 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e60\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e Minute\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-f927db596dd8470481b6d98a3de2ca57\"\u003e也就是说 \u003ccode class=\"notion-inline-code\"\u003e1000\u003c/code\u003e 的写法默认类型为 \u003ccode class=\"notion-inline-code\"\u003eint\u003c/code\u003e ，编译器会尝试做一次类型转换 \u003ccode class=\"notion-inline-code\"\u003eint\u003c/code\u003e → \u003ccode class=\"notion-inline-code\"\u003etime.Duration\u003c/code\u003e ，而 \u003ccode class=\"notion-inline-code\"\u003eint64\u003c/code\u003e 和 \u003ccode class=\"notion-inline-code\"\u003eint\u003c/code\u003e 又能做到完全兼容，所以编译通过。\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-e2e94e0784cb4348bbec69b2bdc09138\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-3e6464aaa02340628ea464abeb427f08\"\u003eWTF，Go…\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-4bb96aba79554c59a66add95e6674c10\" data-id=\"4bb96aba79554c59a66add95e6674c10\"\u003e\u003cspan\u003e\u003cdiv id=\"4bb96aba79554c59a66add95e6674c10\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#4bb96aba79554c59a66add95e6674c10\" title=\"参考：\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e参考：\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cul class=\"notion-list notion-list-disc notion-block-1fbc6a2020f441909fcf391c04892766\"\u003e\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://go.dev/blog/constants\"\u003ehttps://go.dev/blog/constants\u003c/a\u003e （本文主要搬运来源）\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-d4ec28d9527d4135a64d0baaf5c2ec6b\"\u003e\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://blog.learngoprogramming.com/learn-golang-typed-untyped-constants-70b4df443b61\"\u003ehttps://blog.learngoprogramming.com/learn-golang-typed-untyped-constants-70b4df443b61\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-blank notion-block-4066b90cd3a2489183e2b264d1d11ab8\"\u003e \u003c/div\u003e\u003c/main\u003e]]\u003e\u003c/content\u003e\n    \u003c/entry\u003e\n    \u003centry\u003e\n        \u003ctitle type=\"html\"\u003e\u003c![CDATA[让 DRF Views 支持依赖注入]]\u003e\u003c/title\u003e\n        \u003cid\u003ehttps://emergencyexit.xyz//asdfasdfasdf\u003c/id\u003e\n        \u003clink href=\"https://emergencyexit.xyz//asdfasdfasdf\"/\u003e\n        \u003cupdated\u003e2021-05-24T00:00:00.000Z\u003c/updated\u003e\n        \u003csummary type=\"html\"\u003e\u003c![CDATA[asdfasdfasd]]\u003e\u003c/summary\u003e\n        \u003ccontent type=\"html\"\u003e\u003c![CDATA[\u003cmain class=\"notion light-mode notion-page notion-block-680e8aba94e74721952d011a44a20ebe\"\u003e\u003cdiv class=\"notion-viewport\"\u003e\u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-32d25641e8064c55bfcf9814a31d11fd\" data-id=\"32d25641e8064c55bfcf9814a31d11fd\"\u003e\u003cspan\u003e\u003cdiv id=\"32d25641e8064c55bfcf9814a31d11fd\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#32d25641e8064c55bfcf9814a31d11fd\" title=\"起因\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e起因\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-91535e58c80c4af0af7afd3bf9256bbb\"\u003eDjango 和 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://www.django-rest-framework.org/\"\u003eDjango REST framework\u003c/a\u003e 是 Python 开发者常用的框架组合，通常来说，一个典型的 DRF 式 API 可能长这个样子：\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003efrom rest_framework\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003egenerics \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e ListAPIView\n\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eProfileViewSet\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eListAPIView\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    def \u003cspan class=\"token function\"\u003elogin\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eself\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e request\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        serializer \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eLoginSerializer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edata\u003cspan class=\"token operator\"\u003e=\u003c/span\u003erequest\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edata\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        serializer\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eis_valid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eraise_exception\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eTrue\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        validated_data \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e serializer\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003evalidated_data\n\n        \u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003eResponse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edata\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token function\"\u003eProfileSerializer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eresults\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e many\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eTrue\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edata\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-blank notion-block-487e55663484486bae984465b860d412\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-89f7b3196141406fbd0883fe515d95fd\"\u003e这样写在逻辑上是简单的，可以让开发者对用户请求处理有一个清晰的脉络，但同时也会带来问题：\u003ccode class=\"notion-inline-code\"\u003eSerializer\u003c/code\u003e 的逻辑和主逻辑混杂，使单元测试构造困难。\u003c/div\u003e\u003cdiv class=\"notion-text notion-block-13bf0cd7f4c74446b5dfc729ea5396f3\"\u003e同时，输入输出的代码在多个 API 中是有一定程度重复的， \u003ccode class=\"notion-inline-code\"\u003eD.R.Y\u003c/code\u003e 重度患者无法接受。\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-650523c412c54263b4d3fadc411836ac\"\u003e \u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-470f666078b843248e033a9f28c499b2\" data-id=\"470f666078b843248e033a9f28c499b2\"\u003e\u003cspan\u003e\u003cdiv id=\"470f666078b843248e033a9f28c499b2\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#470f666078b843248e033a9f28c499b2\" title=\"启发\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e启发\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-text notion-block-a2a1247b2eb0482da59d9fbdd337a427\"\u003e新贵框架 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://fastapi.tiangolo.com/\"\u003eFastAPI\u003c/a\u003e 的 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://fastapi.tiangolo.com/tutorial/dependencies/#what-is-dependency-injection\"\u003e依赖注入特性\u003c/a\u003e 就能够很好的解决以上两点：\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003efrom fastapi \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e Depends\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e FastAPI\n\napp \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eFastAPI\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n@app\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"/items/\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003easync\u003c/span\u003e def \u003cspan class=\"token function\"\u003eread_items\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ecommons\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e dict \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eDepends\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ecommon_parameters\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e commons\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-blank notion-block-d6fed93f685d4f82963110dbf945a4bf\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-b300113037244b91b2af29fcf03a75eb\"\u003e然而，现实中的工程中切换框架往往是成本高昂的，仅仅为了依赖注入而切换框架显得有些小题大做。所以，如果能在 Django \u0026amp; DRF 中实现类似依赖注入的功能，会较大程度提高 \u003ccode class=\"notion-inline-code\"\u003eviews\u003c/code\u003e 的可读性并降低 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://en.wikipedia.org/wiki/Test-driven_development\"\u003eTDD \u003c/a\u003e的门槛，间接提高代码质量。\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-5417c9caad4d4972b620a9f3cb7f4970\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-9854566dd31942bbb20f6f9809b2457f\"\u003e同时我们需要满足几个条件：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-06d2468f5457474b8f008732314be6b4\"\u003e\u003cli\u003e能够兼容当前的 ViewSet 类\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-018715b306484c6dbc85432e58b83052\"\u003e\u003cli\u003e能够复用 Serializer\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-df76653a130e41f2a545222fb87fa0ea\"\u003e\u003cli\u003e（可选）能够复用 \u003ccode class=\"notion-inline-code\"\u003edrf-yasg\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-blank notion-block-1635ff6ebfa040028a029b561366bf6a\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-4c336f4e870e4f92a6de773b562b3819\"\u003e综上，我写了一个 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://gist.github.com/IMBlues/e36e792159729f429f9abf656ba24d10\"\u003e简单的文件\u003c/a\u003e ，你可以将它 Copy 到你的 DRF 项目中就可以改造原来的 \u003ccode class=\"notion-inline-code\"\u003eViewSet\u003c/code\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-dfb6d917666e4461a530db83fda0262d\"\u003e（当前需求是比较简单的，封装成 SDK 然后安装依赖的成本反而高于直接复制粘贴，\u003cs\u003e这样大家可以一起偷懒\u003c/s\u003e）\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-b167cfdccb6c47efb572430771521082\"\u003e \u003c/div\u003e\u003ch3 class=\"notion-h notion-h2 notion-h-indent-0 notion-block-771671b34a31433f911562dee8577d84\" data-id=\"771671b34a31433f911562dee8577d84\"\u003e\u003cspan\u003e\u003cdiv id=\"771671b34a31433f911562dee8577d84\" class=\"notion-header-anchor\"\u003e\u003c/div\u003e\u003ca class=\"notion-hash-link\" href=\"#771671b34a31433f911562dee8577d84\" title=\"最后的效果：\"\u003e\u003csvg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003cspan class=\"notion-h-title\"\u003e最后的效果：\u003c/span\u003e\u003c/span\u003e\u003c/h3\u003e\u003cdiv class=\"notion-blank notion-block-17af11c97cbc4b1d93f5b89fa7d1282b\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-7fe4258f3236411f824763bc34aca3a9\"\u003e原来的 \u003ccode class=\"notion-inline-code\"\u003eViewSet\u003c/code\u003e （包含 \u003ccode class=\"notion-inline-code\"\u003edrf-yasg\u003c/code\u003e 的 schema 生成）\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eProfileViewSet\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eListAPIView\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    @\u003cspan class=\"token function\"\u003eswagger_auto_schema\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n        request_body\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eLoginSerializer\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        responses\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003estatus\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eHTTP_200_OK\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token function\"\u003eProfileSerializer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    def \u003cspan class=\"token function\"\u003elogin\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eself\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e request\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        serializer \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eLoginSerializer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edata\u003cspan class=\"token operator\"\u003e=\u003c/span\u003erequest\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edata\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        serializer\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eis_valid\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eraise_exception\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eTrue\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        validated_data \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e serializer\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003evalidated_data\n\n        \u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003eResponse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edata\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token function\"\u003eProfileSerializer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eresults\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e many\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eTrue\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edata\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-blank notion-block-d547ba772b374495a23c34f531714dc2\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-60d9ef93f6764e24bedaa76a6d5b16f0\"\u003e改造之后的效果：\u003c/div\u003e\u003cpre class=\"notion-code language-python\"\u003e\u003ccode class=\"language-python\"\u003efrom some_path\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003einject \u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e serializer_inject\n\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eProfileViewSet\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eListAPIView\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    @\u003cspan class=\"token function\"\u003eserializer_inject\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n        in_cls\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eLoginSerializer\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        out_cls\u003cspan class=\"token operator\"\u003e=\u003c/span\u003eProfileSerializer\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        # 选择去掉原有的 request 依赖\n        config\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token string-property property\"\u003e\"remain_request\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e False\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        out_params\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token string-property property\"\u003e\"many\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e True\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    def \u003cspan class=\"token function\"\u003elogin\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eself\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token literal-property property\"\u003evalidated_data\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e dict\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n        # 原来的逻辑部分\n        \u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e results\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"notion-text notion-block-75e90e26df1e496fae329bc50189185a\"\u003e（可以通过 \u003ca target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://gist.github.com/IMBlues/e36e792159729f429f9abf656ba24d10#gistcomment-3754830\"\u003egist 评论\u003c/a\u003e 获取更多的例子）\u003c/div\u003e\u003cdiv class=\"notion-blank notion-block-178df46b51be40f39833f7e739f6fa69\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-759f22f4cc5b4ec99bc33aaf3f7a1e6a\"\u003e这样的改造我们得到了一些好处：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-00853b638ffa4752a1f3c6ff23bae24d\"\u003e\u003cli\u003e仅需要简单改造原来的 \u003ccode class=\"notion-inline-code\"\u003eViewSet\u003c/code\u003e \u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-b2f732fd222743e18b2124bdf07c7ca6\"\u003e\u003cli\u003e完全继承原来的 \u003ccode class=\"notion-inline-code\"\u003eSerializer\u003c/code\u003e \u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-b1b80a8daad7457a89e597ef8a162d24\"\u003e\u003cli\u003e完整支持 \u003ccode class=\"notion-inline-code\"\u003edrf-yasg\u003c/code\u003e \u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-b0ba56669bfd404188022485e144a991\"\u003e\u003cli\u003e在原来主干逻辑没有依赖 \u003ccode class=\"notion-inline-code\"\u003erequest\u003c/code\u003e 对象的情况下，单元测试的用例构造被简化成了 \u003ccode class=\"notion-inline-code\"\u003edict\u003c/code\u003e \u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-blank notion-block-c1b95c8cb2b34115939e834f030e59c8\"\u003e \u003c/div\u003e\u003cdiv class=\"notion-text notion-block-3bd340124d074872b83a16c9231d6132\"\u003e当然仍旧还有不完美的地方：\u003c/div\u003e\u003cul class=\"notion-list notion-list-disc notion-block-da6776d758d24314bafcbd32db93339b\"\u003e\u003cli\u003e没有使用 \u003ccode class=\"notion-inline-code\"\u003eType Annotation\u003c/code\u003e ，在声明上较 \u003ccode class=\"notion-inline-code\"\u003eFastAPI\u003c/code\u003e 更为冗余\u003c/li\u003e\u003c/ul\u003e\u003cul class=\"notion-list notion-list-disc notion-block-5d20efd05c664ced8175b0b0ac5ae291\"\u003e\u003cli\u003e对于返回值使用了 \u003ccode class=\"notion-inline-code\"\u003econtext\u003c/code\u003e 的 \u003ccode class=\"notion-inline-code\"\u003eSerializer\u003c/code\u003e 需要通过 \u003ccode class=\"notion-inline-code\"\u003einject.ResponseParams\u003c/code\u003e 类来包装一次，显得不那么纯粹，暂时也没有更好的思路，\u003cs\u003e有空再慢慢改（咕咕🐦）。\u003c/s\u003e\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"notion-blank notion-block-01e6b58440774af28ddef8d0de6a2ca9\"\u003e \u003c/div\u003e\u003c/main\u003e]]\u003e\u003c/content\u003e\n    \u003c/entry\u003e\n\u003c/feed\u003e"},"__N_SSG":true},"page":"/feed","query":{},"buildId":"ZeWQIFPQD6AiJb2I-3PXg","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>